<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>åˆ˜ä¹¦è¯­çš„é­”æ³•æ•°å­¦ç‰¹è®­è¥</title> 
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> 
    <meta name="apple-mobile-web-app-title" content="æ•°å­¦ç‰¹è®­è¥">
    
    <style>
        /* --- é€šç”¨æ ·å¼ (ä¿æŒä¸å˜) --- */
        * { touch-action: manipulation; box-sizing: border-box; }
        :root {
            --color-apple-blue: #007aff; --color-apple-green: #34c759; 
            --color-apple-red: #ff3b30; --color-apple-orange: #ff9500; 
            --color-background-soft: #f2f2f7; --color-card-bg: #f7f7f9;
            --color-text-dark: #1d1d1f; --color-button-secondary: #e5e5ea;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--color-background-soft); color: var(--color-text-dark);
            margin: 0; padding: 0; display: flex; justify-content: center; 
            min-height: 100vh; padding-bottom: 20px; -webkit-text-size-adjust: 100%; 
        }
        .container {
            width: 100%; max-width: 900px; background-color: #ffffff; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); padding: 2vh 4vw; 
            text-align: center; display: flex; flex-direction: column; 
            align-items: center; min-height: 10vh; 
        }
        .header-section { width: 100%; flex-shrink: 0; padding-top: 1vh; display: flex; flex-direction: column; align-items: center; }
        h1 { font-size: clamp(24px, 3.5vw, 32px); font-weight: 700; margin-bottom: 0.5vh; }
        .tagline { font-size: clamp(14px, 2vw, 16px); color: #555; margin-bottom: 1.5vh; }
        .mode-switch-group { width: 90%; max-width: 500px; margin-bottom: 2vh; }
        .mode-select {
            width: 100%; padding: 1.5vh 12px; font-size: clamp(14px, 2.2vw, 16px);
            border-radius: 10px; box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.08); 
            appearance: none; -webkit-appearance: none; -moz-appearance: none; border: 1px solid #ccc;
        }
        .score-board {
            display: flex; justify-content: space-around; margin-top: 1vh; margin-bottom: 2.5vh; 
            padding: 1.5vh 10px; background-color: var(--color-card-bg); border-radius: 12px; 
            width: 80%; max-width: 500px;
        }
        .score-item { font-size: clamp(14px, 2.5vw, 16px); font-weight: 500; }
        .score-item span { color: var(--color-apple-blue); font-weight: 700; }
        .main-calculation-area { 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            width: 100%; padding-top: 2vh; padding-bottom: 2vh; position: relative; 
        }
        .math-problem { 
            font-size: 11vw; font-weight: 800; margin: 1vh 0; min-height: 15vw; 
            display: flex; justify-content: center; align-items: center; gap: 15px;
        }
        .math-problem.three-op { font-size: 8vw; }
        @media (max-width: 600px) {
            .math-problem { font-size: 15vw; gap: 10px; }
            .math-problem.three-op { font-size: 10vw; }
        }
        .input-wrapper { 
            margin-top: 4vh; margin-bottom: 5vh; display: flex; flex-wrap: wrap; 
            justify-content: center; gap: 10px; width: 100%; max-width: 400px; 
        }
        #answerInput { 
            padding: 2vh 15px; font-size: clamp(20px, 3.5vw, 24px); border-radius: 10px; 
            margin-bottom: 10px; width: clamp(150px, 40vw, 200px); transition: all 0.2s; 
            border: 1px solid #ccc; text-align: center;
        }
        .wrong-flash {
            border: 2px solid var(--color-apple-red) !important;
            box-shadow: 0 0 10px rgba(255, 59, 48, 0.5); animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        #newProblemButton {
            padding: 2vh 4vw; font-size: clamp(14px, 2.5vw, 16px); font-weight: 600; 
            background-color: var(--color-button-secondary); color: var(--color-text-dark);
            border-radius: 10px; border: none; cursor: pointer; transition: opacity 0.2s, background-color 0.2s; flex-shrink: 0; 
        }
        @media (min-width: 601px) {
             #newProblemButton.icon-mode {
                 position: absolute; top: 50%; right: 5%; transform: translateY(-50%);
                 padding: 10px; font-size: 20px; border-radius: 50%; width: 40px; height: 40px;
                 display: flex; align-items: center; justify-content: center;
                 box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); opacity: 0.8; z-index: 10;
             }
             #newProblemButton .button-text { display: none; }
        }
        #submitButton, #hintButton { 
            padding: 2vh 4vw; font-size: clamp(14px, 2.5vw, 16px); font-weight: 600; 
            border-radius: 10px; border: none; cursor: pointer; 
            transition: opacity 0.2s, background-color 0.2s; flex-shrink: 0; 
        }
        #submitButton { background-color: var(--color-apple-blue); color: white; }
        #hintButton { background-color: var(--color-apple-orange); color: var(--color-text-dark); }
        
        #hintButton:disabled, #newProblemButton:disabled, #submitButton:disabled {
            opacity: 0.5; cursor: not-allowed;
        }

        @media (max-width: 600px) {
            .input-wrapper { flex-direction: column; align-items: center; padding: 0 5%; max-width: 100%; }
            #answerInput { width: 100%; max-width: 250px; }
            #submitButton, #hintButton, #newProblemButton { 
                width: 100%; max-width: 250px; margin-bottom: 5px; position: static; transform: none; padding: 2vh 4vw; 
            }
            #newProblemButton .button-text { display: inline-block; }
        }
        #feedback { font-size: clamp(18px, 3vw, 22px); font-weight: 700; color: var(--color-text-dark); min-height: 4vh; }
        .feedback-correct { color: var(--color-apple-green); }
        .feedback-wrong { color: var(--color-apple-red); }
        .vfx-container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 1px; height: 1px; pointer-events: none; overflow: visible; z-index: 50; 
        }
        .correct-vfx {
            position: absolute; font-size: 20px; color: gold; text-shadow: 0 0 5px orange;
            animation: flyout 1s ease-out forwards; opacity: 0;
        }
        @keyframes flyout {
            0% { opacity: 1; transform: translate(0, 0) scale(1); }
            25% { opacity: 1; }
            100% { opacity: 0; transform: translate(var(--dx), var(--dy)) scale(0.5); }
        }
        
        /* --- æ¨¡æ€æ¡†é€šç”¨æ ·å¼ --- */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); overflow: auto;
        }
        #hintModal { z-index: 1050; } 
        
        /* æ¨¡æ€æ¡†å†…å®¹æ ·å¼ */
        #examModal .modal-content, #hintModal .modal-content {
            background-color: #ffffff; margin: 5vh auto; padding: 3vh 4vw; border-radius: 20px; 
            width: 95%; max-width: 700px; box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2); 
            animation: modalopen 0.4s ease-out; text-align: left; 
            max-height: 90vh; overflow-y: auto; -webkit-overflow-scrolling: touch;
        }
        
        .modal-title { font-size: clamp(20px, 4vw, 26px); font-weight: 700; color: var(--color-text-dark); margin-bottom: 2vh; border-bottom: 2px solid #ddd; padding-bottom: 1vh; }
        .modal-close { float: right; font-size: clamp(24px, 5vw, 32px); font-weight: 300; cursor: pointer; color: #888; transition: color 0.2s; }
        
        /* --- å¯è§†åŒ–è¾…åŠ©ç”»å›¾æ ·å¼ (10æ ¼é˜µ) --- */
        .visual-container {
            margin: 15px 0;
            padding: 15px;
            background-color: #fcfcfc;
            border: 2px dashed #ddd;
            border-radius: 12px;
            display: grid; /* ä½¿ç”¨ Grid å¸ƒå±€ */
            grid-template-columns: repeat(10, 1fr); /* å¼ºåˆ¶ä¸€è¡Œ10ä¸ª */
            gap: 8px;
            justify-items: center; /* æ°´å¹³å±…ä¸­ */
            align-items: center; /* å‚ç›´å±…ä¸­ */
            max-width: 100%;
        }
        
        /* æ¯ä¸ªå°ç‰©å“çš„æ ·å¼ */
        .visual-item {
            width: 32px; height: 32px;
            font-size: 20px;
            display: flex; align-items: center; justify-content: center;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #eee;
            transition: all 0.3s;
        }
        
        /* æ‰‹æœºç«¯é€‚é…ï¼šç¼©å°å›¾æ ‡ */
        @media (max-width: 500px) {
            .visual-container { gap: 4px; padding: 10px 5px; }
            .visual-item { width: 24px; height: 24px; font-size: 14px; }
        }

        /* å‡æ³•è¢«å‡æ‰çš„æ ·å¼ */
        .is-subtracted {
            opacity: 0.25;
            filter: grayscale(100%);
            transform: scale(0.8);
            text-decoration: line-through;
            background-color: #f5f5f5;
        }
        
        .visual-legend {
            grid-column: 1 / -1; /* å æ»¡æ•´è¡Œ */
            font-size: 14px; color: #555; text-align: center; margin-top: 10px; font-weight: 600;
            border-top: 1px solid #eee;
            padding-top: 8px;
            width: 100%;
        }

        /* --- æç¤ºæ­¥éª¤æ ·å¼ --- */
        .modal-step {
            margin-bottom: 2vh; 
            font-size: clamp(15px, 2.5vw, 18px); 
            line-height: 1.6;
            padding-left: 10px; 
            border-left: 4px solid var(--color-apple-blue); 
            transition: opacity 0.4s ease-out, transform 0.4s ease-out; 
        }
        .modal-step strong { display: block; margin-bottom: 0.5vh; font-weight: 800; } 
        .modal-step.fade-start { opacity: 0; transform: translateY(10px); }
        .modal-step.fade-end { opacity: 1; transform: translateY(0); }
        
        /* å¼ºè°ƒè‰²å®šä¹‰ */
        .highlight-ten { color: var(--color-apple-orange); font-weight: 700; } 
        .highlight-goal { color: var(--color-apple-green); font-weight: 700; } 
        .highlight-remain { color: var(--color-apple-blue); font-weight: 700; } 
        
        /* å…¬å¼æ ·å¼ä¼˜åŒ– */
        .formula { 
            font-size: clamp(18px, 3.5vw, 24px); font-weight: 800; color: var(--color-text-dark); 
            display: block; margin-top: 2vh; margin-bottom: 2vh; text-align: center; 
            background-color: var(--color-card-bg); padding: 1.5vh; border-radius: 10px; 
            letter-spacing: 1px; box-shadow: 0 0 3px rgba(0, 0, 0, 0.05);
        }
        .formula .op-red { color: var(--color-apple-red); }
        .formula .num-red { color: var(--color-apple-red); }

        @keyframes modalopen {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* --- æˆç»©å•æ ·å¼ --- */
        #examReportContent {
            padding-bottom: 20px; position: relative; 
            background-color: #fff; border-radius: 15px; border: 2px solid #ccc;
        }
        .exam-report-inner { padding: 20px; }
        .report-header { 
            text-align: center; margin-bottom: 20px; max-width: 90%; margin-left: auto; margin-right: auto;
        }
        .report-header h3 { 
            font-size: 26px; font-weight: 800; color: var(--color-text-dark); margin: 0; 
            border-bottom: 3px double #333; padding-bottom: 5px; white-space: nowrap; 
        }
        .info-row { 
            display: flex; justify-content: space-around; font-size: 16px; 
            margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px dashed #ddd; width: 100%; 
        }
        .info-item { flex: 1; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .info-item span { font-weight: 700; color: var(--color-apple-blue); }
        .score-box {
            position: absolute; top: 10px; right: 20px; 
            width: 80px; height: 80px; border: 2px solid var(--color-apple-red);
            border-radius: 5px; display: flex; align-items: center; justify-content: center;
            font-size: 36px; font-weight: 800; color: var(--color-apple-red); line-height: 1;
        }
        .problem-list { margin-top: 10px; list-style: none; padding: 0; }
        .problem-item { 
            display: grid; grid-template-columns: 2fr 1fr 1fr 50px; align-items: center; 
            padding: 8px 0; border-bottom: 1px dotted #eee; font-size: 18px; gap: 5px;
        }
        .problem-text { font-weight: 500; color: var(--color-text-dark); text-align: left; }
        .user-answer-display { font-weight: 700; text-align: center; font-size: 16px; }
        .correct-answer-display { color: var(--color-apple-blue); font-weight: 700; font-size: 14px; text-align: center; }
        .problem-mark-group { display: flex; align-items: center; justify-content: flex-end; gap: 5px; }
        .btn-hint-review {
            background-color: var(--color-apple-orange); color: white; border: none; border-radius: 50%;
            width: 25px; height: 25px; font-size: 14px; line-height: 25px; padding: 0;
            cursor: pointer; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2); flex-shrink: 0;
        }
        .problem-mark { font-size: 30px; font-weight: 900; font-family: Arial, sans-serif; line-height: 1; flex-shrink: 0; }
        .mark-wrong { color: #ff3b30; } 
        .report-actions { display: flex; justify-content: center; gap: 10px; margin-top: 30px; flex-wrap: wrap; }
        .report-actions button {
            padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;
            font-size: 16px; font-weight: 600; transition: background-color 0.2s;
        }
        .btn-primary { background-color: var(--color-apple-blue); color: white; }
        .btn-secondary { background-color: var(--color-apple-orange); color: white; }
        .btn-download { background-color: var(--color-apple-green); color: white; }
        .hide-for-capture { display: none; }

    </style>
</head>
<body>
    <div class="container">
        <div class="header-section">
            <h1>ğŸ¥³ åˆ˜ä¹¦è¯­çš„é­”æ³•æ•°å­¦ç‰¹è®­è¥</h1>
            <p class="tagline">ğŸ¥‡ æˆä¸ºå…¨ç­æ•°å­¦å°å† å†›ï¼ (ä¸€å¹´çº§æ–¹æ³•ä¸“é¡¹ç»ƒä¹ )</p>
            <div class="mode-switch-group">
                <div class="select-wrapper">
                    <select id="modeSelect" class="mode-select">
                        <optgroup label="åŸºç¡€è¿ç®—æ¨¡å¼">
                            <option value="add">åŸºç¡€åŠ æ³•</option>
                            <option value="sub">åŸºç¡€å‡æ³•</option>
                            <option value="mixed">æ··åˆç»ƒä¹ </option>
                            <option value="continuous">ğŸ”¥ è¿ç»­è¿ç®—</option>
                        </optgroup>
                        <optgroup label="ä¸“é¡¹æ–¹æ³•ç»ƒä¹ ">
                            <option value="noCarryAdd">ğŸ¯ åŒä½ç›¸åŠ æ³• (ä¸è¿›ä½)</option>
                            <option value="noBreakSub">ğŸ¯ åŒä½ç›¸å‡æ³• (ä¸ç ´å)</option>
                            <option value="couShi">ğŸ¯ å‡‘åæ³•</option>
                            <option value="jieShi" selected>ğŸ¯ å€Ÿåæ³•</option>
                            <option value="pingShi">ğŸ¯ å¹³åæ³•</option>
                        </optgroup>
                        <optgroup label="è€ƒè¯•ä¸æŒ‘æˆ˜">
                            <option value="exam">ğŸ’¯ 10é¢˜å¿«é€Ÿè€ƒè¯•</option>
                        </optgroup>
                    </select>
                </div>
            </div>
            <div class="score-board">
                <div class="score-item">æ­£ç¡®: <span id="correctCount">0</span></div>
                <div class="score-item">é”™è¯¯: <span id="wrongCount">0</span></div>
                <div class="score-item">æ€»æ•°: <span id="totalCount">0</span></div>
            </div>
        </div>
        <div class="main-calculation-area">
            <div class="math-problem" id="mathProblemDisplay">
                <span id="number1"></span><span id="operator1" class="operator"></span>
                <span id="number2"></span><span id="operator2"></span> 
                <span id="number3"></span><span id="equalsSign"></span><span id="resultDisplay"></span>
            </div>
            <div id="vfxContainer" class="vfx-container"></div>
            <button id="newProblemButton">ğŸ”„ <span class="button-text">æ¢é¢˜</span></button>
            <div class="input-wrapper">
                <input type="number" id="answerInput" placeholder="è¯·è¾“å…¥ç­”æ¡ˆ" inputmode="numeric">
                <button id="submitButton">æäº¤</button>
                <button id="hintButton">ğŸ’¡ æç¤º</button>
            </div>
        </div>
        <div id="feedback"></div>
    </div>
    
    <div id="examModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" id="examModalClose">&times;</span>
            <div id="examModalTitle" class="modal-title"></div>
            <div id="examReportContent"></div>
        </div>
    </div>

    <div id="hintModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" id="hintModalClose">&times;</span>
            <div id="hintModalTitle" class="modal-title"></div>
            <div id="hintVisuals"></div> <div id="hintModalSteps"></div>
        </div>
    </div>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script>
        // --- å˜é‡å’ŒçŠ¶æ€åˆå§‹åŒ– ---
        let currentProblem = { num1: 0, num2: 0, operator1: '+', num3: null, operator2: null, answer: 0, steps: [], unknownPosition: 'res', specificMode: null }; 
        let correctCount = 0, wrongCount = 0, totalCount = 0, maxNum = 30; 
        let isExamMode = false; const EXAM_TOTAL_QUESTIONS = 10;
        let examCurrentQuestion = 0, examCorrectAnswers = 0; 
        let examProblems = []; 
        let isSubmitting = false; 
        const MAX_GENERATION_ATTEMPTS = 50; 
        let currentMode = 'jieShi'; 

        // --- å…ƒç´  ID æŸ¥æ‰¾ ---
        function getElementByIdSafe(id) {
            const el = document.getElementById(id);
            if (!el) {
                console.error(`DOM Error: Element with ID "${id}" not found.`);
                return { textContent: '', classList: { add: () => {}, remove: () => {} }, style: {}, innerHTML: '' };
            }
            return el;
        }

        const [n1El, op1El, n2El, op2El, n3El, ansInput, submitBtn, hintBtn, newProbBtn, feedbackEl, cCntEl, wCntEl, tCntEl, modeSelect, vfxCont, mathProbDispEl, examModal, hintModal, equalsSignEl, resultDisplayEl] = 
            ['number1', 'operator1', 'number2', 'operator2', 'number3', 'answerInput', 'submitButton', 'hintButton', 'newProblemButton', 'feedback', 'correctCount', 'wrongCount', 'totalCount', 'modeSelect', 'vfxContainer', 'mathProblemDisplay', 'examModal', 'hintModal', 'equalsSign', 'resultDisplay'].map(id => getElementByIdSafe(id));
        
        const [examModalClose, hintModalClose, examModalTitle, hintModalTitle, hintModalSteps, hintVisuals] =
            ['examModalClose', 'hintModalClose', 'examModalTitle', 'hintModalTitle', 'hintModalSteps', 'hintVisuals'].map(id => getElementByIdSafe(id));
        
        const examReportContent = getElementByIdSafe('examReportContent'); 

        // --- è¾…åŠ©å‡½æ•° ---
        function vfx() {
            vfxCont.innerHTML = ''; 
            for (let i = 0; i < 15; i++) {
                const v = document.createElement('div');
                v.className = 'correct-vfx'; v.textContent = 'â­'; 
                const angle = Math.random() * 2 * Math.PI;
                const distance = 80 + Math.random() * 50; 
                v.style.setProperty('--dx', `${Math.cos(angle) * distance}px`);
                v.style.setProperty('--dy', `${Math.sin(angle) * distance}px`);
                v.style.transform = `translate(${(Math.random() - 0.5) * 20}px, ${(Math.random() - 0.5) * 20}px)`;
                vfxCont.appendChild(v);
                v.addEventListener('animationend', () => v.remove());
            }
        }
        function wrongFlash() {
            ansInput.classList.add('wrong-flash');
            setTimeout(() => ansInput.classList.remove('wrong-flash'), 500);
        }
        
        const numSpan = (num, className) => `<span class="${className}">${num}</span>`;
        const opRedSpan = (op) => `<span class="op-red">${op}</span>`;
        const numRedSpan = (num) => `<span class="num-red">${num}</span>`;
        const parenRedSpan = (op) => `<span class="op-red">${op}</span>`;
        const stepContent = (title, content) => `<strong>${title}</strong>${content}`; 

        // --- å¯è§†åŒ–ç”»å›¾å‡½æ•° (æ–°å¢) ---
        function renderVisualHelpers(container, n1, n2, op) {
            container.innerHTML = ''; // æ¸…ç©ºæ—§å›¾
            if (n1 > 30) return; // æ•°å­—å¤ªå¤§ä¸ç”»å›¾ï¼Œé¿å…æ‹¥æŒ¤

            const wrapper = document.createElement('div');
            wrapper.className = 'visual-container';
            
            // è‡ªåŠ¨æ·»åŠ æ ¼å­
            const addItem = (type, isSubtracted = false) => {
                const item = document.createElement('div');
                item.className = 'visual-item';
                item.textContent = type === 'A' ? 'ğŸ' : 'ğŸ';
                if (isSubtracted) item.classList.add('is-subtracted');
                return item;
            };

            if (op === '+') {
                // åŠ æ³•ï¼šç”» n1 ä¸ªçº¢è‹¹æœï¼Œn2 ä¸ªç»¿è‹¹æœ
                const total = n1 + n2;
                for (let i = 0; i < total; i++) {
                    // å‰ n1 ä¸ªæ˜¯çº¢è‹¹æœï¼Œåé¢æ˜¯ç»¿è‹¹æœ
                    wrapper.appendChild(addItem(i < n1 ? 'A' : 'B'));
                }
                 // æ·»åŠ å›¾ä¾‹è¯´æ˜
                 const legend = document.createElement('div');
                legend.className = 'visual-legend';
                legend.textContent = `ğŸ ${n1} ä¸ª + ğŸ ${n2} ä¸ª = ${total} ä¸ª`;
                wrapper.appendChild(legend);

            } else {
                // å‡æ³•ï¼šç”» n1 ä¸ªçº¢è‹¹æœï¼ŒæŠŠæœ€å n2 ä¸ªå˜ç°
                for (let i = 0; i < n1; i++) {
                    // åˆ¤æ–­æ˜¯å¦æ˜¯è¢«å‡å»çš„éƒ¨åˆ† (æœ€å n2 ä¸ª)
                    const isSubtracted = i >= (n1 - n2); 
                    wrapper.appendChild(addItem('A', isSubtracted));
                }
                // æ·»åŠ å›¾ä¾‹è¯´æ˜
                const legend = document.createElement('div');
                legend.className = 'visual-legend';
                legend.textContent = `å…±æœ‰ ${n1} ä¸ª ğŸï¼Œæ‹¿èµ° ${n2} ä¸ªï¼Œè¿˜å‰© ${n1-n2} ä¸ª`;
                wrapper.appendChild(legend);
            }

            container.appendChild(wrapper);
        }


        function switchMode(newMode) {
            currentMode = newMode; 
            isExamMode = newMode === 'exam';
            
            // é‡ç½®è®¡æ•°å™¨
            if (isExamMode) {
                examCurrentQuestion = 0; examCorrectAnswers = 0; examProblems = []; 
                correctCount = 0; wrongCount = 0;
            } else if (modeSelect.value === 'exam') {
                correctCount = 0; wrongCount = 0; totalCount = 0;
            }

            modeSelect.value = newMode; 
            cCntEl.textContent = correctCount; wCntEl.textContent = wrongCount; tCntEl.textContent = totalCount;
            newProbBtn.disabled = isExamMode; 
            hintBtn.disabled = isExamMode; 
            submitBtn.disabled = false;
            generateProblem(true);
            examModal.style.display = 'none';
        }

        // --- æç¤ºæ­¥éª¤é€»è¾‘ (ä¿æŒä¹‹å‰æ‰€æœ‰çš„ä¿®å¤) ---
        function getSingleOpHintSteps(n1, n2, op, forcedMode = null) {
            let s = '', t = '';
            const effectiveMode = (forcedMode || (['add', 'sub', 'mixed', 'continuous'].includes(currentMode) ? null : currentMode));
            const res = op === '+' ? n1 + n2 : n1 - n2; 
            const [n1Red, n2Red, resRed] = [numRedSpan(n1), numRedSpan(n2), numRedSpan(res)];
            const tSpan = numSpan(10, 'highlight-goal'); 
            const u1 = n1 % 10; 
            
            t = 'åŸºç¡€åŠ å‡æ³• (ç›´æ¥è®¡ç®—)'; 
            s = `<div class="modal-step">${stepContent('ç›´æ¥è®¡ç®—', `ï¼š${numSpan(n1, 'highlight-remain')} ${opRedSpan(op)} ${numSpan(n2, 'highlight-remain')} ${opRedSpan('=')} ${numSpan(res, 'highlight-goal')} å°±å¯ä»¥å•¦ï¼`)}</div>`;
            let formulaHTML = `<span class="formula">${n1Red} ${opRedSpan(op)} ${n2Red} ${opRedSpan('=')} ${resRed}</span>`;
            let calculationDetails = { title: t, stepsHTML: s, formula: formulaHTML };

            // **2. æ±‚è§£æœªçŸ¥æ•°é€»è¾‘ (A op ? = C) **
            if (currentProblem.unknownPosition === 'n2' && !forcedMode) {
                const n1Known = currentProblem.num1;
                const n2Answer = currentProblem.answer; 
                const knownResult = n1Known + (op === '+' ? n2Answer : -n2Answer); 
                const knownResSpan = numRedSpan(knownResult);
                
                let subN1, subN2, conversionText;

                if (op === '-') {
                    subN1 = n1Known; subN2 = knownResult; 
                    t = 'ğŸ§® æ±‚è§£æœªçŸ¥å‡æ•° (? = A - C)';
                    conversionText = `ï¼šğŸ” ${numRedSpan(n1Known)} å‡å»æœªçŸ¥æ•° (?) ç­‰äº ${knownResSpan}ï¼Œæ‰€ä»¥æœªçŸ¥æ•° (?) ç­‰äº ${numRedSpan(n1Known)} å‡å» ${knownResSpan}ã€‚`;
                } else if (op === '+') {
                    subN1 = knownResult; subN2 = n1Known; 
                    t = 'ğŸ§® æ±‚è§£æœªçŸ¥åŠ æ•° (? = C - A)';
                    conversionText = `ï¼šğŸ” ${numRedSpan(n1Known)} åŠ ä¸ŠæœªçŸ¥æ•° (?) ç­‰äº ${knownResSpan}ï¼Œæ‰€ä»¥æœªçŸ¥æ•° (?) ç­‰äº ${knownResSpan} å‡å» ${numRedSpan(n1Known)}ã€‚`;
                }

                s = `<div class="modal-step">${stepContent('æ­¥éª¤ 1: å…³ç³»è½¬æ¢', conversionText.replace(/ï¼šğŸ”/, ''))}</div>`;

                // --- è®¡ç®—æ­¥éª¤ ---
                const uSubN1 = subN1 % 10;
                const uSubN2 = subN2 % 10;
                const isBreakTen = subN1 > 10 && uSubN2 > uSubN1;
                const isTensSub = subN1 % 10 === 0 && subN2 > 0; 
                const isNoBreakSub = subN1 > 10 && uSubN2 <= uSubN1;
                const isSimpleSub = subN1 <= 10 || (subN1 > 10 && subN2 <= uSubN1 && subN2 <= 10) || (subN1 > 10 && (subN2 === 10 || subN2 === 20));

                let calculationTitle = 'åŸºç¡€å‡æ³•';
                let preferredSubMode = null; 

                if (isSimpleSub) {
                     calculationDetails = { 
                        stepsHTML: `<div class="modal-step">${stepContent('æ­¥éª¤ 2: ç›´æ¥è®¡ç®—', `ï¼šå…³ç³»è½¬æ¢åæ˜¯ ${numRedSpan(subN1)} ${opRedSpan('-')} ${numRedSpan(subN2)}ï¼Œç›´æ¥è®¡ç®—å¾— ${numRedSpan(n2Answer)}ã€‚`)}</div>`,
                        formula: `<span class="formula">${numRedSpan(subN1)} ${opRedSpan('-')} ${numRedSpan(subN2)} ${opRedSpan('=')} ${numRedSpan(n2Answer)}</span>`,
                        title: 'åŸºç¡€å‡æ³•',
                    };
                } else if (isTensSub) preferredSubMode = 'tensSub'; 
                else if (isNoBreakSub) preferredSubMode = 'noBreakSub';
                else if (isBreakTen && subN1 <= 20) preferredSubMode = 'jieShi'; 
                else if (isBreakTen) preferredSubMode = 'pingShi'; 
                
                if (preferredSubMode) {
                    calculationDetails = getSingleOpHintSteps(subN1, subN2, '-', preferredSubMode); 
                    calculationTitle = calculationDetails.title.replace(/[\u2728\u2559\u26a1\u25b6\u2796]/g, '').trim();
                    calculationDetails.stepsHTML = calculationDetails.stepsHTML.replace(/<span class="formula">.*?<\/span>/s, ''); 
                } else if (!isSimpleSub) {
                     calculationDetails = { 
                        stepsHTML: `<div class="modal-step">${stepContent('æ­¥éª¤ 2: ç›´æ¥è®¡ç®—', `ï¼šç”¨å‡æ³•å…³ç³» ${numRedSpan(subN1)} ${opRedSpan('-')} ${numRedSpan(subN2)} ${opRedSpan('=')} ${numRedSpan(n2Answer)} æ¥æ±‚è§£ã€‚`)}</div>`,
                        formula: `<span class="formula">${numRedSpan(subN1)} ${opRedSpan('-')} ${numRedSpan(subN2)} ${opRedSpan('=')} ${numRedSpan(n2Answer)}</span>`,
                        title: 'åŸºç¡€å‡æ³•',
                    };
                }

                s += calculationDetails.stepsHTML; 
                t += ` (è®¡ç®—ä½¿ç”¨ï¼š${calculationTitle})`; 
                
                // æ·»åŠ ç”»å›¾é€»è¾‘ (è½¬æ¢åçš„å‡æ³•)
                renderVisualHelpers(hintVisuals, subN1, subN2, '-');

                const conversionFormula = `<span class="formula" style="font-size: clamp(16px, 3vw, 20px); margin-top: 0; margin-bottom: 0.5vh; color: var(--color-apple-orange);">${numRedSpan(n1Known)} ${opRedSpan(op)} ? ${opRedSpan('=')} ${knownResult} ${opRedSpan('â†’')} ? ${opRedSpan('=')} ${numRedSpan(subN1)} ${opRedSpan('-')} ${numRedSpan(subN2)}</span>`;
                
                let calculationFormula = calculationDetails.formula; 
                if (calculationDetails.title.includes('åŸºç¡€å‡æ³•')) {
                    calculationFormula = `<span class="formula">${numRedSpan(subN1)} ${opRedSpan('-')} ${numRedSpan(subN2)} ${opRedSpan('=')} ${numRedSpan(n2Answer)}</span>`;
                } else if (calculationDetails.formula.includes('=') && !calculationDetails.formula.includes('â†’')) {
                    calculationFormula = calculationFormula.replace(/<span class="formula">/g, '<span class="formula" style="margin-top: 0;">');
                } else {
                    calculationFormula = `<span class="formula" style="margin-top: 0;">${numRedSpan(subN1)} ${opRedSpan('-')} ${numRedSpan(subN2)} ${opRedSpan('=')} ${numRedSpan(n2Answer)}</span>`;
                }

                formulaHTML = conversionFormula + calculationFormula; 
                return { title: t, stepsHTML: s, formula: formulaHTML }; 
            }
            
            // **3. æ ‡å‡†è¿ç®—é€»è¾‘ (A op B = ?) **
            
            // åœ¨è¿™é‡Œè°ƒç”¨ç”»å›¾é€»è¾‘ (æ­£å¸¸ç®—å¼)
            if (!forcedMode) { 
                renderVisualHelpers(hintVisuals, n1, n2, op);
            }

            if (op === '+') {
                const u2 = n2 % 10;
                const uSum = u1 + u2; 
                const isNoCarryAdd = uSum <= 9; 
                const isCouShi = uSum > 10; 

                if (effectiveMode === 'noCarryAdd' || (!effectiveMode && isNoCarryAdd)) {
                    const t1 = Math.floor(n1 / 10), t2 = Math.floor(n2 / 10); 
                    const [t1Span, t2Span] = [numSpan(t1, 'highlight-remain'), numSpan(t2, 'highlight-remain')];
                    const [u1Span, u2Span] = [numSpan(u1, 'highlight-ten'), numSpan(u2, 'highlight-ten')];
                    const tRes = t1 + t2; 
                    
                    t = 'â• åŒä½ç›¸åŠ æ³• (ä¸è¿›ä½)';
                    s = `<div class="modal-step">${stepContent('æ­¥éª¤ 1: ä¸ªä½åŠ ä¸ªä½', `ï¼šğŸ’ª ä¸ªä½ä¸Šçš„ ${u1Span} åŠ ä¸Š ${u2Span}ï¼Œå¾—åˆ° ${numSpan(uSum, 'highlight-goal')}ã€‚`)}</div>`;
                    if (t1 > 0 || t2 > 0) { 
                        s += `<div class="modal-step">${stepContent('æ­¥éª¤ 2: åä½åŠ åä½', `ï¼šğŸ§  åä½ä¸Šçš„ ${t1Span} åŠ ä¸Š ${t2Span}ï¼Œå¾—åˆ° ${numSpan(tRes, 'highlight-goal')}ã€‚`)}</div>`;
                    }
                    formulaHTML = `<span class="formula">${n1Red} ${opRedSpan(op)} ${n2Red} ${opRedSpan('=')} ${resRed}</span>`;

                } else if (effectiveMode === 'couShi' || (!effectiveMode && isCouShi && n1 <= 20 && n2 <= 10)) {
                    const big = Math.max(n1, n2); const small = Math.min(n1, n2);
                    const bigUnit = big % 10, need = 10 - bigUnit, rem = small - need;
                    if (rem > 0 || effectiveMode === 'couShi') {
                        const [needSpan, remSpan] = [numSpan(need, 'highlight-ten'), numSpan(rem, 'highlight-remain')];
                        const [bigSpan, smallSpan] = [numSpan(big, 'highlight-goal'), numSpan(small, 'highlight-ten')];
                        const nextTen = big + need, nextTenSpan = numSpan(nextTen, 'highlight-goal');
                        t = 'âœ¨ å‡‘åæ³•é­”æ³•æ‹†åˆ†';
                        s = `<div class="modal-step">${stepContent('æ­¥éª¤ 1: æ‰¾æœ‹å‹å‡‘ 10', `ï¼šğŸ™‹ å¤§æ•° ${bigSpan} çš„ä¸ªä½ (${numSpan(bigUnit,'highlight-goal')}) éœ€è¦æ‰¾ ${need} æ‰èƒ½å‡‘åˆ°ä¸‹ä¸€ä¸ªæ•´åæ•° ${nextTenSpan}ã€‚`)}</div>`;
                        s += `<div class="modal-step">${stepContent('æ­¥éª¤ 2: å°æ•°æ‹†åˆ†', `ï¼šâœ‚ï¸ å°æ•° ${smallSpan} æ„¿æ„æŠŠè‡ªå·±æ‹†æˆ ${needSpan} (ç»™æœ‹å‹) å’Œ ${remSpan} (å‰©ä¸‹çš„)ã€‚`)}</div>`;
                        s += `<div class="modal-step">${stepContent('æ­¥éª¤ 3: é­”æ³•åˆä½“', `ï¼šğŸš€ å…ˆè®© ${nextTenSpan} å˜å‡ºæ¥ï¼Œå†æŠŠå‰©ä¸‹çš„ ${remSpan} åŠ ä¸Šå»ï¼`)}</div>`;
                        formulaHTML = `<span class="formula">${n1Red} ${opRedSpan(op)} ${n2Red} ${opRedSpan('=')} ${parenRedSpan('(')} ${bigSpan} ${opRedSpan('+')} ${needSpan} ${parenRedSpan(')')} ${opRedSpan('+')} ${remSpan} ${opRedSpan('=')} ${nextTenSpan} ${opRedSpan('+')} ${remSpan} ${opRedSpan('=')} ${resRed}</span>`;
                    } else {
                         t = 'åŸºç¡€åŠ æ³• (ç›´æ¥è®¡ç®—)'; 
                         s = `<div class="modal-step">${stepContent('ç›´æ¥è®¡ç®—', `ï¼šç›´æ¥å°† ${numSpan(n1, 'highlight-remain')} ${opRedSpan(op)} ${numSpan(n2, 'highlight-remain')} ç›¸åŠ ï¼Œå¾—åˆ° ${numSpan(res, 'highlight-goal')}ã€‚`)}</div>`;
                         formulaHTML = `<span class="formula">${n1Red} ${opRedSpan(op)} ${n2Red} ${opRedSpan('=')} ${resRed}</span>`;
                    }
                
                } else {
                     t = 'åŸºç¡€åŠ æ³• (ç›´æ¥è®¡ç®—)'; 
                     s = `<div class="modal-step">${stepContent('ç›´æ¥è®¡ç®—', `ï¼šç›´æ¥å°† ${numSpan(n1, 'highlight-remain')} ${opRedSpan(op)} ${numSpan(n2, 'highlight-remain')} ç›¸åŠ ï¼Œå¾—åˆ° ${numSpan(res, 'highlight-goal')}ã€‚`)}</div>`;
                     formulaHTML = `<span class="formula">${n1Red} ${opRedSpan(op)} ${n2Red} ${opRedSpan('=')} ${resRed}</span>`;
                }
            } else if (op === '-') { 
                const u2 = n2 % 10;
                const isBreakTen = n1 > 10 && u2 > u1; 
                const isTensSub = n1 % 10 === 0 && n2 > 0; 
                const isNoBreakSub = n1 > 10 && u2 <= u1; 
                const isSimpleTenSub = n1 > 10 && n1 < 30 && (n2 === 10 || n2 === 20) && n1 >= n2;

                let isCustomMethod = false; 

                if (isSimpleTenSub || (!isBreakTen && !isNoBreakSub && !isTensSub)) {
                     // åŸºç¡€è®¡ç®— (å¦‚ 19-10)
                     t = 'åŸºç¡€å‡æ³• (åŒä½ç›¸å‡)';
                     s = `<div class="modal-step">${stepContent('ç›´æ¥è®¡ç®— (åŒä½ç›¸å‡)', `ï¼šä¸ªä½ ${numSpan(u1, 'highlight-remain')} å‡å» ${numSpan(u2, 'highlight-remain')}ï¼Œåä½ ${numSpan(Math.floor(n1/10), 'highlight-remain')} å‡å» ${numSpan(Math.floor(n2/10), 'highlight-remain')}ã€‚`)}</div>`;
                     formulaHTML = `<span class="formula">${n1Red} ${opRedSpan(op)} ${n2Red} ${opRedSpan('=')} ${resRed}</span>`;

                } else if (effectiveMode === 'noBreakSub' || (!effectiveMode && isNoBreakSub)) {
                    // 1. åŒä½ç›¸å‡æ³• (ä¸ç ´å) 
                    const t1 = Math.floor(n1 / 10), t2 = Math.floor(n2 / 10); 
                    const [t1Span, t2Span] = [numSpan(t1, 'highlight-remain'), numSpan(t2, 'highlight-remain')];
                    const [u1Span, u2Span] = [numSpan(u1, 'highlight-ten'), numSpan(u2, 'highlight-ten')];
                    const tRes = t1 - t2; const uRes = u1 - u2; 

                    t = 'âœ… åŒä½ç›¸å‡æ³• (ä¸ç ´å)';
                    s = `<div class="modal-step">${stepContent('æ­¥éª¤ 1: ä¸ªä½å‡ä¸ªä½', `ï¼šğŸ’ª ä¸ªä½ä¸Šçš„ ${u1Span} å‡å» ${u2Span}ï¼Œå¾—åˆ° ${numSpan(uRes, 'highlight-goal')}ã€‚`)}</div>`;
                    if (t2 > 0) { 
                        s += `<div class="modal-step">${stepContent('æ­¥éª¤ 2: åä½å‡åä½', `ï¼šğŸ§  åä½ä¸Šçš„ ${t1Span} å‡å» ${t2Span}ï¼Œå¾—åˆ° ${numSpan(tRes, 'highlight-goal')}ã€‚`)}</div>`;
                    } else if (t1 > 0) { 
                        s += `<div class="modal-step">${stepContent('æ­¥éª¤ 2: ä¿ç•™åä½', `ï¼šğŸ§  å‡æ•°æ²¡æœ‰åä½ï¼Œä¿ç•™ ${t1Span} (1ä¸ªå)ã€‚`)}</div>`;
                    }
                    formulaHTML = `<span class="formula">${n1Red} ${opRedSpan(op)} ${n2Red} ${opRedSpan('=')} ${resRed}</span>`;
                    isCustomMethod = true;
                    
                } else if (effectiveMode === 'jieShi' || (!effectiveMode && isBreakTen && n1 <= 20)) {
                    // 2. å€Ÿåæ³• 
                    const tMinusN2 = 10 - n2;
                    t = 'âš¡ å€Ÿåæ³• (ç ´åæ³•)';
                    const [u1Span, tMinusN2Span] = [numSpan(u1, 'highlight-remain'), numSpan(tMinusN2, 'highlight-goal')];
                    s = `<div class="modal-step">${stepContent('æ­¥éª¤ 1: ä¸ªä½æ±‚åŠ©', `ï¼šğŸ˜Ÿ ${n1} çš„ä¸ªä½ (${u1Span}) å¤ªå°äº†ï¼Œå‡ä¸æ‰ ${n2Red}ï¼å€Ÿä¸€ä¸ª ${tSpan} æ¥å¸®å¿™ï¼`)}</div>`;
                    s += `<div class="modal-step">${stepContent('æ­¥éª¤ 2: 10 å‡å»å‡æ•°', `ï¼šğŸ’ª å…ˆè®©å€Ÿæ¥çš„ ${tSpan} æ‰“è´¥ é‚£ä¸ª ${n2Red}ï¼Œå‰©ä¸‹ ${tMinusN2Span} ä¸ªã€‚`)}</div>`;
                    s += `<div class="modal-step">${stepContent('æ­¥éª¤ 3: èƒœåˆ©ä¼šå¸ˆ', `ï¼šğŸ¥³ æŠŠ ${tMinusN2Span} å’Œä¸ªä½ä¸Šä¹–ä¹–ç­‰ç€çš„ ${u1Span} åˆå¹¶èµ·æ¥ï¼`)}</div>`;
                    formulaHTML = `<span class="formula">${n1Red} ${opRedSpan(op)} ${n2Red} ${opRedSpan('=')} ${parenRedSpan('(')} ${numSpan(10, 'highlight-goal')} ${opRedSpan('-')} ${n2Red} ${parenRedSpan(')')} ${opRedSpan('+')} ${u1Span} ${opRedSpan('=')} ${tMinusN2Span} ${opRedSpan('+')} ${u1Span} ${opRedSpan('=')} ${resRed}</span>`;
                    isCustomMethod = true;

                } else if (effectiveMode === 'pingShi' || (!effectiveMode && isBreakTen)) { 
                    // 3. å¹³åæ³•
                    const rem = n2 - u1; 
                    const tenRem = n1 - u1; 
                    t = 'ğŸ“ å¹³åæ³• (è¿å‡æ³•)';
                    const [remSpan, tenRemSpan] = [numSpan(rem, 'highlight-remain'), numSpan(tenRem, 'highlight-goal')];
                    const u1Span = numSpan(u1, 'highlight-ten');
                    s = `<div class="modal-step">${stepContent('æ­¥éª¤ 1: æ‹†åˆ†å‡æ•°', `ï¼šâœ‚ï¸ æŠŠ ${n2Red} æ‹†æˆ ${u1Span} (å’Œ ${n1} çš„ä¸ªä½ç›¸ç­‰) å’Œ ${remSpan} (å‰©ä¸‹çš„)ã€‚`)}</div>`;
                    s += `<div class="modal-step">${stepContent('æ­¥éª¤ 2: å…ˆå‡ä¸ªä½', `ï¼šğŸ’ª ${n1Red} å…ˆå‡å» ${u1Span}ï¼Œå¾—åˆ°æ•´åæ•° ${tenRemSpan}ã€‚`)}</div>`;
                    s += `<div class="modal-step">${stepContent('æ­¥éª¤ 3: å†å‡å‰©ä½™', `ï¼šğŸƒ ç”¨ ${tenRemSpan} å†å‡å»å‰©ä¸‹çš„ ${remSpan}ã€‚`)}</div>`;
                    formulaHTML = `<span class="formula">${n1Red} ${opRedSpan(op)} ${n2Red} ${opRedSpan('=')} ${parenRedSpan('(')} ${n1Red} ${opRedSpan('-')} ${u1Span} ${parenRedSpan(')')} ${opRedSpan('-')} ${remSpan} ${opRedSpan('=')} ${tenRemSpan} ${opRedSpan('-')} ${remSpan} ${opRedSpan('=')} ${resRed}</span>`;
                    isCustomMethod = true;

                } else if (effectiveMode === 'tensSub' || (!effectiveMode && isTensSub)) {
                    // 4. æ•´åæ•°å‡æ³•
                    t = 'ğŸ”¢ æ•´åæ•°å‡æ³• (è¿å‡æ³•æ€è·¯)';
                    const n2Ten = Math.floor(n2 / 10) * 10; 
                    const n2Unit = n2 % 10; 
                    const iR = n1 - n2Ten;
                    const [n2TenSpan, n2UnitSpan, iRSpan] = [numSpan(n2Ten, 'highlight-ten'), numSpan(n2Unit, 'highlight-remain'), numSpan(iR, 'highlight-goal')];
                    s = `<div class="modal-step">${stepContent('æ­¥éª¤ 1: æ‹†åˆ†å‡æ•°', `ï¼šâœ‚ï¸ æŠŠ ${n2Red} æ‹†æˆ ${n2TenSpan} (æ•´åæ•°) å’Œ ${n2UnitSpan} (ä¸ªä½)ã€‚`)}</div>`;
                    s += `<div class="modal-step">${stepContent('æ­¥éª¤ 2: å…ˆå‡æ•´å', `ï¼šğŸ’ª ${n1Red} å…ˆå‡å» ${n2TenSpan}ï¼Œå¾—åˆ° ${iRSpan}ã€‚`)}</div>`;
                    s += `<div class="modal-step">${stepContent('æ­¥éª¤ 3: å†å‡ä¸ªä½', `ï¼šğŸƒ ç”¨ ${iRSpan} å†å‡å»å‰©ä¸‹çš„ ${n2UnitSpan}ï¼Œå¾—åˆ°ç»“æœ ${resRed}ã€‚`)}</div>`;
                    formulaHTML = `<span class="formula">${n1Red} ${opRedSpan(op)} ${n2Red} ${opRedSpan('=')} ${parenRedSpan('(')} ${n1Red} ${opRedSpan('-')} ${n2TenSpan} ${parenRedSpan(')')} ${opRedSpan('-')} ${n2UnitSpan} ${opRedSpan('=')} ${iRSpan} ${opRedSpan('-')} ${n2UnitSpan} ${opRedSpan('=')} ${resRed}</span>`;
                    isCustomMethod = true;
                }

                if (!isCustomMethod && t === '') {
                    t = 'åŸºç¡€å‡æ³• (ç›´æ¥è®¡ç®—)';
                    s = `<div class="modal-step">${stepContent('ç›´æ¥è®¡ç®—', `ï¼šç›´æ¥è®¡ç®— ${numSpan(n1, 'highlight-remain')} ${opRedSpan(op)} ${numSpan(n2, 'highlight-remain')}ï¼Œå¾—åˆ° ${numSpan(res, 'highlight-goal')}ã€‚`)}</div>`;
                    formulaHTML = `<span class="formula">${n1Red} ${opRedSpan(op)} ${n2Red} ${opRedSpan('=')} ${resRed}</span>`;
                }
            }

            return { title: t, stepsHTML: s, formula: formulaHTML }; 
        }

        // --- æ¨¡æ€æ¡†å’ŒæŠ¥å‘Šé€»è¾‘ (ä¿æŒä¸å˜) ---
        function generateHintSteps(problem, problemIndex = null) {
            const { num1, num2, operator1, num3, operator2, answer, unknownPosition, specificMode } = problem;
            let s = '', finalFormula = '';
            hintModal.style.display = 'block';
            hintVisuals.innerHTML = ''; // æ¸…ç©ºæ—§å›¾
            
            if (num3 !== null && num3 !== undefined) {
                const iR = operator1 === '+' ? num1 + num2 : num1 - num2;
                renderVisualHelpers(hintVisuals, num1, num2, operator1);
                const firstStepDetails = getSingleOpHintSteps(num1, num2, operator1, null); 
                hintModalTitle.textContent = `ğŸ’¡ ç¬¬${problemIndex !== null ? problemIndex + 1 : 'å½“å‰'}é¢˜ - è¿ç»­è¿ç®—åˆ†æ­¥è§£æ (ç¬¬ä¸€æ­¥ï¼š${firstStepDetails.title.replace(/[\u2728\u2559\u26a1]/g, '').trim()})`; 
                s += `<div class="modal-step" style="border-left: 4px solid var(--color-apple-orange);">${stepContent('ç¬¬ä¸€æ­¥è®¡ç®—', `ï¼š${num1} ${operator1} ${num2}`)}</div>`; 
                s += firstStepDetails.stepsHTML; 
                s += `<span class="formula">${numRedSpan(num1)} ${opRedSpan(operator1)} ${numRedSpan(num2)} ${opRedSpan('=')} ${numRedSpan(iR)}</span>`;
                const secondStepDetails = getSingleOpHintSteps(iR, num3, operator2, null); 
                s += `<div class="modal-step">${stepContent('ç¬¬äºŒæ­¥è®¡ç®—', `ï¼š${iR} ${operator2} ${num3} (æ–¹æ³•ï¼š${secondStepDetails.title.replace(/[\u2728\u2559\u26a1]/g, '').trim()})`)}</div>`; 
                s += secondStepDetails.stepsHTML; 
                finalFormula = `<span class="formula">${numRedSpan(num1)} ${opRedSpan(operator1)} ${numRedSpan(num2)} ${opRedSpan(operator2)} ${numRedSpan(num3)} ${opRedSpan('=')} ${numRedSpan(answer)}</span>`;
            } else {
                const originalProblem = currentProblem;
                currentProblem = problem;
                const details = getSingleOpHintSteps(num1, num2, operator1, specificMode);
                currentProblem = originalProblem;
                hintModalTitle.textContent = `ğŸ’¡ ${problemIndex !== null ? 'ç¬¬' + (problemIndex + 1) + 'é¢˜ - ' : ''}${details.title}`; 
                s = details.stepsHTML;
                finalFormula = details.formula;
            }
            hintModalSteps.innerHTML = s + finalFormula; 
            const steps = hintModalSteps.querySelectorAll('.modal-step');
            steps.forEach(step => step.classList.add('fade-start')); 
            steps.forEach((step, index) => {
                setTimeout(() => { step.classList.remove('fade-start'); step.classList.add('fade-end'); }, 100 + index * 450);
            });
        }
        
        const closeHintModal = () => { hintModal.style.display = 'none'; };
        const closeExamModal = () => { examModal.style.display = 'none'; switchMode(modeSelect.value); };
        const showCurrentHint = () => {
            if (isExamMode) { feedbackEl.textContent = 'è€ƒè¯•ä¸­ä¸èƒ½ä½¿ç”¨æç¤ºå“¦ï¼'; wrongFlash(); return; }
            generateHintSteps(currentProblem);
        };
        const showProblemHint = (index) => {
            const problemData = examProblems[index];
            currentProblem = problemData; 
            if (problemData) generateHintSteps(problemData, index);
        };
        
        function generateReportImage() {
            const reportEl = getElementByIdSafe('examReportContent');
            if (typeof html2canvas === 'undefined' || !html2canvas) { alert('å›¾ç‰‡ç”Ÿæˆåº“åŠ è½½å¤±è´¥ã€‚'); return; }
            const actionsDiv = reportEl.querySelector('.report-actions');
            actionsDiv.classList.add('hide-for-capture');
            html2canvas(reportEl, { scale: 3, useCORS: true, backgroundColor: '#ffffff', allowTaint: true, removeContainer: true }).then(canvas => {
                actionsDiv.classList.remove('hide-for-capture');
                const imgURL = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                const score = (examCorrectAnswers / EXAM_TOTAL_QUESTIONS) * 100;
                const today = new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, ''); 
                a.download = `æ•°å­¦æµ‹è¯•æˆç»©_${score.toFixed(0)}åˆ†_${today}.png`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            }).catch(error => {
                actionsDiv.classList.remove('hide-for-capture');
                console.error('Error generating image:', error);
                alert('ç”Ÿæˆå›¾ç‰‡å¤±è´¥ã€‚');
            });
        }

        function endExam() {
            submitBtn.disabled = true; 
            isSubmitting = false; 
            const score = (examCorrectAnswers / EXAM_TOTAL_QUESTIONS) * 100;
            const today = new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
            examModalTitle.textContent = 'ğŸ’¯ æ•°å­¦å¿«é€Ÿæµ‹è¯•å·';
            let problemListHTML = examProblems.map((p, index) => {
                const correctAnswerDisplay = (p.answer === undefined || p.answer === null || isNaN(p.answer)) ? '??' : p.answer;
                let problemText = '';
                if (p.unknownPosition === 'res') {
                    problemText = `${index + 1}. ${p.num1} ${p.operator1} ${p.num2}` + (p.num3 !== null && p.num3 !== undefined ? ` ${p.operator2} ${p.num3}` : '');
                } else if (p.unknownPosition === 'n2') {
                    const knownResult = p.num1 + (p.operator1 === '+' ? p.answer : -p.answer); 
                    problemText = `${index + 1}. ${p.num1} ${p.operator1} ? = ${knownResult}`;
                }
                const isCorrect = p.userAnswer === p.answer; 
                const [mark, markClass] = isCorrect ? ['âœ”ï¸', ''] : ['âŒ', 'mark-wrong'];
                const userAnswerDisplay = p.userAnswer === undefined || p.userAnswer === null || isNaN(p.userAnswer) ? '?' : p.userAnswer;
                const userAnswerColor = isCorrect ? 'var(--color-text-dark)' : 'var(--color-apple-red)'; 
                return `
                    <li class="problem-item">
                        <span class="problem-text">${problemText}</span>
                        <span class="user-answer-display" style="color: ${userAnswerColor};">${userAnswerDisplay}</span>
                        <span class="correct-answer-display">${!isCorrect ? `(æ­£: ${correctAnswerDisplay})` : ''}</span>
                        <div class="problem-mark-group">
                            ${!isCorrect ? `<button onclick="showProblemHint(${index});" class="btn-hint-review">ğŸ’¡</button>` : ''} 
                            <span class="problem-mark ${markClass}" style="color: ${isCorrect ? 'var(--color-apple-green)' : 'var(--color-apple-red)'};">${mark}</span>
                        </div>
                    </li>`;
            }).join('');
            examReportContent.innerHTML = `
                <div class="exam-report-inner">
                    <div class="score-box">${score.toFixed(0)}</div>
                    <div class="report-header"><h3>å°å­¦ä¸€å¹´çº§æ•°å­¦æµ‹è¯•</h3></div>
                    <div class="info-row"><div class="info-item">å§“åï¼š<span>åˆ˜ä¹¦è¯­</span></div><div class="info-item">ç­çº§ï¼š<span>ä¸€(1)ç­</span></div></div>
                    <h4 style="border-left: 5px solid var(--color-apple-blue); padding-left: 10px; margin-top: 20px;">ä¸€ã€è®¡ç®—é¢˜ (${EXAM_TOTAL_QUESTIONS} é¢˜)</h4>
                    <div class="problem-item" style="font-weight: 700; border-bottom: 2px solid #ddd; padding-bottom: 5px; background-color: var(--color-card-bg);">
                        <span class="problem-text" style="font-weight: 700;">é¢˜ç›®</span><span class="user-answer-display" style="color: var(--color-text-dark); font-weight: 700;">ä½ çš„ç­”æ¡ˆ</span><span class="correct-answer-display" style="color: var(--color-text-dark); font-weight: 700;">æ­£è§£</span><span class="problem-mark-group" style="justify-content: center; font-weight: 700;">å¯¹é”™</span>
                    </div>
                    <ul class="problem-list">${problemListHTML}</ul>
                    <div class="report-actions">
                        <button onclick="generateReportImage();" class="btn-download">ğŸ“¸ ç”Ÿæˆæˆç»©å•å›¾ç‰‡</button>
                        <button onclick="examModal.style.display='none'; switchMode('exam');" class="btn-primary">å†è€ƒä¸€æ¬¡ (10é¢˜)</button>
                        <button onclick="examModal.style.display='none'; switchMode('mixed');" class="btn-secondary">è¿”å›ç»ƒä¹ æ¨¡å¼</button>
                    </div>
                </div>`;
            examModal.style.display = 'block'; 
            newProbBtn.disabled = false; hintBtn.disabled = false;
            feedbackEl.textContent = `è€ƒè¯•ç»“æŸï¼Œå¾—åˆ† ${score.toFixed(0)} åˆ†`; feedbackEl.className = 'feedback-correct';
        }

        // --- ç­”æ¡ˆæ£€æŸ¥å’Œé—®é¢˜ç”Ÿæˆ ---
        const checkAnswer = () => {
            if (isSubmitting || (isExamMode && examCurrentQuestion >= EXAM_TOTAL_QUESTIONS)) { return; }
            const uA = parseInt(ansInput.value.trim());
            const eA = currentProblem.answer;
            if (isNaN(uA)) { feedbackEl.textContent = 'è¯·å…ˆè¾“å…¥æ•°å­—ç­”æ¡ˆï¼'; wrongFlash(); return; }
            ansInput.classList.remove('wrong-flash');
            isSubmitting = true; submitBtn.disabled = true; 
            const problemSnapshot = { ...currentProblem, userAnswer: uA }; 

            if (isExamMode) {
                const isC = uA === eA;
                if (isC) examCorrectAnswers++;
                examProblems.push(problemSnapshot); 
                examCurrentQuestion++;
                setTimeout(() => { 
                    if (examCurrentQuestion < EXAM_TOTAL_QUESTIONS) { generateProblem(true); isSubmitting = false; submitBtn.disabled = false; } 
                    else { endExam(); }
                }, 500); 
            } else {
                totalCount++;
                if (uA === eA) {
                    correctCount++; feedbackEl.textContent = 'âœ… å¤ªæ£’äº†ï¼å›ç­”æ­£ç¡®ï¼ ğŸ‰'; feedbackEl.className = 'feedback-correct';
                    vfx();
                    setTimeout(() => { submitBtn.disabled = false; generateProblem(true); isSubmitting = false; }, 2000);
                } else {
                    wrongCount++; feedbackEl.textContent = `âŒ é”™äº†ï¼Œæ­£ç¡®ç­”æ¡ˆæ˜¯ ${eA} âŒ`; feedbackEl.className = 'feedback-wrong'; wrongFlash();
                    isSubmitting = false; submitBtn.disabled = false; 
                }
                cCntEl.textContent = correctCount; wCntEl.textContent = wrongCount; tCntEl.textContent = totalCount;
            }
        };
        
        const skipProblem = () => { feedbackEl.textContent = ''; feedbackEl.className = ''; generateProblem(false); }
        
        function setButtonMode() {
            const isMobile = window.matchMedia("(max-width: 600px)").matches;
            const btnTxt = newProbBtn.querySelector('.button-text');
            if (btnTxt) { newProbBtn.classList.toggle('icon-mode', !isMobile); btnTxt.style.display = isMobile ? 'inline-block' : 'none'; }
        }
        
        function generateProblem(shouldFocus = false) { 
            let n1, n2, op1, n3 = null, op2 = null, res = null;
            let unknownPos = 'res'; 
            let generatorMode = isExamMode ? ['add', 'sub', 'mixed', 'continuous', 'couShi', 'jieShi', 'pingShi', 'noBreakSub', 'noCarryAdd'][Math.floor(Math.random() * 9)] : modeSelect.value;
            let attempts = 0; let generatedSuccessfully = false; 

            const clearDisplay = () => {
                n1El.textContent = ''; op1El.textContent = ''; n2El.textContent = ''; 
                op2El.textContent = ''; n3El.textContent = ''; equalsSignEl.textContent = '';
                resultDisplayEl.textContent = ''; mathProbDispEl.classList.remove('three-op'); 
            };
            clearDisplay();

            if (isExamMode) submitBtn.disabled = false;
            
            try {
                while (!generatedSuccessfully && attempts < MAX_GENERATION_ATTEMPTS) {
                    attempts++; n3 = null; op2 = null; res = null; unknownPos = 'res';
                    
                    if (generatorMode === 'sub') {
                        op1 = '-';
                        if (Math.random() < 0.4) {
                             n1 = 10 + Math.floor(Math.random() * 11); res = 1 + Math.floor(Math.random() * (n1 - 1)); 
                             n2 = n1 - res; if (n2 > 0 && n2 <= 19) { unknownPos = 'n2'; generatedSuccessfully = true; }
                        } else {
                             n1 = 10 + Math.floor(Math.random() * 11); n2 = Math.floor(Math.random() * n1); res = n1 - n2; 
                             if (res >= 0) generatedSuccessfully = true;
                        }
                    } else if (generatorMode === 'mixed') {
                        const type = Math.floor(Math.random() * 4);
                        if (type === 0) { op1 = '+'; n1 = Math.floor(Math.random() * 11); n2 = Math.floor(Math.random() * (maxNum + 1 - n1)); res = n1 + n2; unknownPos = 'res'; generatedSuccessfully = true; }
                        else if (type === 1) { op1 = '-'; n1 = 10 + Math.floor(Math.random() * 11); n2 = Math.floor(Math.random() * n1); res = n1 - n2; unknownPos = 'res'; generatedSuccessfully = true; }
                        else if (type === 2) { op1 = '+'; n1 = 5 + Math.floor(Math.random() * 10); let maxN2 = maxNum - n1; if (maxN2 < 1) continue; n2 = 1 + Math.floor(Math.random() * maxN2); res = n1 + n2; if (n2 > 0 && res <= maxNum) { unknownPos = 'n2'; generatedSuccessfully = true; } }
                        else if (type === 3) { op1 = '-'; n1 = 10 + Math.floor(Math.random() * 11); res = 1 + Math.floor(Math.random() * (n1 - 1)); n2 = n1 - res; if (n2 > 0 && n2 <= 19) { unknownPos = 'n2'; generatedSuccessfully = true; } }
                    } else if (generatorMode === 'continuous') {
                        op1 = Math.random() < 0.5 ? '+' : '-'; n1 = 10 + Math.floor(Math.random() * 10);
                        let n2Range = op1 === '+' ? (maxNum - n1) : (n1 - 1); n2 = 1 + Math.floor(Math.random() * n2Range);
                        let iR = op1 === '+' ? n1 + n2 : n1 - n2;
                        op2 = Math.random() < 0.5 ? '+' : '-';
                        if (op2 === '+') { n3 = 1 + Math.floor(Math.random() * (maxNum - iR)); res = iR + n3; } 
                        else { n3 = 1 + Math.floor(Math.random() * iR); res = iR - n3; }
                        if (res !== null && res <= maxNum && res >= 0) { mathProbDispEl.classList.add('three-op'); generatedSuccessfully = true; }
                    } else if (generatorMode === 'couShi') {
                        op1 = '+'; n1 = 7 + Math.floor(Math.random() * 10); let need = 10 - (n1 % 10);
                        n2 = need + 1 + Math.floor(Math.random() * (9 - need)); 
                        if (n1 + n2 > maxNum) continue; res = n1 + n2;
                        if (res > 10 && (n1 % 10) + (n2 % 10) > 10 && res <= maxNum) generatedSuccessfully = true;
                    } else if (generatorMode === 'noCarryAdd') {
                        op1 = '+'; n1 = 10 + Math.floor(Math.random() * 10); const u1_ = n1 % 10;
                        if (Math.random() < 0.5) { 
                            let maxBUnit = 9 - u1_;
                            if (Math.random() < 0.7) { n2 = 10 + Math.floor(Math.random() * (maxBUnit + 1)); if (n1 + n2 > maxNum) continue; } 
                            else { n2 = 1 + Math.floor(Math.random() * maxBUnit); }
                            if (n2 < 1) continue; res = n1 + n2;
                            if ((n1 % 10) + (n2 % 10) <= 9 && res <= maxNum) generatedSuccessfully = true;
                        } else { 
                            let minC = n1 + 1; let maxC = maxNum; let uC = u1_ + 1 + Math.floor(Math.random() * (9 - u1_)); 
                            res = minC + Math.floor(Math.random() * (maxC - minC + 1)); res = Math.floor(res / 10) * 10 + uC;
                            if (res > maxNum || res < minC) continue; n2 = res - n1; unknownPos = 'n2';
                            if (n2 > 0 && (n1 % 10) + (n2 % 10) <= 9) generatedSuccessfully = true;
                        }
                    } else if (generatorMode === 'noBreakSub') {
                        op1 = '-'; n1 = 11 + Math.floor(Math.random() * 9); const u1_ = n1 % 10;
                        if (Math.random() < 0.5) { 
                            if (Math.random() < 0.7) { n2 = 10 + Math.floor(Math.random() * (u1_ + 1)); if (n2 >= n1) n2 = 10 + u1_ - 1; } 
                            else { n2 = 1 + Math.floor(Math.random() * u1_); }
                            if (n2 < 1) continue; res = n1 - n2;
                            if (n1 > 10 && (n1 % 10) >= (n2 % 10) && res > 0) generatedSuccessfully = true;
                        } else { 
                            let uC = 0 + Math.floor(Math.random() * (u1_ + 1)); let minC = 1; let maxC = n1 - 1; 
                            res = 1 + Math.floor(Math.random() * (maxC - minC + 1)); res = Math.floor(res / 10) * 10 + uC;
                            if (res > maxC || res < minC) continue; n2 = n1 - res; 
                            if (n1 > 10 && (res % 10) <= u1_ && n2 > 0) { unknownPos = 'n2'; generatedSuccessfully = true; }
                        }
                    } else if (generatorMode === 'pingShi' || generatorMode === 'jieShi') {
                        op1 = '-'; n1 = 11 + Math.floor(Math.random() * 9); let uD = n1 % 10; 
                        if (Math.random() < 0.5) { 
                            n2 = uD + 1 + Math.floor(Math.random() * (9 - uD)); if (n2 >= n1) n2 = n1 - 1; 
                            res = n1 - n2; unknownPos = 'res';
                            if (n1 > 10 && n2 % 10 > uD && res >= 0) generatedSuccessfully = true;
                        } else {
                            let minC = uD + 1; let maxC = n1 - 1; if (maxC < minC) continue; 
                            res = minC + Math.floor(Math.random() * (maxC - minC + 1)); n2 = n1 - res; unknownPos = 'n2';
                            if (n1 > 10 && n2 > 0 && (res % 10) > uD) generatedSuccessfully = true;
                        }
                    } else if (generatorMode === 'add') { 
                        op1 = '+'; n1 = Math.floor(Math.random() * (maxNum + 1)); n2 = Math.floor(Math.random() * (maxNum + 1 - n1)); res = n1 + n2;
                        if (res >= 0) generatedSuccessfully = true;
                    } 
                } 

                if (!generatedSuccessfully) { op1 = '+'; n1 = 12; n2 = 5; res = 17; n3 = null; op2 = null; unknownPos = 'res'; }
            
            } catch (error) {
                console.error("Critical error:", error); op1 = '+'; n1 = 88; n2 = 11; res = 99; unknownPos = 'res';
                feedbackEl.textContent = 'âŒ ç”Ÿæˆé”™è¯¯';
            }
            
            currentProblem = { 
                num1: n1, num2: n2, operator1: op1, num3: n3, operator2: op2, 
                answer: (unknownPos === 'res' || generatorMode === 'continuous') ? res : n2,
                unknownPosition: unknownPos, specificMode: generatorMode 
            };
            
            if (unknownPos === 'n2') {
                n1El.textContent = n1; op1El.textContent = op1; n2El.textContent = '?'; equalsSignEl.textContent = '=';
                resultDisplayEl.textContent = n1 + (op1 === '+' ? currentProblem.answer : -currentProblem.answer);
            } else {
                n1El.textContent = n1; op1El.textContent = op1; n2El.textContent = n2; 
                if (generatorMode === 'continuous' && n3 !== null) {
                    op2El.textContent = op2; n3El.textContent = n3; mathProbDispEl.classList.add('three-op'); 
                } else { op2El.textContent = ''; n3El.textContent = ''; }
                equalsSignEl.textContent = '='; resultDisplayEl.textContent = '?';
            }
            ansInput.value = ''; if (shouldFocus) ansInput.focus();
            if (isExamMode) { feedbackEl.textContent = `è€ƒè¯•è¿›åº¦: ç¬¬ ${examCurrentQuestion + 1} / ${EXAM_TOTAL_QUESTIONS} é¢˜`; } 
            else if (!feedbackEl.textContent.includes('å›ç­”æ­£ç¡®') && !feedbackEl.textContent.includes('é”™äº†')) { feedbackEl.textContent = ''; }
        }

        submitBtn.addEventListener('click', checkAnswer); hintBtn.addEventListener('click', showCurrentHint);
        newProbBtn.addEventListener('click', skipProblem); 
        modeSelect.addEventListener('change', () => switchMode(modeSelect.value));
        hintModalClose.addEventListener('click', closeHintModal);
        examModalClose.addEventListener('click', closeExamModal);
        window.addEventListener('click', (e) => { if (e.target === hintModal) closeHintModal(); if (e.target === examModal) closeExamModal(); });
        ansInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); checkAnswer(); } });
        window.addEventListener('resize', setButtonMode); 
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = (new Date()).getTime(); if (now - lastTouchEnd <= 300) e.preventDefault(); lastTouchEnd = now;
        }, { passive: false });

        setButtonMode(); 
        switchMode(modeSelect.value || 'jieShi'); 
    </script>
</body>
</html>
