<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>åˆ˜ä¹¦è¯­çš„é­”æ³•æ•°å­¦ç‰¹è®­è¥</title> 
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> 
    <meta name="apple-mobile-web-app-title" content="æ•°å­¦ç‰¹è®­è¥">
    
    <style>
        /* --- é€šç”¨æ ·å¼ (ä¿æŒä¸å˜) --- */
        * { touch-action: manipulation; box-sizing: border-box; }
        :root {
            --color-apple-blue: #007aff; --color-apple-green: #34c759; 
            --color-apple-red: #ff3b30; --color-apple-orange: #ff9500; 
            --color-background-soft: #f2f2f7; --color-card-bg: #f7f7f9;
            --color-text-dark: #1d1d1f; --color-button-secondary: #e5e5ea;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--color-background-soft); color: var(--color-text-dark);
            margin: 0; padding: 0; display: flex; justify-content: center; 
            min-height: 100vh; padding-bottom: 20px; -webkit-text-size-adjust: 100%; 
        }
        .container {
            width: 100%; max-width: 900px; background-color: #ffffff; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); padding: 2vh 4vw; 
            text-align: center; display: flex; flex-direction: column; 
            align-items: center; min-height: 10vh; 
        }
        .header-section { width: 100%; flex-shrink: 0; padding-top: 1vh; display: flex; flex-direction: column; align-items: center; }
        h1 { font-size: clamp(24px, 3.5vw, 32px); font-weight: 700; margin-bottom: 0.5vh; }
        .tagline { font-size: clamp(14px, 2vw, 16px); color: #555; margin-bottom: 1.5vh; }
        .mode-switch-group { width: 90%; max-width: 500px; margin-bottom: 2vh; }
        .mode-select {
            width: 100%; padding: 1.5vh 12px; font-size: clamp(14px, 2.2vw, 16px);
            border-radius: 10px; box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.08); 
            appearance: none; -webkit-appearance: none; -moz-appearance: none; border: 1px solid #ccc;
        }
        .score-board {
            display: flex; justify-content: space-around; margin-top: 1vh; margin-bottom: 2.5vh; 
            padding: 1.5vh 10px; background-color: var(--color-card-bg); border-radius: 12px; 
            width: 80%; max-width: 500px;
        }
        .score-item { font-size: clamp(14px, 2.5vw, 16px); font-weight: 500; }
        .score-item span { color: var(--color-apple-blue); font-weight: 700; }
        .main-calculation-area { 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            width: 100%; padding-top: 2vh; padding-bottom: 2vh; position: relative; 
        }
        .math-problem { 
            font-size: 11vw; font-weight: 800; margin: 1vh 0; min-height: 15vw; 
            display: flex; justify-content: center; align-items: center; gap: 15px;
        }
        .math-problem.three-op { font-size: 8vw; }
        @media (max-width: 600px) {
            .math-problem { font-size: 15vw; gap: 10px; }
            .math-problem.three-op { font-size: 10vw; }
        }
        .input-wrapper { 
            margin-top: 4vh; margin-bottom: 5vh; display: flex; flex-wrap: wrap; 
            justify-content: center; gap: 10px; width: 100%; max-width: 400px; 
        }
        #answerInput { 
            padding: 2vh 15px; font-size: clamp(20px, 3.5vw, 24px); border-radius: 10px; 
            margin-bottom: 10px; width: clamp(150px, 40vw, 200px); transition: all 0.2s; 
            border: 1px solid #ccc; text-align: center;
        }
        .wrong-flash {
            border: 2px solid var(--color-apple-red) !important;
            box-shadow: 0 0 10px rgba(255, 59, 48, 0.5); animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        #newProblemButton {
            padding: 2vh 4vw; font-size: clamp(14px, 2.5vw, 16px); font-weight: 600; 
            background-color: var(--color-button-secondary); color: var(--color-text-dark);
            border-radius: 10px; border: none; cursor: pointer; transition: opacity 0.2s, background-color 0.2s; flex-shrink: 0; 
        }
        @media (min-width: 601px) {
             #newProblemButton.icon-mode {
                 position: absolute; top: 50%; right: 5%; transform: translateY(-50%);
                 padding: 10px; font-size: 20px; border-radius: 50%; width: 40px; height: 40px;
                 display: flex; align-items: center; justify-content: center;
                 box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); opacity: 0.8; z-index: 10;
             }
             #newProblemButton .button-text { display: none; }
        }
        #submitButton, #hintButton { 
            padding: 2vh 4vw; font-size: clamp(14px, 2.5vw, 16px); font-weight: 600; 
            border-radius: 10px; border: none; cursor: pointer; 
            transition: opacity 0.2s, background-color 0.2s; flex-shrink: 0; 
        }
        #submitButton { background-color: var(--color-apple-blue); color: white; }
        #hintButton { background-color: var(--color-apple-orange); color: var(--color-text-dark); }
        
        #hintButton:disabled, #newProblemButton:disabled, #submitButton:disabled {
            opacity: 0.5; cursor: not-allowed;
        }

        @media (max-width: 600px) {
            .input-wrapper { flex-direction: column; align-items: center; padding: 0 5%; max-width: 100%; }
            #answerInput { width: 100%; max-width: 250px; }
            #submitButton, #hintButton, #newProblemButton { 
                width: 100%; max-width: 250px; margin-bottom: 5px; position: static; transform: none; padding: 2vh 4vw; 
            }
            #newProblemButton .button-text { display: inline-block; }
        }
        #feedback { font-size: clamp(18px, 3vw, 22px); font-weight: 700; color: var(--color-text-dark); min-height: 4vh; }
        .feedback-correct { color: var(--color-apple-green); }
        .feedback-wrong { color: var(--color-apple-red); }
        .vfx-container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 1px; height: 1px; pointer-events: none; overflow: visible; z-index: 50; 
        }
        .correct-vfx {
            position: absolute; font-size: 20px; color: gold; text-shadow: 0 0 5px orange;
            animation: flyout 1s ease-out forwards; opacity: 0;
        }
        @keyframes flyout {
            0% { opacity: 1; transform: translate(0, 0) scale(1); }
            25% { opacity: 1; }
            100% { opacity: 0; transform: translate(var(--dx), var(--dy)) scale(0.5); }
        }
        
        /* --- æ¨¡æ€æ¡†é€šç”¨æ ·å¼ --- */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); overflow: auto;
        }
        #hintModal { z-index: 1050; } 
        
        /* æ¨¡æ€æ¡†å†…å®¹æ ·å¼ */
        #examModal .modal-content, #hintModal .modal-content {
            background-color: #ffffff; margin: 5vh auto; padding: 3vh 4vw; border-radius: 20px; 
            width: 95%; max-width: 700px; box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2); 
            animation: modalopen 0.4s ease-out; text-align: left; 
            max-height: 90vh; overflow-y: auto; -webkit-overflow-scrolling: touch;
        }
        
        .modal-title { font-size: clamp(20px, 4vw, 26px); font-weight: 700; color: var(--color-text-dark); margin-bottom: 2vh; border-bottom: 2px solid #ddd; padding-bottom: 1vh; }
        .modal-close { float: right; font-size: clamp(24px, 5vw, 32px); font-weight: 300; cursor: pointer; color: #888; transition: color 0.2s; }
        
        /* --- å¯è§†åŒ–è¾…åŠ©ç”»å›¾æ ·å¼ (10æ ¼é˜µ) --- */
        .visual-container {
            margin: 15px 0;
            padding: 15px;
            background-color: #fcfcfc;
            border: 2px dashed #ddd;
            border-radius: 12px;
            display: grid; /* ä½¿ç”¨ Grid å¸ƒå±€ */
            grid-template-columns: repeat(10, 1fr); /* å¼ºåˆ¶ä¸€è¡Œ10ä¸ª */
            gap: 8px;
            justify-items: center; /* æ°´å¹³å±…ä¸­ */
            align-items: center; /* å‚ç›´å±…ä¸­ */
            max-width: 100%;
        }
        
        /* æ¯ä¸ªå°ç‰©å“çš„æ ·å¼ */
        .visual-item {
            width: 32px; height: 32px;
            font-size: 20px;
            display: flex; align-items: center; justify-content: center;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #eee;
            transition: all 0.3s;
        }
        
        /* æ‰‹æœºç«¯é€‚é…ï¼šç¼©å°å›¾æ ‡ */
        @media (max-width: 500px) {
            .visual-container { gap: 4px; padding: 10px 5px; }
            .visual-item { width: 24px; height: 24px; font-size: 14px; }
        }

        /* å‡æ³•è¢«å‡æ‰çš„æ ·å¼ */
        .is-subtracted {
            opacity: 0.25;
            filter: grayscale(100%);
            transform: scale(0.8);
            text-decoration: line-through;
            background-color: #f5f5f5;
        }
        
        .visual-legend {
            grid-column: 1 / -1; /* å æ»¡æ•´è¡Œ */
            font-size: 14px; color: #555; text-align: center; margin-top: 10px; font-weight: 600;
            border-top: 1px solid #eee;
            padding-top: 8px;
            width: 100%;
        }

        /* --- æç¤ºæ­¥éª¤æ ·å¼ --- */
        .modal-step {
            margin-bottom: 2vh; 
            font-size: clamp(15px, 2.5vw, 18px); 
            line-height: 1.6;
            padding-left: 10px; 
            border-left: 4px solid var(--color-apple-blue); 
            transition: opacity 0.4s ease-out, transform 0.4s ease-out; 
        }
        .modal-step strong { display: block; margin-bottom: 0.5vh; font-weight: 800; } 
        .modal-step.fade-start { opacity: 0; transform: translateY(10px); }
        .modal-step.fade-end { opacity: 1; transform: translateY(0); }
        
        /* å¼ºè°ƒè‰²å®šä¹‰ */
        .highlight-ten { color: var(--color-apple-orange); font-weight: 700; } 
        .highlight-goal { color: var(--color-apple-green); font-weight: 700; } 
        .highlight-remain { color: var(--color-apple-blue); font-weight: 700; } 
        
        /* å…¬å¼æ ·å¼ä¼˜åŒ– */
        .formula { 
            font-size: clamp(18px, 3.5vw, 24px); font-weight: 800; color: var(--color-text-dark); 
            display: block; margin-top: 2vh; margin-bottom: 2vh; text-align: center; 
            background-color: var(--color-card-bg); padding: 1.5vh; border-radius: 10px; 
            letter-spacing: 1px; box-shadow: 0 0 3px rgba(0, 0, 0, 0.05);
            /* **æ–°å¢è¿‡æ¸¡æ•ˆæœ** */
            transition: opacity 0.5s ease-in, transform 0.5s ease-in; 
            opacity: 1; /* é»˜è®¤å¯è§ */
        }
        /* **æ–°å¢ï¼šå…¬å¼åˆå§‹éšè—/æ·¡å…¥çŠ¶æ€** */
        .formula.fade-start {
            opacity: 0 !important; 
            transform: translateY(10px);
        }

        .formula .op-red { color: var(--color-apple-red); }
        .formula .num-red { color: var(--color-apple-red); }
        
        /* **æ–°å¢ï¼šè½¬æ¢å…¬å¼çš„ç‰¹æ®Šæ ·å¼å’Œè¿‡æ¸¡ï¼ˆç”¨äºé¡ºåºå±•ç¤ºï¼‰** */
        .formula.conversion-formula {
            font-size: clamp(16px, 3vw, 20px); 
            margin-top: 0.5vh; 
            margin-bottom: 1.5vh; 
            color: var(--color-apple-orange);
            background-color: #ffeccf; /* æµ…æ©™è‰²èƒŒæ™¯ */
            padding: 1vh;
        }

        /* --- æ–°å¢ï¼šç«–å¼ç®—æ³•æ ·å¼ (Vertical Calculation) --- */
        .vertical-calc-wrapper {
            margin: 20px auto;
            width: fit-content;
            text-align: center;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background-color: var(--color-card-bg);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .vertical-calc {
            font-family: 'Courier New', monospace; /* ä½¿ç”¨ç­‰å®½å­—ä½“ç¡®ä¿æ•°å­—å¯¹é½ */
            font-size: clamp(24px, 4vw, 36px);
            line-height: 1.2;
            text-align: right;
            display: inline-block;
        }

        .carry-row, .borrow-row {
            font-size: 0.5em; /* è¿›ä½/å€Ÿä½æ ‡è®°å­—ä½“è¾ƒå° */
            line-height: 0.8;
            height: 0.8em;
            padding-right: 0.1em;
            text-align: right;
            color: var(--color-apple-orange); /* è¿›ä½/å€Ÿä½æ ‡è®°é¢œè‰² */
            font-weight: bold;
        }

        .borrow-mark {
            color: var(--color-apple-red); 
            display: inline-block;
            min-width: 1em; /* ç¡®ä¿å ä½ */
        }

        .num-row {
            font-weight: 500;
        }

        .op-row {
            border-bottom: 3px solid var(--color-text-dark);
            padding-bottom: 3px;
            margin-bottom: 3px;
            font-weight: 600;
        }

        .result-row {
            font-weight: 700;
            color: var(--color-apple-blue);
        }

        .strikethrough {
            text-decoration: line-through;
            color: #aaa; /* è¢«å€Ÿèµ°çš„æ•°å­—é¢œè‰²å˜æ·¡ */
            padding: 0 0.1em;
        }

        /* ç¡®ä¿ä¸ªä½å¯¹é½ */
        .col-unit {
            display: inline-block;
            width: 1em; /* ä¸ªä½å ä½ */
            text-align: center;
        }
        .col-ten {
            display: inline-block;
            width: 1em; /* åä½å ä½ */
            text-align: center;
        }
        /* --- ç«–å¼ç®—æ³•æ ·å¼ç»“æŸ --- */

        @keyframes modalopen {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* --- æˆç»©å•æ ·å¼ --- */
        #examReportContent {
            padding-bottom: 20px; position: relative; 
            background-color: #fff; border-radius: 15px; border: 2px solid #ccc;
        }
        .exam-report-inner { padding: 20px; }
        .report-header { 
            text-align: center; margin-bottom: 20px; max-width: 90%; margin-left: auto; margin-right: auto;
        }
        .report-header h3 { 
            font-size: 26px; font-weight: 800; color: var(--color-text-dark); margin: 0; 
            border-bottom: 3px double #333; padding-bottom: 5px; white-space: nowrap; 
        }
        .info-row { 
            display: flex; justify-content: space-around; font-size: 16px; 
            margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px dashed #ddd; width: 100%; 
        }
        .info-item { flex: 1; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .info-item span { font-weight: 700; color: var(--color-apple-blue); }
        .score-box {
            position: absolute; top: 10px; right: 20px; 
            width: 80px; height: 80px; border: 2px solid var(--color-apple-red);
            border-radius: 5px; display: flex; align-items: center; justify-content: center;
            font-size: 36px; font-weight: 800; color: var(--color-apple-red); line-height: 1;
        }
        .problem-list { margin-top: 10px; list-style: none; padding: 0; }
        .problem-item { 
            display: grid; grid-template-columns: 2fr 1fr 1fr 50px; align-items: center; 
            padding: 8px 0; border-bottom: 1px dotted #eee; font-size: 18px; gap: 5px;
        }
        .problem-text { font-weight: 500; color: var(--color-text-dark); text-align: left; }
        .user-answer-display { font-weight: 700; text-align: center; font-size: 16px; }
        .correct-answer-display { color: var(--color-apple-blue); font-weight: 700; font-size: 14px; text-align: center; }
        .problem-mark-group { display: flex; align-items: center; justify-content: flex-end; gap: 5px; }
        .btn-hint-review {
            background-color: var(--color-apple-orange); color: white; border: none; border-radius: 50%;
            width: 25px; height: 25px; font-size: 14px; line-height: 25px; padding: 0;
            cursor: pointer; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2); flex-shrink: 0;
        }
        .problem-mark { font-size: 30px; font-weight: 900; font-family: Arial, sans-serif; line-height: 1; flex-shrink: 0; }
        .mark-wrong { color: #ff3b30; } 
        .report-actions { display: flex; justify-content: center; gap: 10px; margin-top: 30px; flex-wrap: wrap; }
        .report-actions button {
            padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;
            font-size: 16px; font-weight: 600; transition: background-color 0.2s;
        }
        .btn-primary { background-color: var(--color-apple-blue); color: white; }
        .btn-secondary { background-color: var(--color-apple-orange); color: white; }
        .btn-download { background-color: var(--color-apple-green); color: white; }
        .hide-for-capture { display: none; }

    </style>
</head>
<body>
    <div class="container">
        <div class="header-section">
            <h1>ğŸ¥³ åˆ˜ä¹¦è¯­çš„é­”æ³•æ•°å­¦ç‰¹è®­è¥</h1>
            <p class="tagline">ğŸ¥‡ æˆä¸ºå…¨ç­æ•°å­¦å°å† å†›ï¼ (ä¸€å¹´çº§æ–¹æ³•ä¸“é¡¹ç»ƒä¹ )</p>
            <div class="mode-switch-group">
                <div class="select-wrapper">
                    <select id="modeSelect" class="mode-select">
                        <optgroup label="åŸºç¡€è¿ç®—æ¨¡å¼">
                            <option value="add">åŸºç¡€åŠ æ³•</option>
                            <option value="sub">åŸºç¡€å‡æ³•</option>
                            <option value="mixed">æ··åˆç»ƒä¹ </option>
                            <option value="continuous">ğŸ”¥ è¿ç»­è¿ç®—</option>
                        </optgroup>
                        <optgroup label="ä¸“é¡¹æ–¹æ³•ç»ƒä¹ ">
                            <option value="noCarryAdd">ğŸ¯ åŒä½ç›¸åŠ æ³• (ä¸è¿›ä½)</option>
                            <option value="noBreakSub">ğŸ¯ åŒä½ç›¸å‡æ³• (ä¸ç ´å)</option>
                            <option value="couShi">ğŸ¯ å‡‘åæ³•</option>
                            <option value="jieShi" selected>ğŸ¯ å€Ÿåæ³•</option>
                            <option value="pingShi">ğŸ¯ å¹³åæ³•</option>
                        </optgroup>
                        <optgroup label="è€ƒè¯•ä¸æŒ‘æˆ˜">
                            <option value="exam">ğŸ’¯ 10é¢˜å¿«é€Ÿè€ƒè¯•</option>
                        </optgroup>
                    </select>
                </div>
            </div>
            <div class="score-board">
                <div class="score-item">æ­£ç¡®: <span id="correctCount">0</span></div>
                <div class="score-item">é”™è¯¯: <span id="wrongCount">0</span></div>
                <div class="score-item">æ€»æ•°: <span id="totalCount">0</span></div>
            </div>
        </div>
        <div class="main-calculation-area">
            <div class="math-problem" id="mathProblemDisplay">
                <span id="number1"></span><span id="operator1" class="operator"></span>
                <span id="number2"></span><span id="operator2"></span> 
                <span id="number3"></span><span id="equalsSign"></span><span id="resultDisplay"></span>
            </div>
            <div id="vfxContainer" class="vfx-container"></div>
            <button id="newProblemButton">ğŸ”„ <span class="button-text">æ¢é¢˜</span></button>
            <div class="input-wrapper">
                <input type="number" id="answerInput" placeholder="è¯·è¾“å…¥ç­”æ¡ˆ" inputmode="numeric">
                <button id="submitButton">æäº¤</button>
                <button id="hintButton">ğŸ’¡ æç¤º</button>
            </div>
        </div>
        <div id="feedback"></div>
    </div>
    
    <div id="examModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" id="examModalClose">&times;</span>
            <div id="examModalTitle" class="modal-title"></div>
            <div id="examReportContent"></div>
        </div>
    </div>

    <div id="hintModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" id="hintModalClose">&times;</span>
            <div id="hintVisuals"></div> 
            <div id="hintModalSteps"></div>
        </div>
    </div>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script>
        // --- å˜é‡å’ŒçŠ¶æ€åˆå§‹åŒ– ---
        // **ä¿®æ­£ 1: å°† maxNum è®¾ç½®ä¸º 20**
        let currentProblem = { num1: 0, num2: 0, operator1: '+', num3: null, operator2: null, answer: 0, steps: [], unknownPosition: 'res', specificMode: null }; 
        let correctCount = 0, wrongCount = 0, totalCount = 0, maxNum = 20; 
        let isExamMode = false; const EXAM_TOTAL_QUESTIONS = 10;
        let examCurrentQuestion = 0, examCorrectAnswers = 0; 
        let examProblems = []; 
        let isSubmitting = false; 
        const MAX_GENERATION_ATTEMPTS = 50; 
        let currentMode = 'jieShi'; 

        // è€ƒè¯•æ¨¡å¼ä¸‹çš„é¢˜å‹åˆ†å¸ƒ (5ä¸ªç±»å‹ï¼Œæ¯ä¸ª2é¢˜)
        const EXAM_MODES_DISTRIBUTION = [
            'couShi', 'couShi', 
            'jieShi', 'jieShi', 
            'noCarryAdd', 'noCarryAdd', 
            'noBreakSub', 'noBreakSub', 
            'continuous', 'continuous'
        ];

        // --- å…ƒç´  ID æŸ¥æ‰¾ ---
        function getElementByIdSafe(id) {
            const el = document.getElementById(id);
            if (!el) {
                console.error(`DOM Error: Element with ID "${id}" not found.`);
                return { textContent: '', classList: { add: () => {}, remove: () => {} }, style: {}, innerHTML: '' };
            }
            return el;
        }

        const [n1El, op1El, n2El, op2El, n3El, ansInput, submitBtn, hintBtn, newProbBtn, feedbackEl, cCntEl, wCntEl, tCntEl, modeSelect, vfxCont, mathProbDispEl, examModal, hintModal, equalsSignEl, resultDisplayEl] = 
            ['number1', 'operator1', 'number2', 'operator2', 'number3', 'answerInput', 'submitButton', 'hintButton', 'newProblemButton', 'feedback', 'correctCount', 'wrongCount', 'totalCount', 'modeSelect', 'vfxContainer', 'mathProblemDisplay', 'examModal', 'hintModal', 'equalsSign', 'resultDisplay'].map(id => getElementByIdSafe(id));
        
        const [examModalClose, hintModalClose, examModalTitle, hintModalTitle, hintModalSteps, hintVisuals] =
            ['examModalClose', 'hintModalClose', 'examModalTitle', 'hintModalTitle', 'hintModalSteps', 'hintVisuals'].map(id => getElementByIdSafe(id));
        
        const examReportContent = getElementByIdSafe('examReportContent'); 

        // --- è¾…åŠ©å‡½æ•° ---
        function vfx() {
            vfxCont.innerHTML = ''; 
            for (let i = 0; i < 15; i++) {
                const v = document.createElement('div');
                v.className = 'correct-vfx'; v.textContent = 'â­'; 
                const angle = Math.random() * 2 * Math.PI;
                const distance = 80 + Math.random() * 50; 
                v.style.setProperty('--dx', `${Math.cos(angle) * distance}px`);
                v.style.setProperty('--dy', `${Math.sin(angle) * distance}px`);
                v.style.transform = `translate(${(Math.random() - 0.5) * 20}px, ${(Math.random() - 0.5) * 20}px)`;
                vfxCont.appendChild(v);
                v.addEventListener('animationend', () => v.remove());
            }
        }
        function wrongFlash() {
            ansInput.classList.add('wrong-flash');
            setTimeout(() => ansInput.classList.remove('wrong-flash'), 500);
        }
        
        // --- Hint Styling Helpers ---
        const numSpan = (num, className) => `<span class="${className}">${num}</span>`;
        const opRedSpan = (op) => `<span class="op-red">${op}</span>`;
        const numRedSpan = (num) => `<span class="num-red">${num}</span>`;
        const parenRedSpan = (op) => `<span class="op-red">${op}</span>`;
        const stepContent = (title, content) => `<strong>${title}</strong>${content}`; 
        
        // --- å¯è§†åŒ–ç”»å›¾å‡½æ•° (ä¿æŒä¸å˜) ---
        function renderVisualHelpers(container, n1, n2, op) {
            container.innerHTML += ''; // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨ += ç¡®ä¿ä¸è¦†ç›–ç«–å¼
            // **æ›´æ–°: å°†æœ€å¤§ç”»å›¾æ•°å­—ä» 30 æ›´æ”¹ä¸º 20**
            if (n1 > 20) {
                 const msg = document.createElement('div');
                 msg.className = 'visual-legend';
                 msg.textContent = `(æ•°å­—è¾ƒå¤§ï¼Œæ­¤å¤„ä¸ç»˜åˆ¶è¯¦ç»†è‹¹æœå›¾)`;
                 container.appendChild(msg);
                 return; 
            }

            const wrapper = document.createElement('div');
            wrapper.className = 'visual-container';
            
            const addItem = (type, isSubtracted = false) => {
                const item = document.createElement('div');
                item.className = 'visual-item';
                item.textContent = type === 'A' ? 'ğŸ' : 'ğŸ';
                if (isSubtracted) item.classList.add('is-subtracted');
                return item;
            };

            if (op === '+') {
                const total = n1 + n2;
                for (let i = 0; i < total; i++) {
                    wrapper.appendChild(addItem(i < n1 ? 'A' : 'B'));
                }
                 const legend = document.createElement('div');
                legend.className = 'visual-legend';
                legend.textContent = `ğŸ ${n1} ä¸ª + ğŸ ${n2} ä¸ª = ${total} ä¸ª`;
                wrapper.appendChild(legend);

            } else { // å‡æ³•
                for (let i = 0; i < n1; i++) {
                    const isSubtracted = i >= (n1 - n2); 
                    wrapper.appendChild(addItem('A', isSubtracted));
                }
                const legend = document.createElement('div');
                legend.className = 'visual-legend';
                legend.textContent = `å…±æœ‰ ${n1} ä¸ª ğŸï¼Œæ‹¿èµ° ${n2} ä¸ªï¼Œè¿˜å‰© ${n1-n2} ä¸ª`;
                wrapper.appendChild(legend);
            }

            container.appendChild(wrapper);
        }

        // **æ–°å¢: ç«–å¼ç®—æ³• HTML ç”Ÿæˆå‡½æ•°**
        function getVerticalCalcHTML(n1, n2, op, res) {
            if (n1 > 20 || n2 > 20 || res > 20 || n1 < 0 || n2 < 0) {
                return `<div class="vertical-calc-wrapper"><div class="visual-legend">(ç«–å¼è®¡ç®—æ¨¡å—ä»…æ”¯æŒ 20 ä»¥å†…è¿ç®—ï¼Œæ­¤å¤„ä¸å±•ç¤º)</div></div>`;
            }

            let html = '';
            const n1_ten = Math.floor(n1 / 10);
            const n1_unit = n1 % 10;
            const n2_ten = Math.floor(n2 / 10);
            const n2_unit = n2 % 10;
            const res_ten = Math.floor(res / 10);
            const res_unit = res % 10;

            // æ ¼å¼åŒ–æ•°å­—ï¼šç¡®ä¿ä¸¤ä½æ•°æ—¶åä½å’Œä¸ªä½éƒ½æœ‰å†…å®¹ï¼ˆå³ä½¿æ˜¯ç©ºæ ¼ï¼‰
            const formatNum = (num, isN1 = false) => {
                const ten = Math.floor(num / 10);
                const unit = num % 10;
                let tenHTML = '';
                
                if (num < 10) {
                    tenHTML = `<span class="col-ten">&nbsp;</span>`;
                    unitHTML = `<span class="col-unit">${unit}</span>`;
                } else {
                    if (isN1 && op === '-' && n1_unit < n2_unit) {
                        // å‡æ³•å€Ÿä½æ—¶ï¼Œè¢«å‡æ•°çš„åä½è¢«åˆ’æ‰
                         tenHTML = `<span class="col-ten"><span class="strikethrough">${ten}</span></span>`;
                    } else {
                        tenHTML = `<span class="col-ten">${ten}</span>`;
                    }
                    unitHTML = `<span class="col-unit">${unit}</span>`;
                }
                return tenHTML + unitHTML;
            };

            if (op === '+') { // åŠ æ³• (å‡‘åæ³•/è¿›ä½)
                const unit_sum = n1_unit + n2_unit;
                let carry = unit_sum >= 10 ? 1 : 0;
                
                // 1. è¿›ä½è¡Œ
                let carryHTML = `<div class="carry-row">`;
                if (carry > 0) {
                    carryHTML += `&nbsp;<span class="col-ten">Â¹</span><span class="col-unit"></span>`; // è¿›ä½1åˆ°åä½
                } else {
                    carryHTML += `&nbsp;<span class="col-ten"></span><span class="col-unit"></span>`;
                }
                carryHTML += `</div>`;
                
                // 2. ç¬¬ä¸€è¡Œæ•°å­—
                const n1_html = formatNum(n1, true);
                
                // 3. ç¬¬äºŒè¡Œæ•°å­—å’Œè¿ç®—ç¬¦
                const n2_html = formatNum(n2);
                
                // 4. ç»“æœè¡Œ
                const res_html = `<span class="col-ten">${res_ten < 1 ? '&nbsp;' : res_ten}</span><span class="col-unit">${res_unit}</span>`;

                html = `${carryHTML}
                    <div class="num-row">${n1_html}</div>
                    <div class="op-row">${op} ${n2_html}</div>
                    <div class="result-row">${res_html}</div>`;

            } else { // å‡æ³• (å€Ÿåæ³•/é€€ä½)
                const isBorrow = n1_unit < n2_unit;
                
                // 1. å€Ÿä½è¡Œ
                let borrowHTML = `<div class="borrow-row">`;
                if (isBorrow) {
                    // åœ¨ä¸ªä½ä¸Šæ–¹æ ‡è®° 10 (å€Ÿæ¥çš„)
                    borrowHTML += `&nbsp;<span class="col-ten"></span><span class="col-unit"><span style="color:var(--color-apple-red);">Â¹â°</span></span>`; 
                } else {
                    borrowHTML += `&nbsp;<span class="col-ten"></span><span class="col-unit"></span>`;
                }
                borrowHTML += `</div>`;
                
                // 2. ç¬¬ä¸€è¡Œæ•°å­— (è¢«å‡æ•°)
                const n1_html = formatNum(n1, true);
                
                // 3. ç¬¬äºŒè¡Œæ•°å­—å’Œè¿ç®—ç¬¦
                const n2_html = formatNum(n2);
                
                // 4. ç»“æœè¡Œ
                const res_html = `<span class="col-ten">${res_ten < 1 ? '&nbsp;' : res_ten}</span><span class="col-unit">${res_unit}</span>`;

                html = `${borrowHTML}
                    <div class="num-row">${n1_html}</div>
                    <div class="op-row">${op} ${n2_html}</div>
                    <div class="result-row">${res_html}</div>`;
            }
            
            return `<div class="vertical-calc-wrapper"><div class="visual-legend" style="margin-bottom: 10px; font-weight: bold;">ğŸ“ ç«–å¼è®¡ç®—å±•ç¤º</div><div class="vertical-calc">${html}</div></div>`;
        }

        // **æ–°å¢: è€ƒè¯•é—®é¢˜é¢„ç”Ÿæˆå‡½æ•°**
        function generateExamProblems() {
            examProblems = [];
            const maxAttemptsPerProblem = 10;
            const generatorMap = {
                'couShi': generateCouShi,
                'jieShi': generateJieShi,
                'noCarryAdd': generateNoCarryAdd,
                'noBreakSub': generateNoBreakSub,
                'continuous': generateContinuous,
                'mixed': generateMixed // Fallback
            };
            
            // éšæœºæ‰“ä¹±é¢˜å‹é¡ºåºï¼Œç¡®ä¿è€ƒè¯•é¡ºåºéšæœº
            const shuffledModes = [...EXAM_MODES_DISTRIBUTION].sort(() => Math.random() - 0.5);

            for (let i = 0; i < EXAM_TOTAL_QUESTIONS; i++) {
                let mode = shuffledModes[i];
                let problem = null;
                let attempts = 0;
                let generatedSuccessfully = false;
                
                // è€ƒè¯•æ¨¡å¼ä¸‹ï¼Œéšæœºåˆ†é…æœªçŸ¥æ•° (?) çš„ä½ç½® (20% æ¦‚ç‡)
                const allowUnknown = (Math.random() < 0.25) && (mode !== 'continuous');
                
                while (!generatedSuccessfully && attempts < maxAttemptsPerProblem) {
                    attempts++;
                    try {
                        const generatorFn = generatorMap[mode];
                        problem = generatorFn(maxNum, allowUnknown);
                        // ç¡®ä¿ç­”æ¡ˆå’Œæ•°å­—åœ¨ maxNum èŒƒå›´å†…
                        if (problem.answer >= 0 && problem.answer <= maxNum && 
                            (problem.num3 === null || (problem.num3 !== null && problem.answer <= maxNum)) ) {
                            generatedSuccessfully = true;
                            problem.specificMode = mode;
                        } else {
                            throw new Error('Generated problem failed range check');
                        }
                    } catch (e) {
                        problem = null;
                    }
                }
                
                // å¦‚æœç‰¹å®šé¢˜å‹ç”Ÿæˆå¤±è´¥ï¼Œé€€å›åˆ°æ··åˆç®€å•é¢˜
                if (!generatedSuccessfully) {
                    problem = generateMixed(maxNum, false); 
                    problem.specificMode = 'mixed-fallback';
                }
                
                examProblems.push(problem);
            }
        }
        
        function switchMode(newMode) {
            currentMode = newMode; 
            isExamMode = newMode === 'exam';
            
            if (isExamMode) {
                examCurrentQuestion = 0; examCorrectAnswers = 0; 
                generateExamProblems(); // **NEW: é¢„ç”Ÿæˆè€ƒè¯•é¢˜ç›®**
                correctCount = 0; wrongCount = 0;
            } else if (modeSelect.value === 'exam') {
                correctCount = 0; wrongCount = 0; totalCount = 0;
            }

            modeSelect.value = newMode; 
            cCntEl.textContent = correctCount; wCntEl.textContent = wrongCount; tCntEl.textContent = totalCount;
            newProbBtn.disabled = isExamMode; 
            hintBtn.disabled = isExamMode; 
            submitBtn.disabled = false;
            generateProblem(true);
        }
        
        // --- éšæœºæ•°ç”Ÿæˆå™¨ (ä¿æŒä¸å˜) ---
        function rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
        function modeRandom(arr) { return arr[rand(0, arr.length - 1)]; }

        // --- é¢˜ç›®ç”Ÿæˆé€»è¾‘ (ä¿æŒä¸å˜) ---
        // ... (generateBasicAdd, generateBasicSub, getUnknownProps, generateCouShi, generateJieShi, generatePingShi, generateNoCarryAdd, generateNoBreakSub, generateContinuous, generateMixed ä¿æŒä¸å˜)

        // Basic Addition (A + B = C)
        function generateBasicAdd(maxNum, allowUnknown) {
            let n1 = rand(1, maxNum - 1);
            let n2 = rand(1, maxNum - n1);
            if (!allowUnknown) return { num1: n1, num2: n2, operator1: '+', answer: n1 + n2, unknownPosition: 'res' };
            return getUnknownProps(n1, n2, '+', maxNum, allowUnknown);
        }

        // Basic Subtraction (A - B = C)
        function generateBasicSub(maxNum, allowUnknown) {
            let n1 = rand(10, maxNum);
            let n2 = rand(1, n1 - 1);
            if (!allowUnknown) return { num1: n1, num2: n2, operator1: '-', answer: n1 - n2, unknownPosition: 'res' };
            return getUnknownProps(n1, n2, '-', maxNum, allowUnknown);
        }
        
        // Helper for Unknown Position Generation
        function getUnknownProps(n1, n2, op, maxNum, allowUnknown) {
            let answer = op === '+' ? n1 + n2 : n1 - n2;
            let unknownPosition = modeRandom(['n1', 'n2']);
            let result = answer; 
            
            if (!allowUnknown || unknownPosition === 'res') { // Should not happen if called correctly, but for safety
                return { num1: n1, num2: n2, operator1: op, answer: answer, unknownPosition: 'res' };
            }
            
            // Generate problem for the selected unknown position
            if (op === '+') { // A + B = C
                if (unknownPosition === 'n1') { // ? + B = C  -> ? = C - B
                    return { num1: null, num2: n2, operator1: op, answer: n1, unknownPosition: 'n1', calculatedResult: result };
                } else { // A + ? = C -> ? = C - A
                    return { num1: n1, num2: null, operator1: op, answer: n2, unknownPosition: 'n2', calculatedResult: result };
                }
            } else { // A - B = C
                if (unknownPosition === 'n1') { // ? - B = C -> ? = C + B
                    return { num1: null, num2: n2, operator1: op, answer: n1, unknownPosition: 'n1', calculatedResult: result };
                } else { // A - ? = C -> ? = A - C
                    return { num1: n1, num2: null, operator1: op, answer: n2, unknownPosition: 'n2', calculatedResult: result };
                }
            }
        }
        
        // CouShi (Making Ten: A + B = C, where A+B > 10)
        function generateCouShi(maxNum, allowUnknown) {
            let n1, n2;
            let attempts = 0;
            do {
                n1 = rand(6, 9); // Big number 6-9
                n2 = rand(2, 9); // Small number 2-9
                attempts++;
                if (attempts > 50) throw new Error('Failed CouShi gen');
            } while (n1 + n2 <= 10 || n1 + n2 > maxNum); 
            
            const res = n1 + n2;
            let problem = { num1: n1, num2: n2, operator1: '+', answer: res, unknownPosition: 'res' };

            if (allowUnknown && Math.random() < 0.4) {
                // Keep the property of CouShi (A+B > 10)
                if (Math.random() < 0.5) { // ? + B = C (n1)
                    let n1_calc = res - n2;
                    if (n1_calc < 1 || n1_calc + n2 <= 10) throw new Error('Retry CouShi n1 calc');
                    problem = { ...problem, answer: n1_calc, unknownPosition: 'n1' };
                } else { // A + ? = C (n2)
                    let n2_calc = res - n1;
                    if (n2_calc < 1 || n1 + n2_calc <= 10) throw new Error('Retry CouShi n2 calc');
                    problem = { ...problem, answer: n2_calc, unknownPosition: 'n2' };
                }
            }
            return problem;
        }

        // JieShi (A - B = C, where A <= 20, B > A%10)
        function generateJieShi(maxNum, allowUnknown) {
            let n1; // ä¿®æ­£: æ’é™¤ 10, 20 (ä¸ç ´å) ç¡®ä¿å¿…é¡»ä½¿ç”¨å€Ÿåæ³•
            do {
                n1 = rand(11, Math.min(maxNum, 20)); // Max num is 20
            } while (n1 % 10 === 0);
            let uD = n1 % 10;
            if (uD === 0) throw new Error('Retry JieShi uD'); // n2 å¿…é¡»æ˜¯å•æ•°ä¸”å¤§äº n1 çš„ä¸ªä½æ•° (å¼ºåˆ¶ç ´å)
            let n2 = rand(uD + 1, 9);
            if (n1 - n2 < 1) throw new Error('Retry JieShi res');
            const res = n1 - n2;
            let problem = { num1: n1, num2: n2, operator1: '-', answer: res, unknownPosition: 'res' };

            if (allowUnknown && Math.random() < 0.4) {
                // Keep the property of JieShi (B > A%10)
                if (Math.random() < 0.5) { // ? - B = C (n1)
                    let n1_calc = res + n2;
                    if (n1_calc > maxNum || n1_calc % 10 >= n2) throw new Error('Retry JieShi n1 calc'); // Check property: new n1 must break ten
                    problem = { ...problem, answer: n1_calc, unknownPosition: 'n1' };
                } else { // A - ? = C (n2)
                    let n2_calc = n1 - res;
                    if (n2_calc < 1 || n2_calc > n1 || n2_calc <= n1 % 10) throw new Error('Retry JieShi n2 calc'); // Check property: new n2 must be > n1%10
                    problem = { ...problem, answer: n2_calc, unknownPosition: 'n2' };
                }
            }
            return problem;
        }

        // PingShi (A - B = C, where A <= 20, B > A%10)
        function generatePingShi(maxNum, allowUnknown) {
             // PingShi is the same as JieShi in generation logic, just different hint steps
             let problem = generateJieShi(maxNum, allowUnknown);
             problem.specificMode = 'pingShi';
             return problem;
        }

        // NoCarryAdd (A + B = C, where A%10 + B%10 <= 9)
        function generateNoCarryAdd(maxNum, allowUnknown) {
             let n1, n2, res;
            let attempts = 0;
            do {
                let n1Unit = rand(0, 9);
                let n2Unit = rand(0, 9 - n1Unit); // Must not carry
                let n1Ten = rand(0, Math.floor(maxNum / 10));
                let n2Ten = rand(0, Math.floor(maxNum / 10) - n1Ten);
                
                n1 = n1Ten * 10 + n1Unit;
                n2 = n2Ten * 10 + n2Unit;
                res = n1 + n2;

                attempts++;
                if (attempts > 50) throw new Error('Failed NoCarryAdd gen');
            } while (res > maxNum || n1 < 1 || n2 < 1);
            
            let problem = { num1: n1, num2: n2, operator1: '+', answer: res, unknownPosition: 'res' };

            if (allowUnknown && Math.random() < 0.4) {
                if (Math.random() < 0.5) { // ? + B = C (n1)
                    let n1_calc = res - n2;
                    if (n1_calc < 1 || (n1_calc % 10) + (n2 % 10) > 9) throw new Error('Retry NoCarryAdd n1 calc');
                    problem = { ...problem, answer: n1_calc, unknownPosition: 'n1' };
                } else { // A + ? = C (n2)
                    let n2_calc = res - n1;
                    if (n2_calc < 1 || (n1 % 10) + (n2_calc % 10) > 9) throw new Error('Retry NoCarryAdd n2 calc');
                    problem = { ...problem, answer: n2_calc, unknownPosition: 'n2' };
                }
            }
            return problem;
        }

        // NoBreakSub (A - B = C, where A%10 >= B%10)
        function generateNoBreakSub(maxNum, allowUnknown) {
            let n1, n2, res;
            let attempts = 0;
            do {
                let n1Unit = rand(1, 9);
                let n2Unit = rand(0, n1Unit); // Must not break ten
                let n1Ten = rand(1, Math.floor(maxNum / 10));
                let n2Ten = rand(0, n1Ten - 1);
                
                n1 = n1Ten * 10 + n1Unit;
                n2 = n2Ten * 10 + n2Unit;
                res = n1 - n2;

                attempts++;
                if (attempts > 50) throw new Error('Failed NoBreakSub gen');
            } while (n1 < 10 || n2 < 1 || res < 1);
            
            let problem = { num1: n1, num2: n2, operator1: '-', answer: res, unknownPosition: 'res' };

            if (allowUnknown && Math.random() < 0.4) {
                if (Math.random() < 0.5) { // ? - B = C (n1)
                    let n1_calc = res + n2;
                    if (n1_calc > maxNum || (n2 % 10) > (n1_calc % 10)) throw new Error('Retry NoBreakSub n1 calc'); // Check property: B%10 <= new n1%10
                    problem = { ...problem, answer: n1_calc, unknownPosition: 'n1' };
                } else { // A - ? = C (n2)
                    let n2_calc = n1 - res;
                    if (n2_calc < 1 || (n2_calc % 10) > (n1 % 10)) throw new Error('Retry NoBreakSub n2 calc'); // Check property: new n2%10 <= n1%10
                    problem = { ...problem, answer: n2_calc, unknownPosition: 'n2' };
                }
            }
            return problem;
        }
        
        // Continuous Operation (A op B op C = D)
        function generateContinuous(maxNum) {
            const op1 = modeRandom(['+', '-']);
            const n1 = rand(10, maxNum - 5);
            const n2Range = op1 === '+' ? (maxNum - n1) : (n1 - 1);
            if (n2Range < 1) throw new Error('Retry continuous');
            const n2 = rand(1, n2Range);
            const iR = op1 === '+' ? n1 + n2 : n1 - n2;
            const op2 = modeRandom(['+', '-']);
            let n3, res;
            if (op2 === '+') {
                n3 = rand(1, maxNum - iR);
                res = iR + n3;
            } else {
                n3 = rand(1, iR - 1);
                res = iR - n3;
            }
            if (res < 1 || res > maxNum) throw new Error('Retry continuous');

            return { num1: n1, num2: n2, operator1: op1, num3: n3, operator2: op2, answer: res, unknownPosition: 'res', specificMode: 'continuous' };
        }

        // Mixed mode: picks a sub-generator function
        function generateMixed(maxNum, allowUnknown) {
            const subModes = ['couShi', 'jieShi', 'noBreakSub', 'noCarryAdd', 'basicAdd', 'basicSub'];
            let mode;
            let problem;
            for (let i = 0; i < 10; i++) {
                try {
                    mode = modeRandom(subModes);
                    if (mode === 'basicAdd') problem = generateBasicAdd(maxNum, allowUnknown);
                    else if (mode === 'basicSub') problem = generateBasicSub(maxNum, allowUnknown);
                    else if (mode === 'couShi') problem = generateCouShi(maxNum, allowUnknown);
                    else if (mode === 'jieShi') problem = generateJieShi(maxNum, allowUnknown);
                    else if (mode === 'noBreakSub') problem = generateNoBreakSub(maxNum, allowUnknown);
                    else if (mode === 'noCarryAdd') problem = generateNoCarryAdd(maxNum, allowUnknown);
                    
                    // Final validation
                    if (problem && problem.answer >= 0 && problem.answer <= maxNum && (problem.num3 === null || problem.answer <= maxNum)) {
                        problem.specificMode = mode;
                        return problem;
                    } else {
                        throw new Error('Mixed problem failed range check');
                    }
                } catch (e) {
                    // Ignore and try again
                }
            }
            return generateBasicAdd(maxNum, allowUnknown); // Final fallback
        }


        // Tie to a specific generator for non-mixed/exam modes
        const getGenerator = (mode) => {
            if (mode === 'add') return generateBasicAdd;
            if (mode === 'sub') return generateBasicSub;
            if (mode === 'mixed') return generateMixed;
            if (mode === 'couShi') return generateCouShi;
            if (mode === 'jieShi') return generateJieShi;
            if (mode === 'pingShi') return generatePingShi;
            if (mode === 'noCarryAdd') return generateNoCarryAdd;
            if (mode === 'noBreakSub') return generateNoBreakSub;
            if (mode === 'continuous') return generateContinuous;
            if (mode === 'exam') return generateMixed; // Handled by examProblems array
            return generateBasicAdd;
        };


        // --- æ ¸å¿ƒé€»è¾‘ (ä¿æŒä¸å˜) ---
        function generateProblem(shouldFocus = true) {
            let generatorMode = currentMode;
            if (isExamMode) {
                if (examCurrentQuestion >= EXAM_TOTAL_QUESTIONS) {
                    showExamReport();
                    return;
                }
                currentProblem = examProblems[examCurrentQuestion];
                generatorMode = currentProblem.specificMode;
            } else {
                let generatedSuccessfully = false;
                const generatorFn = getGenerator(generatorMode);
                
                let maxAttempts = MAX_GENERATION_ATTEMPTS;
                let allowUnknown = Math.random() < 0.2; // 20% chance of an unknown position
                
                try {
                    while (!generatedSuccessfully && maxAttempts-- > 0) {
                        currentProblem = generatorFn(maxNum, allowUnknown);
                        currentProblem.specificMode = generatorMode;
                        if (currentProblem.num3 !== null && currentProblem.num3 !== undefined) {
                            mathProbDispEl.classList.add('three-op');
                        } else {
                            mathProbDispEl.classList.remove('three-op');
                        }
                        if (currentProblem.num1 !== null && currentProblem.num2 !== null && currentProblem.answer !== null && currentProblem.answer >= 0 && (currentProblem.num3 === null || currentProblem.answer <= maxNum)) {
                            generatedSuccessfully = true;
                        } else {
                            throw new Error('Problem properties invalid or out of range');
                        }
                    }
                    if (!generatedSuccessfully) {
                        throw new Error('Max attempts reached');
                    }
                } catch (error) {
                    currentProblem = { num1: 15, num2: 8, operator1: '-', num3: null, operator2: null, answer: 7, unknownPosition: 'res', specificMode: generatorMode };
                }
            }
            
            const { num1, num2, operator1, num3, operator2, answer, unknownPosition, specificMode } = currentProblem; 

            // --- Display Logic (Unified and updated for n1) ---
            let n1_display = num1, n2_display = num2, result_display;
            if (num3 !== null && num3 !== undefined) {
                 // For continuous ops, result is displayed later
                 result_display = '?';
                 // If an unknown position is used in continuous ops, it would be complex, so we skip it for now and only show res=?
                 n1_display = num1; n2_display = num2; // No unknowns in continuous for now
            } else if (unknownPosition === 'res') {
                result_display = '?';
            } else {
                const resultC = num1 + (operator1 === '+' ? num2 : -num2);
                result_display = resultC;
                if (unknownPosition === 'n1') {
                    n1_display = '?';
                } else if (unknownPosition === 'n2') {
                    n2_display = '?';
                }
            }

            n1El.textContent = n1_display;
            op1El.textContent = operator1;
            n2El.textContent = n2_display;
            
            if (num3 !== null && num3 !== undefined) {
                op2El.textContent = operator2;
                n3El.textContent = num3;
                equalsSignEl.textContent = '='; 
                resultDisplayEl.textContent = result_display;
            } else {
                op2El.textContent = ''; 
                n3El.textContent = ''; 
                equalsSignEl.textContent = '='; 
                resultDisplayEl.textContent = result_display;
            }

            ansInput.value = ''; 
            if (shouldFocus) ansInput.focus();
            
            if (isExamMode) { 
                feedbackEl.textContent = `è€ƒè¯•è¿›åº¦: ç¬¬ ${examCurrentQuestion + 1} / ${EXAM_TOTAL_QUESTIONS} é¢˜`; 
            } else if (!feedbackEl.textContent.includes('å›ç­”æ­£ç¡®') && !feedbackEl.textContent.includes('é”™äº†')) { 
                feedbackEl.textContent = ''; 
            }
        }
        
        // --- Hint Step Generation Helpers (ä¿æŒä¸å˜) ---
        function getBasicSteps(n1, n2, op, res, title) { 
            // ... (Function content remains the same)
             const [n1Red, n2Red, resRed] = [numRedSpan(n1), numRedSpan(n2), numRedSpan(res)];
             let t = `ğŸ”° ${title}`;
             let s = `<div class="modal-step">${stepContent('æ­¥éª¤ 1: ç›´æ¥è®¡ç®—', `ï¼šğŸ˜„ ç›´æ¥è®¡ç®— ${n1Red} ${op} ${n2Red}ï¼Œå¾—åˆ°ç­”æ¡ˆ ${resRed}ã€‚`)}</div>`;
             const formulaHTML = `<span class="formula">${n1Red} ${opRedSpan(op)} ${n2Red} ${opRedSpan('=')} ${resRed}</span>`;
             return { title: t, stepsHTML: s, formula: formulaHTML };
        }

        // åŒä½ç›¸åŠ æ³• (ä¸è¿›ä½) æ­¥éª¤
        function getNoCarryAddSteps(n1, n2, res) {
            const u1 = n1 % 10, u2 = n2 % 10, t1 = Math.floor(n1 / 10), t2 = Math.floor(n2 / 10);
            const uSum = u1 + u2; const tRes = t1 + t2; 
            const [t1Span, t2Span] = [numSpan(t1, 'highlight-remain'), numSpan(t2, 'highlight-remain')];
            const [u1Span, u2Span] = [numSpan(u1, 'highlight-ten'), numSpan(u2, 'highlight-ten')];
            const [n1Red, n2Red, resRed] = [numRedSpan(n1), numRedSpan(n2), numRedSpan(res)];
            let t = 'â• åŒä½ç›¸åŠ æ³• (ä¸è¿›ä½)';
            let s = `<div class="modal-step">${stepContent('æ­¥éª¤ 1: ä¸ªä½åŠ ä¸ªä½', `ï¼šğŸ’ª ä¸ªä½ä¸Šçš„ ${u1Span} åŠ ä¸Š ${u2Span}ï¼Œå¾—åˆ° ${numSpan(uSum, 'highlight-goal')}ã€‚`)}</div>`;
            if (t1 > 0 || t2 > 0) {
                 s += `<div class="modal-step">${stepContent('æ­¥éª¤ 2: åä½åŠ åä½', `ï¼šğŸ§  åä½ä¸Šçš„ ${t1Span} åŠ ä¸Š ${t2Span}ï¼Œå¾—åˆ° ${numSpan(tRes, 'highlight-goal')}ã€‚`)}</div>`;
            }
            const formulaHTML = `<span class="formula">${n1Red} ${opRedSpan('+')} ${n2Red} ${opRedSpan('=')} ${resRed}</span>`;
            return { title: t, stepsHTML: s, formula: formulaHTML };
        } 
        
        // å‡‘åæ³•æ­¥éª¤
        function getCouShiSteps(n1, n2, res) {
            const big = Math.max(n1, n2); const small = Math.min(n1, n2);
            const bigUnit = big % 10, need = 10 - bigUnit, rem = small - need;
            const [needSpan, remSpan] = [numSpan(need, 'highlight-ten'), numSpan(rem, 'highlight-remain')];
            const [bigSpan, smallSpan] = [numSpan(big, 'highlight-goal'), numSpan(small, 'highlight-ten')];
            const nextTen = numSpan(big + need, 'highlight-goal');
            const [n1Red, n2Red, resRed] = [numRedSpan(n1), numRedSpan(n2), numRedSpan(res)];

            let t = 'ğŸ¯ å‡‘åæ³•';
            let s = `<div class="modal-step">${stepContent('æ­¥éª¤ 1: æ‹†åˆ†å°åŠ æ•°', `ï¼šğŸ§  å°† ${smallSpan} æ‹†åˆ†æˆ ${needSpan} (å‡‘åéœ€è¦çš„) å’Œ ${remSpan} (å‰©ä¸‹çš„)ã€‚`)}</div>`;
            s += `<div class="modal-step">${stepContent('æ­¥éª¤ 2: å‡‘æˆå', `ï¼šğŸ’ª ç”¨ ${bigSpan} åŠ ä¸Š ${needSpan}ï¼Œå…ˆå‡‘æˆ ${nextTen}ã€‚`)}</div>`;
            s += `<div class="modal-step">${stepContent('æ­¥éª¤ 3: åŠ ä¸Šå‰©ä½™æ•°', `ï¼šğŸ¥³ æœ€åç”¨ ${nextTen} åŠ ä¸Šå‰©ä¸‹çš„ ${remSpan}ï¼Œå¾—åˆ° ${resRed}ã€‚`)}</div>`;
            const formulaHTML = `<span class="formula">${n1Red} ${opRedSpan('+')} ${n2Red} ${opRedSpan('=')} ${resRed}</span>`;
            return { title: t, stepsHTML: s, formula: formulaHTML };
        }
        
        // åŒä½ç›¸å‡æ³• (ä¸ç ´å) æ­¥éª¤
        function getNoBreakSubSteps(n1, n2, res) {
            const u1 = n1 % 10, u2 = n2 % 10, t1 = Math.floor(n1 / 10), t2 = Math.floor(n2 / 10);
            const uRes = u1 - u2; const tRes = t1 - t2; 
            const [t1Span, t2Span] = [numSpan(t1, 'highlight-remain'), numSpan(t2, 'highlight-remain')];
            const [u1Span, u2Span] = [numSpan(u1, 'highlight-ten'), numSpan(u2, 'highlight-ten')];
            const [n1Red, n2Red, resRed] = [numRedSpan(n1), numRedSpan(n2), numRedSpan(res)];
            let t = 'â– åŒä½ç›¸å‡æ³• (ä¸ç ´å)';
            let s = `<div class="modal-step">${stepContent('æ­¥éª¤ 1: ä¸ªä½å‡ä¸ªä½', `ï¼šğŸ’ª ä¸ªä½ä¸Šçš„ ${u1Span} å‡å» ${u2Span}ï¼Œå¾—åˆ° ${numSpan(uRes, 'highlight-goal')}ã€‚`)}</div>`;
            if (t1 > 0 || t2 > 0) {
                 s += `<div class="modal-step">${stepContent('æ­¥éª¤ 2: åä½å‡åä½', `ï¼šğŸ§  åä½ä¸Šçš„ ${t1Span} å‡å» ${t2Span}ï¼Œå¾—åˆ° ${numSpan(tRes, 'highlight-goal')}ã€‚`)}</div>`;
            }
            const formulaHTML = `<span class="formula">${n1Red} ${opRedSpan('-')} ${n2Red} ${opRedSpan('=')} ${resRed}</span>`;
            return { title: t, stepsHTML: s, formula: formulaHTML };
        }
        
        // å€Ÿåæ³• (ç ´åæ³•, 20ä»¥å†…) æ­¥éª¤
        function getJieShiSteps(n1, n2, res) {
            const u1 = n1 % 10;
            const tMinusN2 = 10 - n2;
            const [u1Span, tMinusN2Span] = [numSpan(u1, 'highlight-remain'), numSpan(tMinusN2, 'highlight-goal')];
            const tSpan = numSpan(10, 'highlight-goal');
            const [n1Red, n2Red, resRed] = [numRedSpan(n1), numRedSpan(n2), numRedSpan(res)];

            let t = 'âš¡ å€Ÿåæ³• (ç ´åæ³•)';
            let s = `<div class="modal-step">${stepContent('æ­¥éª¤ 1: ä¸ªä½æ±‚åŠ©', `ï¼šğŸ˜Ÿ ${n1} çš„ä¸ªä½ (${u1Span}) å¤ªå°äº†ï¼Œå‡ä¸æ‰ ${n2Red}ï¼å‘åä½å€Ÿä¸€ä¸ª ${tSpan} æ¥å¸®å¿™ï¼`)}</div>`;
            s += `<div class="modal-step">${stepContent('æ­¥éª¤ 2: 10 å‡å»å‡æ•°', `ï¼šğŸ’ª å…ˆè®©å€Ÿæ¥çš„ ${tSpan} æ‰“è´¥ é‚£ä¸ª ${n2Red}ï¼Œå‰©ä¸‹ ${tMinusN2Span}ã€‚`)}</div>`;
            s += `<div class="modal-step">${stepContent('æ­¥éª¤ 3: åŠ ä¸Šä¸ªä½å‰©ä½™æ•°', `ï¼šğŸ¥³ æœ€åæŠŠå‰©ä¸‹çš„ ${tMinusN2Span} åŠ ä¸Šä¸ªä½åŸæ¥çš„ ${u1Span}ï¼Œå¾—åˆ° ${numSpan(tMinusN2 + u1, 'highlight-remain')}ï¼Œä¹Ÿå°±æ˜¯ç­”æ¡ˆ ${resRed}ã€‚`)}</div>`;
            const formulaHTML = `<span class="formula">${n1Red} ${opRedSpan('-')} ${n2Red} ${opRedSpan('=')} ${resRed}</span>`;
            return { title: t, stepsHTML: s, formula: formulaHTML };
        }

        // å¹³åæ³• (ç­‰åŒå€Ÿåæ³•ï¼Œåªæ˜¯æ­¥éª¤å±•ç¤ºä¸åŒ) æ­¥éª¤
        function getPingShiSteps(n1, n2, res) {
            const u1 = n1 % 10;
            const n2Split1 = u1; // å…ˆå‡åˆ° 10
            const n2Split2 = n2 - n2Split1; // å†å‡å‰©ä¸‹çš„
            const [n2Split1Span, n2Split2Span] = [numSpan(n2Split1, 'highlight-ten'), numSpan(n2Split2, 'highlight-remain')];
            const tenSpan = numSpan(10, 'highlight-goal');
            const [n1Red, n2Red, resRed] = [numRedSpan(n1), numRedSpan(n2), numRedSpan(res)];

            let t = 'ğŸ¯ å¹³åæ³•';
            let s = `<div class="modal-step">${stepContent('æ­¥éª¤ 1: æ‹†åˆ†å‡æ•°', `ï¼šğŸ§  å°† ${n2Red} æ‹†åˆ†æˆ ${n2Split1Span} (è®© ${n1Red} å‡åˆ° 10) å’Œ ${n2Split2Span} (å‰©ä¸‹çš„)ã€‚`)}</div>`;
            s += `<div class="modal-step">${stepContent('æ­¥éª¤ 2: å‡åˆ° 10', `ï¼šğŸ’ª å…ˆç®— ${n1Red} å‡å» ${n2Split1Span}ï¼Œå¾—åˆ° ${tenSpan}ã€‚`)}</div>`;
            s += `<div class="modal-step">${stepContent('æ­¥éª¤ 3: å†å‡å‰©ä½™æ•°', `ï¼šğŸ¥³ æœ€åç”¨ ${tenSpan} å‡å»å‰©ä¸‹çš„ ${n2Split2Span}ï¼Œå¾—åˆ° ${resRed}ã€‚`)}</div>`;
            const formulaHTML = `<span class="formula">${n1Red} ${opRedSpan('-')} ${n2Red} ${opRedSpan('=')} ${resRed}</span>`;
            return { title: t, stepsHTML: s, formula: formulaHTML };
        }

        // Addition Method Dispatcher
        function getAdditionMethod(n1, n2) {
            const res = n1 + n2;
            const isCarry = (n1 % 10) + (n2 % 10) > 9;
            
            if (isCarry && res <= 20) return { mode: 'couShi', func: getCouShiSteps };
            if (!isCarry) return { mode: 'noCarryAdd', func: getNoCarryAddSteps };

            return { mode: 'basic', func: (a, b, r) => getBasicSteps(a, b, '+', r, 'åŸºç¡€åŠ æ³•') };
        }

        // Subtraction Method Dispatcher
        function getSubtractionMethod(n1, n2) {
            const res = n1 - n2;
            const isBreakTen = n1 % 10 < n2 % 10;
            const isNoBreakSub = n1 % 10 >= n2 % 10;

            if (res < 0) return { mode: 'basic', func: (a, b, r) => getBasicSteps(a, b, '-', r, 'åŸºç¡€å‡æ³•') }; // Should not happen

            if (isNoBreakSub && n1 >= 10 && n2 >= 10) return { mode: 'noBreakSub', func: getNoBreakSubSteps };
            
            // ç”±äº maxNum=20, è¿™é‡Œåªå¯èƒ½æ˜¯ JieShi æˆ– PingShi
            if (isBreakTen && n1 <= 20) {
                 if (currentMode === 'pingShi') return { mode: 'pingShi', func: getPingShiSteps };
                 return { mode: 'jieShi', func: getJieShiSteps };
            }
            
            return { mode: 'basic', func: (a, b, r) => getBasicSteps(a, b, '-', r, 'åŸºç¡€å‡æ³•') };
        }


        // æç¤ºé€»è¾‘æ€»è°ƒåº¦
        function getSingleOpHintSteps(n1, n2, op, forcedMode = null, unknownPos = 'res') {
            const res = op === '+' ? n1 + n2 : n1 - n2;
            const effectiveMode = forcedMode || currentProblem.specificMode;
            let t = '', s = '', formulaHTML = '';
            let calculationDetails = {};

            // --- 1. æ±‚è§£æœªçŸ¥æ•°é€»è¾‘ (? op B = C) æˆ– (A op ? = C) ---
            if (unknownPos === 'n1' || unknownPos === 'n2') {
                const n1Known = unknownPos === 'n2' ? n1 : n2; // The known non-result number (A or B)
                const n2Answer = unknownPos === 'n2' ? n2 : n1; // The calculated unknown number (?=A or ?=B)
                const knownResult = n1Known + (op === '+' ? n2Answer : -n2Answer); // C (the result displayed)
                let subN1, subN2, conversionText, conversionOp;
                
                if (op === '+') { // A + B = C -> ? = C - B (å‡æ³•)
                    subN1 = knownResult; subN2 = n1Known; conversionOp = '-';
                    if (unknownPos === 'n1') {
                        t = 'ğŸ§® æ±‚è§£æœªçŸ¥åŠ æ•° (? = C - B)';
                        conversionText = `ï¼šğŸ” æœªçŸ¥æ•° (?) åŠ ä¸Š ${numRedSpan(n1Known)} ç­‰äº ${numRedSpan(knownResult)}ï¼Œæ‰€ä»¥æœªçŸ¥æ•° (?) ç­‰äº ${numRedSpan(knownResult)} **å‡å»** ${numRedSpan(n1Known)}ã€‚`;
                    } else { // unknownPos === 'n2'
                        t = 'ğŸ§® æ±‚è§£æœªçŸ¥åŠ æ•° (? = C - A)';
                        conversionText = `ï¼šğŸ” ${numRedSpan(n1Known)} åŠ ä¸ŠæœªçŸ¥æ•° (?) ç­‰äº ${numRedSpan(knownResult)}ï¼Œæ‰€ä»¥æœªçŸ¥æ•° (?) ç­‰äº ${numRedSpan(knownResult)} **å‡å»** ${numRedSpan(n1Known)}ã€‚`;
                    }
                    const { func: subFunc } = getSubtractionMethod(subN1, subN2);
                    calculationDetails = subFunc(subN1, subN2, subN1 - subN2);

                } else if (op === '-') { 
                    if (unknownPos === 'n1') { // ? - B = C -> ? = C + B (åŠ æ³•)
                        subN1 = knownResult; subN2 = n1Known; conversionOp = '+';
                        t = 'ğŸ§® æ±‚è§£æœªçŸ¥è¢«å‡æ•° (? = C + B)';
                        conversionText = `ï¼šğŸ” æœªçŸ¥æ•° (?) å‡å» ${numRedSpan(n1Known)} ç­‰äº ${numRedSpan(knownResult)}ï¼Œæ‰€ä»¥æœªçŸ¥æ•° (?) ç­‰äº ${numRedSpan(knownResult)} **åŠ ä¸Š** ${numRedSpan(n1Known)}ã€‚`;
                        const { func: addFunc } = getAdditionMethod(subN1, subN2);
                        calculationDetails = addFunc(subN1, subN2, subN1 + subN2);

                    } else { // A - ? = C -> ? = A - C (å‡æ³•)
                        subN1 = n1; subN2 = knownResult; conversionOp = '-';
                        t = 'ğŸ§® æ±‚è§£æœªçŸ¥å‡æ•° (? = A - C)';
                        conversionText = `ï¼šğŸ” ${numRedSpan(n1)} å‡å»æœªçŸ¥æ•° (?) ç­‰äº ${numRedSpan(knownResult)}ï¼Œæ‰€ä»¥æœªçŸ¥æ•° (?) ç­‰äº ${numRedSpan(n1)} **å‡å»** ${numRedSpan(knownResult)}ã€‚`;
                        const { func: subFunc } = getSubtractionMethod(subN1, subN2);
                        calculationDetails = subFunc(subN1, subN2, subN1 - subN2);
                    }
                }
                
                const calculationTitle = calculationDetails.title.replace(/[\u2728\u2559\u26a1\u25b6\u2796\s\u2705]/g, '').trim(); 
                // æ­¥éª¤ 1: å…³ç³»è½¬æ¢
                s = `<div class="modal-step">${stepContent('æ­¥éª¤ 1: å…³ç³»è½¬æ¢', conversionText.replace(/ï¼šğŸ”/, ''))}</div>`;
                // ã€ä¿®æ­£ã€‘å°†è½¬æ¢å…¬å¼ç›´æ¥æ’å…¥åˆ°æ­¥éª¤ 1 ä¹‹å
                const conversionFormula = `<span class="formula conversion-formula fade-start">${numRedSpan(unknownPos === 'n1' ? '?' : n1)} ${opRedSpan(op)} ${numRedSpan(unknownPos === 'n2' ? '?' : n2)} ${opRedSpan('=')} ${knownResult} ${opRedSpan('â†’')} ${numRedSpan('?')} ${opRedSpan('=')} ${numRedSpan(subN1)} ${opRedSpan(conversionOp)} ${numRedSpan(subN2)}</span>`;
                
                // æ­¥éª¤ 2: è®¡ç®—è½¬æ¢åçš„å¼å­
                s += `<div class="modal-step">${stepContent(`æ­¥éª¤ 2: ${calculationTitle}`, `ï¼šç°åœ¨é—®é¢˜å˜æˆäº† ${numRedSpan(subN1)} ${conversionOp} ${numRedSpan(subN2)}ï¼Œè¯·ä½¿ç”¨${calculationTitle}æ¥è®¡ç®—ã€‚`)}</div>`;
                s += calculationDetails.stepsHTML;
                
                // æœ€ç»ˆç»“æœå…¬å¼
                formulaHTML = calculationDetails.formula;
                formulaHTML = formulaHTML.replace(calculationDetails.formula, `<span class="formula fade-start" id="finalFormulaWrapper">${n1Red} ${opRedSpan(op)} ${n2Red} ${opRedSpan('=')} ${resRed}</span>`);

                return { title: t, stepsHTML: s, formula: formulaHTML };

            } else { // --- 2. ç›´æ¥è®¡ç®—é€»è¾‘ (res = A op B) ---
                if (op === '+') {
                    const { mode, func } = getAdditionMethod(n1, n2);
                    calculationDetails = func(n1, n2, res);
                } else if (op === '-') {
                    const { mode, func } = getSubtractionMethod(n1, n2);
                    calculationDetails = func(n1, n2, res);
                }
                
                return { title: calculationDetails.title, stepsHTML: calculationDetails.stepsHTML, formula: calculationDetails.formula };
            }

            // Fallback
            if (op === '+') return getBasicSteps(n1, n2, op, res, 'åŸºç¡€åŠ æ³•');
            if (op === '-') return getBasicSteps(n1, n2, op, res, 'åŸºç¡€å‡æ³•');
            return getBasicSteps(n1, n2, op, res);
        }

        // --- æ¨¡æ€æ¡†å’ŒæŠ¥å‘Šé€»è¾‘ (è°ƒæ•´è°ƒç”¨å‚æ•°) ---
        function generateHintSteps(problem, problemIndex = null) {
            const { num1, num2, operator1, num3, operator2, answer, unknownPosition, specificMode } = problem;
            let s = '', finalFormula = '';
            hintModal.style.display = 'block';
            hintVisuals.innerHTML = ''; // æ¸…ç©ºæ‰€æœ‰å¯è§†åŒ–å†…å®¹

            let vertN1 = num1, vertN2 = num2, vertOp = operator1, vertRes = answer;

            // --- 0. æ–°å¢ï¼šç«–å¼è®¡ç®—å¯è§†åŒ–é€»è¾‘ ---
            if (operator1 === '+' || operator1 === '-') {
                
                // é’ˆå¯¹æœªçŸ¥æ•°æƒ…å†µï¼Œå±•ç¤ºè®¡ç®—è¿‡ç¨‹çš„ç«–å¼ï¼ˆå³è½¬æ¢åçš„è¿ç®—ï¼‰
                if (unknownPosition === 'n1' || unknownPosition === 'n2') {
                    if (operator1 === '+') { // åŠ æ³•è½¬å‡æ³•: ? = C - B æˆ– ? = C - A
                        vertN1 = answer; // ç»“æœä½œä¸ºè¢«å‡æ•°
                        vertN2 = (unknownPosition === 'n1' ? num2 : num1); // å·²çŸ¥åŠ æ•°ä½œä¸ºå‡æ•°
                        vertOp = '-'; 
                        vertRes = answer - vertN2;
                    } else if (operator1 === '-') { // å‡æ³•
                        if (unknownPosition === 'n1') { // æ±‚è§£è¢«å‡æ•°: ? = C + B (åŠ æ³•)
                            vertN1 = answer; vertN2 = num2; vertOp = '+'; 
                            vertRes = answer + num2;
                        } else { // æ±‚è§£å‡æ•°: ? = A - C (å‡æ³•)
                            vertN1 = num1; vertN2 = answer; vertOp = '-'; 
                            vertRes = num1 - answer;
                        }
                    }
                }
                
                // ä»…å¯¹ 20 ä»¥å†…çš„å•æ­¥è¿ç®—å±•ç¤ºç«–å¼
                if (num3 === null && vertN1 <= 20 && vertN2 <= 20 && vertRes <= 20) {
                    hintVisuals.innerHTML += getVerticalCalcHTML(vertN1, vertN2, vertOp, vertRes);
                }
            }
            // --- ç»“æŸï¼šç«–å¼è®¡ç®—å¯è§†åŒ–é€»è¾‘ ---


            // --- 1. æ ¸å¿ƒç”»å›¾é€»è¾‘ (ä¿æŒä¸å˜) --- 
            if (num3 !== null && num3 !== undefined) {
                // ... (ä¿æŒä¸å˜)
            } else if (unknownPosition === 'n1' || unknownPosition === 'n2') {
                const n1Known = unknownPosition === 'n2' ? num1 : num2;
                const n2Answer = unknownPosition === 'n2' ? num2 : num1;
                const knownResult = n1Known + (operator1 === '+' ? n2Answer : -n2Answer);
                let subN1, subN2, visOp;

                if (operator1 === '-') {
                    if (unknownPosition === 'n1') { subN1 = knownResult; subN2 = n1Known; visOp = '+'; } 
                    else { subN1 = num1; subN2 = knownResult; visOp = '-'; }
                } else if (operator1 === '+') {
                    subN1 = knownResult; subN2 = n1Known; visOp = '-';
                }
                renderVisualHelpers(hintVisuals, subN1, subN2, visOp);
            } else {
                renderVisualHelpers(hintVisuals, num1, num2, operator1);
            }
            // --- ç»“æŸï¼šæ ¸å¿ƒç”»å›¾é€»è¾‘ ---

            // --- 2. æ­¥éª¤å’Œå…¬å¼ç”Ÿæˆ (æ›´æ–°ï¼šå¤„ç†è¿ç»­è¿ç®—) --- 
            if (num3 !== null && num3 !== undefined) {
                const iR = operator1 === '+' ? num1 + num2 : num1 - num2;
                const firstStepDetails = getSingleOpHintSteps(num1, num2, operator1, null, 'res');

                hintModalTitle.textContent = `ğŸ’¡ ç¬¬${problemIndex !== null ? problemIndex + 1 : 'å½“å‰'}é¢˜ - è¿ç»­è¿ç®—åˆ†æ­¥è§£æ`;
                
                // ç¬¬ä¸€æ­¥
                s += `<div class="modal-step">${stepContent('ç¬¬ 1 æ­¥è®¡ç®—', `ï¼šå…ˆè®¡ç®— ${num1} ${operator1} ${num2} = ${numSpan(iR, 'highlight-goal')}ï¼Œæ–¹æ³•ä¸º**${firstStepDetails.title.replace(/[^\u4e00-\u9fa5\u25b6\u2796]/g, '')}**ã€‚`)}</div>`;
                s += firstStepDetails.stepsHTML;
                
                // ç¬¬äºŒæ­¥
                const secondStepDetails = getSingleOpHintSteps(iR, num3, operator2, null, 'res');
                s += `<div class="modal-step" style="border-left-color: var(--color-apple-orange);">${stepContent('ç¬¬ 2 æ­¥è®¡ç®—', `ï¼šå†è®¡ç®— ${iR} ${operator2} ${num3} = ${numSpan(answer, 'highlight-goal')}ï¼Œæ–¹æ³•ä¸º**${secondStepDetails.title.replace(/[^\u4e00-\u9fa5\u25b6\u2796]/g, '')}**ã€‚`)}</div>`;
                s += secondStepDetails.stepsHTML;
                
                // æœ€ç»ˆç»“æœå…¬å¼
                finalFormula = `<span class="formula fade-start" id="finalFormulaWrapper">${num1} ${opRedSpan(operator1)} ${num2} ${opRedSpan(operator2)} ${num3} ${opRedSpan('=')} ${numRedSpan(answer)}</span>`;
                
            } else { // å•æ­¥è¿ç®—
                const details = getSingleOpHintSteps(num1, num2, operator1, specificMode, unknownPosition);
                hintModalTitle.textContent = `ğŸ’¡ ç¬¬${problemIndex !== null ? problemIndex + 1 : 'å½“å‰'}é¢˜ - ${details.title}`;
                s = details.stepsHTML;
                finalFormula = details.formula;
            }

            hintModalSteps.innerHTML = s + finalFormula;
            animateHintSteps();
        }

        function animateHintSteps() {
            // ... (ä¿æŒä¸å˜)
            const allItems = Array.from(hintModalSteps.querySelectorAll('.modal-step, .conversion-formula, .vertical-calc-wrapper'));
            const calculationFormulaWrapper = getElementByIdSafe('finalFormulaWrapper'); // è¿™é‡Œä¹Ÿéœ€è¦æ›´æ–°åŠ¨ç”»é€‰æ‹©å™¨
            
            // åˆå§‹åŒ–æ‰€æœ‰ item çš„åŠ¨ç”»çŠ¶æ€
            allItems.forEach(item => { 
                item.classList.add('fade-start'); 
                if (item.classList.contains('formula') || item.classList.contains('vertical-calc-wrapper')) { 
                    item.style.opacity = 0; 
                    item.style.transform = 'translateY(10px)'; 
                } 
            });

            // åŠ¨ç”»é¡ºåºæ’­æ”¾
            let totalDelay = 0;
            const delay = 450;
            allItems.forEach((item, index) => {
                totalDelay += delay;
                setTimeout(() => {
                    item.classList.remove('fade-start');
                    item.classList.add('fade-end');
                    item.style.opacity = 1;
                    item.style.transform = 'translateY(0)';
                }, 100 + index * delay);
            });

            // æœ€ç»ˆè®¡ç®—å…¬å¼æ·¡å…¥
            setTimeout(() => {
                calculationFormulaWrapper.classList.remove('fade-start');
                calculationFormulaWrapper.style.opacity = 1;
                calculationFormulaWrapper.style.transform = 'translateY(0)';
            }, 100 + allItems.length * delay + 200); // é¢å¤–çš„ 200ms å»¶è¿Ÿç¡®ä¿æœ€åä¸€æ­¥å®Œæˆ
        }

        // --- æ¨¡æ€æ¡†å’ŒæŠ¥å‘Šé€»è¾‘ (ä¿æŒä¸å˜) ---
        const closeHintModal = () => { hintModal.style.display = 'none'; };
        const closeExamModal = () => { examModal.style.display = 'none'; switchMode(modeSelect.value); };
        const showCurrentHint = () => { 
            if (isExamMode) { feedbackEl.textContent = 'è€ƒè¯•ä¸­ä¸èƒ½ä½¿ç”¨æç¤ºå“¦ï¼'; wrongFlash(); return; }
            generateHintSteps(currentProblem); 
        };
        const showProblemHint = (index) => { 
            const problemData = examProblems[index];
            currentProblem = problemData; 
            if (problemData) generateHintSteps(problemData, index); 
        };
        // ... (checkAnswer, showExamReport, skipProblem, generateReportImage, setButtonMode, event listeners ä¿æŒä¸å˜)
        function checkAnswer() {
            if (isSubmitting) return; 
            isSubmitting = true;
            const userAnswer = parseInt(ansInput.value.trim());

            if (isNaN(userAnswer)) {
                feedbackEl.textContent = 'âŒ è¯·è¾“å…¥ä¸€ä¸ªæ•°å­—ï¼';
                wrongFlash();
                isSubmitting = false;
                return;
            }

            const isCorrect = userAnswer === currentProblem.answer;

            if (isExamMode) {
                currentProblem.userAnswer = userAnswer;
                if (isCorrect) examCorrectAnswers++;
                examCurrentQuestion++;
                if (examCurrentQuestion < EXAM_TOTAL_QUESTIONS) {
                    feedbackEl.textContent = isCorrect ? 'âœ… å›ç­”æ­£ç¡®ï¼ä¸‹ä¸€é¢˜' : `âŒ é”™äº†ï¼Œæ­£ç¡®ç­”æ¡ˆæ˜¯ ${currentProblem.answer}`;
                    feedbackEl.className = isCorrect ? 'feedback-correct' : 'feedback-wrong';
                    setTimeout(() => {
                        feedbackEl.textContent = '';
                        feedbackEl.className = '';
                        generateProblem(true);
                        isSubmitting = false;
                    }, 1200);
                } else {
                    feedbackEl.textContent = isCorrect ? 'âœ… æœ€åä¸€é¢˜ï¼Œå›ç­”æ­£ç¡®ï¼' : `âŒ é”™äº†ï¼Œæ­£ç¡®ç­”æ¡ˆæ˜¯ ${currentProblem.answer}`;
                    feedbackEl.className = isCorrect ? 'feedback-correct' : 'feedback-wrong';
                    setTimeout(() => {
                        showExamReport();
                        isSubmitting = false;
                    }, 1500);
                }
                return;
            }

            // Normal mode
            totalCount++;
            if (isCorrect) {
                correctCount++;
                feedbackEl.textContent = 'âœ… å›ç­”æ­£ç¡®ï¼æ£’æäº†ï¼';
                feedbackEl.className = 'feedback-correct';
                vfx();
            } else {
                wrongCount++;
                feedbackEl.textContent = `âŒ é”™äº†ï¼Œæ­£ç¡®ç­”æ¡ˆæ˜¯ ${currentProblem.answer}`;
                feedbackEl.className = 'feedback-wrong';
                wrongFlash();
            }
            
            cCntEl.textContent = correctCount; 
            wCntEl.textContent = wrongCount; 
            tCntEl.textContent = totalCount;

            setTimeout(() => {
                if (isCorrect) {
                    feedbackEl.textContent = '';
                    feedbackEl.className = '';
                    generateProblem(true);
                }
                isSubmitting = false;
            }, isCorrect ? 500 : 1500); 
        }

        function showExamReport() {
            // Calculate score and summary
            const score = (examCorrectAnswers / EXAM_TOTAL_QUESTIONS) * 100;
            const wrongCount = EXAM_TOTAL_QUESTIONS - examCorrectAnswers;
            const examTime = new Date(); // Use current time as completion time

            // Get problem list HTML
            const problemListHTML = examProblems.map((p, index) => {
                const resultC = p.calculatedResult !== undefined ? p.calculatedResult : p.answer;
                let problemText = '';
                const correctAnswerDisplay = p.answer;

                if (p.num3 !== null) { // Continuous
                    problemText = `${index + 1}. ${p.num1} ${p.operator1} ${p.num2} ${p.operator2} ${p.num3} = ?`;
                } else if (p.unknownPosition === 'res') {
                    problemText = `${index + 1}. ${p.num1} ${p.operator1} ${p.num2} = ?`;
                } else if (p.unknownPosition === 'n1') {
                    problemText = `${index + 1}. ? ${p.operator1} ${p.num2} = ${resultC}`;
                } else if (p.unknownPosition === 'n2') {
                    problemText = `${index + 1}. ${p.num1} ${p.operator1} ? = ${resultC}`;
                }

                const isCorrect = p.userAnswer === p.answer;
                const [mark, markClass] = isCorrect ? ['âœ”ï¸', ''] : ['âŒ', 'mark-wrong'];
                const userAnswerDisplay = p.userAnswer === undefined || p.userAnswer === null || isNaN(p.userAnswer) ? '?' : p.userAnswer;
                const userAnswerColor = isCorrect ? 'var(--color-text-dark)' : 'var(--color-apple-red)';

                return `
                    <li class="problem-item">
                        <span class="problem-text">${problemText}</span>
                        <span class="user-answer-display" style="color: ${userAnswerColor};">${userAnswerDisplay}</span>
                        <span class="correct-answer-display">${!isCorrect ? `(æ­£: ${correctAnswerDisplay})` : ''}</span>
                        <div class="problem-mark-group">
                            ${!isCorrect ? `<button onclick="showProblemHint(${index});" class="btn-hint-review">ğŸ’¡</button>` : ''}
                            <span class="problem-mark ${markClass}" style="color: ${isCorrect ? 'var(--color-apple-green)' : 'var(--color-apple-red)'};">${mark}</span>
                        </div>
                    </li>`;
            }).join('');

            examReportContent.innerHTML = `
                <div class="exam-report-inner">
                    <div class="score-box">${score.toFixed(0)}</div>
                    <div class="report-header"><h3>å°å­¦ä¸€å¹´çº§æ•°å­¦æµ‹è¯•</h3></div>
                    <div class="info-row">
                        <div class="info-item">æ—¥æœŸ: <span>${examTime.toLocaleDateString()}</span></div>
                        <div class="info-item">ç”¨æ—¶: <span>--</span></div>
                        <div class="info-item">æ¨¡å¼: <span>æ··åˆä¸“é¡¹</span></div>
                    </div>
                    <div class="info-row" style="border-bottom: none;">
                        <div class="info-item">æ€»é¢˜æ•°: <span>${EXAM_TOTAL_QUESTIONS}</span></div>
                        <div class="info-item">æ­£ç¡®: <span style="color: var(--color-apple-green);">${examCorrectAnswers}</span></div>
                        <div class="info-item">é”™è¯¯: <span style="color: var(--color-apple-red);">${wrongCount}</span></div>
                    </div>
                    <ul class="problem-list">
                        ${problemListHTML}
                    </ul>
                    <div class="report-actions">
                        <button class="btn-primary" onclick="closeExamModal();">ç»§ç»­ç»ƒä¹ </button>
                        <button class="btn-download" onclick="generateReportImage();">ä¸‹è½½æˆç»©å•å›¾ç‰‡</button>
                    </div>
                </div>
            `;
            examModalTitle.textContent = score >= 90 ? 'ğŸ† æ­å–œä½ è·å¾—é«˜åˆ†!' : 'ğŸ‘ å†æ¥å†å‰ï¼';
            examModal.style.display = 'block';
        }

        function skipProblem() {
            feedbackEl.textContent = '';
            feedbackEl.className = '';
            generateProblem(false);
        }
        
        function setButtonMode() {
            const isMobile = window.matchMedia("(max-width: 600px)").matches;
            const btnTxt = newProbBtn.querySelector('.button-text');
            if (btnTxt) { newProbBtn.classList.toggle('icon-mode', !isMobile); btnTxt.style.display = isMobile ? 'inline-block' : 'none'; }
        }
        
        function generateReportImage() {
            const reportEl = getElementByIdSafe('examReportContent');
            if (typeof html2canvas === 'undefined' || !html2canvas) {
                alert('å›¾ç‰‡ç”Ÿæˆåº“åŠ è½½å¤±è´¥ã€‚');
                return;
            }

            const actionsDiv = reportEl.querySelector('.report-actions');
            actionsDiv.classList.add('hide-for-capture');

            html2canvas(reportEl, { 
                scale: 3, 
                useCORS: true, 
                backgroundColor: '#ffffff', 
                allowTaint: true, 
                removeContainer: true 
            }).then(canvas => {
                actionsDiv.classList.remove('hide-for-capture');
                const imgURL = canvas.toDataURL('image/png').replace('image/png', 'image/octet-stream');
                const a = document.createElement('a');
                a.href = imgURL;
                a.download = `æ•°å­¦æµ‹è¯•æŠ¥å‘Š-${new Date().toLocaleDateString()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });
        }


        // --- ç»‘å®šäº‹ä»¶ç›‘å¬å™¨ (ä¿æŒä¸å˜) ---
        submitBtn.addEventListener('click', checkAnswer); hintBtn.addEventListener('click', showCurrentHint);
        newProbBtn.addEventListener('click', skipProblem); 
        modeSelect.addEventListener('change', () => switchMode(modeSelect.value));
        hintModalClose.addEventListener('click', closeHintModal);
        examModalClose.addEventListener('click', closeExamModal);
        window.addEventListener('click', (e) => { if (e.target === hintModal) closeHintModal(); if (e.target === examModal) closeExamModal(); });
        ansInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); checkAnswer(); } });
        window.addEventListener('resize', setButtonMode); 
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = (new Date()).getTime(); if (now - lastTouchEnd <= 300) e.preventDefault(); lastTouchEnd = now;
        }, { passive: false });

        setButtonMode(); 
        switchMode(modeSelect.value || 'jieShi'); 
    </script>
</body>
</html>
