<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>åˆ˜ä¹¦è¯­çš„é­”æ³•æ•°å­¦ç‰¹è®­è¥</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ•°å­¦ç‰¹è®­è¥">

    <style>
        /* --- é€šç”¨æ ·å¼ (ä¿æŒä¸å˜) --- */
        * { touch-action: manipulation; box-sizing: border-box; }
        :root {
            --color-apple-blue: #007aff; --color-apple-green: #34c759;
            --color-apple-red: #ff3b30; --color-apple-orange: #ff9500;
            --color-background-soft: #f2f2f7; --color-card-bg: #f7f7f9;
            --color-text-dark: #1d1d1f; --color-button-secondary: #e5e5ea;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--color-background-soft); color: var(--color-text-dark);
            margin: 0; padding: 0; display: flex; justify-content: center;
            min-height: 100vh; padding-bottom: 20px; -webkit-text-size-adjust: 100%;
        }
        .container {
            width: 100%; max-width: 900px; background-color: #ffffff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); padding: 2vh 4vw;
            text-align: center; display: flex; flex-direction: column;
            align-items: center; min-height: 10vh;
        }
        .header-section { width: 100%; flex-shrink: 0; padding-top: 1vh; display: flex; flex-direction: column; align-items: center; }
        h1 { font-size: clamp(24px, 3.5vw, 32px); font-weight: 700; margin-bottom: 0.5vh; }
        .tagline { font-size: clamp(14px, 2vw, 16px); color: #555; margin-bottom: 1.5vh; }
        .mode-switch-group { width: 90%; max-width: 500px; margin-bottom: 2vh; }
        .mode-select {
            width: 100%; padding: 1.5vh 12px; font-size: clamp(14px, 2.2vw, 16px);
            border-radius: 10px; box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.08);
            appearance: none; -webkit-appearance: none; -moz-appearance: none; border: 1px solid #ccc;
        }
        .score-board {
            display: flex; justify-content: space-around; margin-top: 1vh; margin-bottom: 2.5vh;
            padding: 1.5vh 10px; background-color: var(--color-card-bg); border-radius: 12px;
            width: 80%; max-width: 500px;
        }
        .score-item { font-size: clamp(14px, 2.5vw, 16px); font-weight: 500; }
        .score-item span { color: var(--color-apple-blue); font-weight: 700; }
        .main-calculation-area {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            width: 100%; padding-top: 2vh; padding-bottom: 2vh; position: relative;
        }
        .math-problem {
            font-size: 11vw; font-weight: 800; margin: 1vh 0; min-height: 15vw;
            display: flex; justify-content: center; align-items: center; gap: 15px;
        }
        .math-problem.three-op { font-size: 8vw; }
        @media (max-width: 600px) {
            .math-problem { font-size: 15vw; gap: 10px; }
            .math-problem.three-op { font-size: 10vw; }
        }
        .input-wrapper {
            margin-top: 4vh; margin-bottom: 5vh; display: flex; flex-wrap: wrap;
            justify-content: center; gap: 10px; width: 100%; max-width: 400px;
        }
        #answerInput {
            padding: 2vh 15px; font-size: clamp(20px, 3.5vw, 24px); border-radius: 10px;
            margin-bottom: 10px; width: clamp(150px, 40vw, 200px); transition: all 0.2s;
            border: 1px solid #ccc; text-align: center;
        }
        .wrong-flash {
            border: 2px solid var(--color-apple-red) !important;
            box-shadow: 0 0 10px rgba(255, 59, 48, 0.5); animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        #newProblemButton {
            padding: 2vh 4vw; font-size: clamp(14px, 2.5vw, 16px); font-weight: 600;
            background-color: var(--color-button-secondary); color: var(--color-text-dark);
            border-radius: 10px; border: none; cursor: pointer; transition: opacity 0.2s, background-color 0.2s; flex-shrink: 0;
        }
        @media (min-width: 601px) {
            #newProblemButton.icon-mode {
                position: absolute; top: 50%; right: 5%; transform: translateY(-50%);
                padding: 10px; font-size: 20px; border-radius: 50%; width: 40px; height: 40px;
                display: flex; align-items: center; justify-content: center;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); opacity: 0.8; z-index: 10;
            }
            #newProblemButton .button-text { display: none; }
        }
        #submitButton, #hintButton {
            padding: 2vh 4vw; font-size: clamp(14px, 2.5vw, 16px); font-weight: 600;
            border-radius: 10px; border: none; cursor: pointer;
            transition: opacity 0.2s, background-color 0.2s; flex-shrink: 0;
        }
        #submitButton { background-color: var(--color-apple-blue); color: white; }
        #hintButton { background-color: var(--color-apple-orange); color: var(--color-text-dark); }

        #hintButton:disabled, #newProblemButton:disabled, #submitButton:disabled {
            opacity: 0.5; cursor: not-allowed;
        }

        @media (max-width: 600px) {
            .input-wrapper { flex-direction: column; align-items: center; padding: 0 5%; max-width: 100%; }
            #answerInput { width: 100%; max-width: 250px; }
            #submitButton, #hintButton, #newProblemButton {
                width: 100%; max-width: 250px; margin-bottom: 5px; position: static; transform: none; padding: 2vh 4vw;
            }
            #newProblemButton .button-text { display: inline-block; }
        }
        #feedback { font-size: clamp(18px, 3vw, 22px); font-weight: 700; color: var(--color-text-dark); min-height: 4vh; }
        .feedback-correct { color: var(--color-apple-red); } /* æ›´æ”¹ä¸ºçº¢è‰² */
        .feedback-wrong { color: var(--color-apple-red); }
        .vfx-container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 1px; height: 1px; pointer-events: none; overflow: visible; z-index: 50;
        }
        .correct-vfx {
            position: absolute; font-size: 20px; color: gold; text-shadow: 0 0 5px orange;
            animation: flyout 1s ease-out forwards; opacity: 0;
        }
        @keyframes flyout {
            0% { opacity: 1; transform: translate(0, 0) scale(1); }
            25% { opacity: 1; }
            100% { opacity: 0; transform: translate(var(--dx), var(--dy)) scale(0.5); }
        }

        /* --- æ¨¡æ€æ¡†é€šç”¨æ ·å¼ --- */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); overflow: auto;
        }
        #hintModal { z-index: 1050; }

        /* æ¨¡æ€æ¡†å†…å®¹æ ·å¼ */
        #examModal .modal-content, #hintModal .modal-content {
            background-color: #ffffff; margin: 5vh auto; padding: 3vh 4vw; border-radius: 20px;
            width: 95%; max-width: 700px; box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);
            animation: modalopen 0.4s ease-out; text-align: left;
            max-height: 90vh; overflow-y: auto; -webkit-overflow-scrolling: touch;
        }

        .modal-title { font-size: clamp(20px, 4vw, 26px); font-weight: 700; color: var(--color-text-dark); margin-bottom: 2vh; border-bottom: 2px solid #ddd; padding-bottom: 1vh; }
        .modal-close { float: right; font-size: clamp(24px, 5vw, 32px); font-weight: 300; cursor: pointer; color: #888; transition: color 0.2s; }

        /* --- å¯è§†åŒ–è¾…åŠ©ç”»å›¾æ ·å¼ (10æ ¼é˜µ) --- */
        .visual-container {
            margin: 15px 0;
            padding: 15px;
            background-color: #fcfcfc;
            border: 2px dashed #ddd;
            border-radius: 12px;
            display: grid; /* ä½¿ç”¨ Grid å¸ƒå±€ */
            grid-template-columns: repeat(10, 1fr); /* å¼ºåˆ¶ä¸€è¡Œ10ä¸ª */
            gap: 8px;
            justify-items: center; /* æ°´å¹³å±…ä¸­ */
            align-items: center; /* å‚ç›´å±…ä¸­ */
            max-width: 100%;
        }

        /* æ¯ä¸ªå°ç‰©å“çš„æ ·å¼ */
        .visual-item {
            width: 32px; height: 32px;
            font-size: 20px;
            display: flex; align-items: center; justify-content: center;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #eee;
            transition: all 0.3s;
        }

        /* æ‰‹æœºç«¯é€‚é…ï¼šç¼©å°å›¾æ ‡ */
        @media (max-width: 500px) {
            .visual-container { gap: 4px; padding: 10px 5px; }
            .visual-item { width: 24px; height: 24px; font-size: 14px; }
        }

        /* å‡æ³•è¢«å‡æ‰çš„æ ·å¼ */
        .is-subtracted {
            opacity: 0.25;
            filter: grayscale(100%);
            transform: scale(0.8);
            text-decoration: line-through;
            background-color: #f5f5f5;
        }

        .visual-legend {
            grid-column: 1 / -1; /* å æ»¡æ•´è¡Œ */
            font-size: 14px; color: #555; text-align: center; margin-top: 10px; font-weight: 600;
            border-top: 1px solid #eee;
            padding-top: 8px;
            width: 100%;
        }

        /* --- æç¤ºæ­¥éª¤æ ·å¼ --- */
        .modal-step {
            margin-bottom: 2vh;
            font-size: clamp(15px, 2.5vw, 18px);
            line-height: 1.6;
            padding-left: 10px;
            border-left: 4px solid var(--color-apple-blue);
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
        }
        .modal-step strong { display: block; margin-bottom: 0.5vh; font-weight: 800; }
        .modal-step.fade-start { opacity: 0; transform: translateY(10px); }
        .modal-step.fade-end { opacity: 1; transform: translateY(0); }

        /* å¼ºè°ƒè‰²å®šä¹‰ */
        .highlight-ten { color: var(--color-apple-orange); font-weight: 700; }
        .highlight-goal { color: var(--color-apple-green); font-weight: 700; }
        .highlight-remain { color: var(--color-apple-blue); font-weight: 700; }

        /* å…¬å¼æ ·å¼ä¼˜åŒ– */
        .formula {
            font-size: clamp(18px, 3.5vw, 24px); font-weight: 800; color: var(--color-text-dark);
            display: block; margin-top: 2vh; margin-bottom: 2vh; text-align: center;
            background-color: var(--color-card-bg); padding: 1.5vh; border-radius: 10px;
            letter-spacing: 1px; box-shadow: 0 0 3px rgba(0, 0, 0, 0.05);
            /* **æ–°å¢è¿‡æ¸¡æ•ˆæœ** */
            transition: opacity 0.5s ease-in, transform 0.5s ease-in;
            opacity: 1; /* é»˜è®¤å¯è§ */
        }
        /* **æ–°å¢ï¼šå…¬å¼åˆå§‹éšè—/æ·¡å…¥çŠ¶æ€** */
        .formula.fade-start {
            opacity: 0 !important;
            transform: translateY(10px);
        }

        .formula .op-red { color: var(--color-apple-red); }
        .formula .num-red { color: var(--color-apple-red); }

        /* **æ–°å¢ï¼šè½¬æ¢å…¬å¼çš„ç‰¹æ®Šæ ·å¼å’Œè¿‡æ¸¡ï¼ˆç”¨äºé¡ºåºå±•ç¤ºï¼‰** */
        .formula.conversion-formula {
            font-size: clamp(16px, 3vw, 20px);
            margin-top: 0.5vh;
            margin-bottom: 1.5vh;
            color: var(--color-apple-orange);
            background-color: #ffeccf; /* æµ…æ©™è‰²èƒŒæ™¯ */
            padding: 1vh;
        }


        @keyframes modalopen {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* --- æˆç»©å•æ ·å¼ --- */
        #examReportContent {
            padding-bottom: 20px; position: relative;
            background-color: #fff; border-radius: 15px; border: 2px solid #ccc;
        }
        .exam-report-inner { padding: 20px; }
        .report-header {
            text-align: center; margin-bottom: 20px; max-width: 90%; margin-left: auto; margin-right: auto;
        }
        .report-header h3 {
            font-size: 26px; font-weight: 800; color: var(--color-text-dark); margin: 0;
            border-bottom: 3px double #333; padding-bottom: 5px; white-space: nowrap;
        }
        .info-row {
            display: flex; justify-content: space-around; font-size: 16px;
            margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px dashed #ddd; width: 100%;
        }
        .info-item { flex: 1; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .info-item span { font-weight: 700; color: var(--color-apple-blue); }
        .score-box {
            position: absolute; top: 10px; right: 20px;
            width: 80px; height: 80px; border: 2px solid var(--color-apple-red);
            border-radius: 5px; display: flex; align-items: center; justify-content: center;
            font-size: 36px; font-weight: 800; color: var(--color-apple-red); line-height: 1;
        }
        .problem-list { margin-top: 10px; list-style: none; padding: 0; }
        .problem-item {
            display: grid; grid-template-columns: 2fr 1fr 1fr 50px; align-items: center;
            padding: 8px 0; border-bottom: 1px dotted #eee; font-size: 18px; gap: 5px;
        }
        .problem-text { font-weight: 500; color: var(--color-text-dark); text-align: left; }
        .user-answer-display { font-weight: 700; text-align: center; font-size: 16px; }
        .correct-answer-display { color: var(--color-apple-blue); font-weight: 700; font-size: 14px; text-align: center; }
        .problem-mark-group { display: flex; align-items: center; justify-content: flex-end; gap: 5px; }
        .btn-hint-review {
            background-color: var(--color-apple-orange); color: white; border: none; border-radius: 50%;
            width: 25px; height: 25px; font-size: 14px; line-height: 25px; padding: 0;
            cursor: pointer; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2); flex-shrink: 0;
        }
        .problem-mark { font-size: 36px; font-weight: 900; font-family: Arial, sans-serif; line-height: 1; flex-shrink: 0; }
        .report-actions { display: flex; justify-content: center; gap: 10px; margin-top: 30px; flex-wrap: wrap; }
        .report-actions button {
            padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;
            font-size: 16px; font-weight: 600; transition: background-color 0.2s;
        }
        .btn-primary { background-color: var(--color-apple-blue); color: white; }
        .btn-secondary { background-color: var(--color-apple-orange); color: white; }
        .btn-download { background-color: var(--color-apple-green); color: white; }
        .hide-for-capture { display: none; }


        /* å½»åº•ç»ˆç»“ç»¿è‰²å¯¹å·ï¼*/
        /* ç¡®ä¿æ­£ç¡®ç­”æ¡ˆæ ‡è®° (å¯¹å·) ä¸ºçº¢è‰² - ç»ˆæä¿®å¤ */
        .problem-mark,
        .problem-mark.mark-correct-red,
        .problem-mark.mark-wrong {
            color: #ff3b30 !important; /* ä½¿ç”¨ç›´æ¥çº¢è‰² Hex å€¼ */
            -webkit-text-fill-color: #ff3b30 !important; /* å¼ºåˆ¶ WebKit/iOS æµè§ˆå™¨æ¸²æŸ“é¢œè‰² */
            -webkit-text-stroke-width: 0 !important; /* æ¶ˆé™¤å¯èƒ½çš„æè¾¹ï¼Œç¡®ä¿çº¯è‰² */
        }

    </style>
</head>
<body>
<div class="container">
    <div class="header-section">
        <h1>ğŸ¥³ åˆ˜ä¹¦è¯­çš„é­”æ³•æ•°å­¦ç‰¹è®­è¥</h1>
        <p class="tagline">ğŸ¥‡ æˆä¸ºå…¨ç­æ•°å­¦å°å† å†›ï¼ (ä¸€å¹´çº§æ–¹æ³•ä¸“é¡¹ç»ƒä¹ )</p>
        <div class="mode-switch-group">
            <div class="select-wrapper">
                <select id="modeSelect" class="mode-select">
                    <optgroup label="åŸºç¡€è¿ç®—æ¨¡å¼">
                        <option value="add">åŸºç¡€åŠ æ³•</option>
                        <option value="sub">åŸºç¡€å‡æ³•</option>
                        <option value="mixed">æ··åˆç»ƒä¹ </option>
                        <option value="continuous">ğŸ”¥ è¿ç»­è¿ç®—</option>
                    </optgroup>
                    <optgroup label="ä¸“é¡¹æ–¹æ³•ç»ƒä¹ ">
                        <option value="noCarryAdd">ğŸ¯ åŒä½ç›¸åŠ æ³• (ä¸è¿›ä½)</option>
                        <option value="noBreakSub">ğŸ¯ åŒä½ç›¸å‡æ³• (ä¸ç ´å)</option>
                        <option value="couShi">ğŸ¯ å‡‘åæ³•</option>
                        <option value="jieShi" selected>ğŸ¯ å€Ÿåæ³•</option>
                        <option value="pingShi">ğŸ¯ å¹³åæ³•</option>
                    </optgroup>
                    <optgroup label="è€ƒè¯•ä¸æŒ‘æˆ˜">
                        <option value="exam">ğŸ’¯ 10é¢˜å¿«é€Ÿè€ƒè¯•</option>
                    </optgroup>
                </select>
            </div>
        </div>
        <div class="score-board">
            <div class="score-item">æ­£ç¡®: <span id="correctCount">0</span></div>
            <div class="score-item">é”™è¯¯: <span id="wrongCount">0</span></div>
            <div class="score-item">æ€»æ•°: <span id="totalCount">0</span></div>
        </div>
    </div>
    <div class="main-calculation-area">
        <div class="math-problem" id="mathProblemDisplay">
            <span id="number1"></span><span id="operator1" class="operator"></span>
            <span id="number2"></span><span id="operator2"></span>
            <span id="number3"></span><span id="equalsSign"></span><span id="resultDisplay"></span>
        </div>
        <div id="vfxContainer" class="vfx-container"></div>
        <button id="newProblemButton">ğŸ”„ <span class="button-text">æ¢é¢˜</span></button>
        <div class="input-wrapper">
            <input type="number" id="answerInput" placeholder="è¯·è¾“å…¥ç­”æ¡ˆ" inputmode="numeric">
            <button id="submitButton">æäº¤</button>
            <button id="hintButton">ğŸ’¡ æç¤º</button>
        </div>
    </div>
    <div id="feedback"></div>
</div>

<div id="examModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" id="examModalClose">&times;</span>
        <div id="examModalTitle" class="modal-title"></div>
        <div id="examReportContent"></div>
    </div>
</div>

<div id="hintModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" id="hintModalClose">&times;</span>
        <div id="hintVisuals"></div>
        <div id="hintModalSteps"></div>
    </div>
</div>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>
    // --- å˜é‡å’ŒçŠ¶æ€åˆå§‹åŒ– ---
    // **ä¿®æ­£ 1: å°† maxNum è®¾ç½®ä¸º 20**
    let currentProblem = { num1: 0, num2: 0, operator1: '+', num3: null, operator2: null, answer: 0, steps: [], unknownPosition: 'res', specificMode: null };
    let correctCount = 0, wrongCount = 0, totalCount = 0, maxNum = 20;
    let isExamMode = false; const EXAM_TOTAL_QUESTIONS = 10;
    let examCurrentQuestion = 0, examCorrectAnswers = 0;
    let examProblems = [];
    let isSubmitting = false;
    const MAX_GENERATION_ATTEMPTS = 50;
    let currentMode = 'jieShi';

    // è€ƒè¯•æ¨¡å¼ä¸‹çš„é¢˜å‹åˆ†å¸ƒ (5ä¸ªç±»å‹ï¼Œæ¯ä¸ª2é¢˜)
    const EXAM_MODES_DISTRIBUTION = [
        'couShi', 'couShi',
        'jieShi', 'jieShi',
        'noCarryAdd', 'noCarryAdd',
        'noBreakSub', 'noBreakSub',
        'continuous', 'continuous'
    ];

    // --- å…ƒç´  ID æŸ¥æ‰¾ ---
    function getElementByIdSafe(id) {
        const el = document.getElementById(id);
        if (!el) {
            console.error(`DOM Error: Element with ID "${id}" not found.`);
            return { textContent: '', classList: { add: () => {}, remove: () => {} }, style: {}, innerHTML: '' };
        }
        return el;
    }

    const [n1El, op1El, n2El, op2El, n3El, ansInput, submitBtn, hintBtn, newProbBtn, feedbackEl, cCntEl, wCntEl, tCntEl, modeSelect, vfxCont, mathProbDispEl, examModal, hintModal, equalsSignEl, resultDisplayEl] =
        ['number1', 'operator1', 'number2', 'operator2', 'number3', 'answerInput', 'submitButton', 'hintButton', 'newProblemButton', 'feedback', 'correctCount', 'wrongCount', 'totalCount', 'modeSelect', 'vfxContainer', 'mathProblemDisplay', 'examModal', 'hintModal', 'equalsSign', 'resultDisplay'].map(id => getElementByIdSafe(id));

    const [examModalClose, hintModalClose, examModalTitle, hintModalTitle, hintModalSteps, hintVisuals] =
        ['examModalClose', 'hintModalClose', 'examModalTitle', 'hintModalTitle', 'hintModalSteps', 'hintVisuals'].map(id => getElementByIdSafe(id));

    const examReportContent = getElementByIdSafe('examReportContent');

    // --- è¾…åŠ©å‡½æ•° ---
    function vfx() {
        vfxCont.innerHTML = '';
        for (let i = 0; i < 15; i++) {
            const v = document.createElement('div');
            v.className = 'correct-vfx'; v.textContent = 'â­';
            const angle = Math.random() * 2 * Math.PI;
            const distance = 80 + Math.random() * 50;
            v.style.setProperty('--dx', `${Math.cos(angle) * distance}px`);
            v.style.setProperty('--dy', `${Math.sin(angle) * distance}px`);
            v.style.transform = `translate(${(Math.random() - 0.5) * 20}px, ${(Math.random() - 0.5) * 20}px)`;
            vfxCont.appendChild(v);
            v.addEventListener('animationend', () => v.remove());
        }
    }
    function wrongFlash() {
        ansInput.classList.add('wrong-flash');
        setTimeout(() => ansInput.classList.remove('wrong-flash'), 500);
    }

    // --- Hint Styling Helpers ---
    const numSpan = (num, className) => `<span class="${className}">${num}</span>`;
    const opRedSpan = (op) => `<span class="op-red">${op}</span>`;
    const numRedSpan = (num) => `<span class="num-red">${num}</span>`;
    const parenRedSpan = (op) => `<span class="op-red">${op}</span>`;
    const stepContent = (title, content) => `<strong>${title}</strong>${content}`;

    // --- å¯è§†åŒ–ç”»å›¾å‡½æ•° (ä¿æŒä¸å˜) ---
    function renderVisualHelpers(container, n1, n2, op) {
        container.innerHTML = '';
        // **æ›´æ–°: å°†æœ€å¤§ç”»å›¾æ•°å­—ä» 30 æ›´æ”¹ä¸º 20**
        if (n1 > 20) {
            const msg = document.createElement('div');
            msg.className = 'visual-legend';
            msg.textContent = `(æ•°å­—è¾ƒå¤§ï¼Œæ­¤å¤„ä¸ç»˜åˆ¶è¯¦ç»†è‹¹æœå›¾)`;
            container.appendChild(msg);
            return;
        }

        const wrapper = document.createElement('div');
        wrapper.className = 'visual-container';

        const addItem = (type, isSubtracted = false) => {
            const item = document.createElement('div');
            item.className = 'visual-item';
            item.textContent = type === 'A' ? 'ğŸ' : 'ğŸ';
            if (isSubtracted) item.classList.add('is-subtracted');
            return item;
        };

        if (op === '+') {
            const total = n1 + n2;
            for (let i = 0; i < total; i++) {
                wrapper.appendChild(addItem(i < n1 ? 'A' : 'B'));
            }
            const legend = document.createElement('div');
            legend.className = 'visual-legend';
            legend.textContent = `ğŸ ${n1} ä¸ª + ğŸ ${n2} ä¸ª = ${total} ä¸ª`;
            wrapper.appendChild(legend);

        } else { // å‡æ³•
            for (let i = 0; i < n1; i++) {
                const isSubtracted = i >= (n1 - n2);
                wrapper.appendChild(addItem('A', isSubtracted));
            }
            const legend = document.createElement('div');
            legend.className = 'visual-legend';
            legend.textContent = `å…±æœ‰ ${n1} ä¸ª ğŸï¼Œæ‹¿èµ° ${n2} ä¸ªï¼Œè¿˜å‰© ${n1-n2} ä¸ª`;
            wrapper.appendChild(legend);
        }

        container.appendChild(wrapper);
    }

    // **æ–°å¢: è€ƒè¯•é—®é¢˜é¢„ç”Ÿæˆå‡½æ•°**
    function generateExamProblems() {
        examProblems = [];
        const maxAttemptsPerProblem = 10;
        const generatorMap = {
            'couShi': generateCouShi,
            'jieShi': generateJieShi,
            'noCarryAdd': generateNoCarryAdd,
            'noBreakSub': generateNoBreakSub,
            'continuous': generateContinuous,
            'mixed': generateMixed // Fallback
        };

        // éšæœºæ‰“ä¹±é¢˜å‹é¡ºåºï¼Œç¡®ä¿è€ƒè¯•é¡ºåºéšæœº
        const shuffledModes = [...EXAM_MODES_DISTRIBUTION].sort(() => Math.random() - 0.5);

        for (let i = 0; i < EXAM_TOTAL_QUESTIONS; i++) {
            let mode = shuffledModes[i];
            let problem = null;
            let attempts = 0;
            let generatedSuccessfully = false;

            // è€ƒè¯•æ¨¡å¼ä¸‹ï¼Œéšæœºåˆ†é…æœªçŸ¥æ•° (?) çš„ä½ç½® (20% æ¦‚ç‡)
            const allowUnknown = (Math.random() < 0.25) && (mode !== 'continuous');

            while (!generatedSuccessfully && attempts < maxAttemptsPerProblem) {
                attempts++;
                try {
                    const generatorFn = generatorMap[mode];
                    problem = generatorFn(maxNum, allowUnknown);
                    // ç¡®ä¿ç­”æ¡ˆå’Œæ•°å­—åœ¨ maxNum èŒƒå›´å†…
                    if (problem.answer >= 0 && problem.answer <= maxNum &&
                        (problem.num3 === null || (problem.num3 !== null && problem.answer <= maxNum)) ) {
                        generatedSuccessfully = true;
                        problem.specificMode = mode;
                    } else {
                        throw new Error('Generated problem failed range check');
                    }
                } catch (e) {
                    problem = null;
                }
            }

            // å¦‚æœç‰¹å®šé¢˜å‹ç”Ÿæˆå¤±è´¥ï¼Œé€€å›åˆ°æ··åˆç®€å•é¢˜
            if (!generatedSuccessfully) {
                problem = generateMixed(maxNum, false);
                problem.specificMode = 'mixed-fallback';
            }

            examProblems.push(problem);
        }
    }

    function switchMode(newMode) {
        currentMode = newMode;
        isExamMode = newMode === 'exam';

        if (isExamMode) {
            examCurrentQuestion = 0; examCorrectAnswers = 0;
            generateExamProblems(); // **NEW: é¢„ç”Ÿæˆè€ƒè¯•é¢˜ç›®**
            correctCount = 0; wrongCount = 0;
        } else if (modeSelect.value === 'exam') {
            correctCount = 0; wrongCount = 0; totalCount = 0;
        }

        modeSelect.value = newMode;
        cCntEl.textContent = correctCount; wCntEl.textContent = wrongCount; tCntEl.textContent = totalCount;
        newProbBtn.disabled = isExamMode;
        hintBtn.disabled = isExamMode;
        submitBtn.disabled = false;
        generateProblem(true);
        examModal.style.display = 'none';
    }

    // --- Core Generator Functions (A5 & A3 Implementation) ---
    const rand = (min, max) => min + Math.floor(Math.random() * (max - min + 1));
    const modeRandom = (arr) => arr[Math.floor(Math.random() * arr.length)];

    // Helper to determine unknown position (n1 or n2)
    function getUnknownProps(n1, n2, op1, maxNum, allowUnknown) {
        const res = op1 === '+' ? n1 + n2 : n1 - n2;
        let unknownPos = 'res';
        if (allowUnknown && n1 > 5 && n2 > 5 && Math.random() < 0.4) {
            if (Math.random() < 0.5) {
                unknownPos = 'n1'; // ? op B = C
            } else {
                unknownPos = 'n2'; // A op ? = C
            }
        }
        return { num1: n1, num2: n2, operator1: op1, answer: unknownPos === 'res' ? res : (unknownPos === 'n1' ? n1 : n2), unknownPosition: unknownPos };
    }

    // Basic Add (A + B = C)
    function generateBasicAdd(maxNum, allowUnknown) {
        let n1 = rand(1, Math.min(maxNum - 1, 15));
        let n2 = rand(1, maxNum - n1);
        if (!allowUnknown) return { num1: n1, num2: n2, operator1: '+', answer: n1 + n2, unknownPosition: 'res' };
        return getUnknownProps(n1, n2, '+', maxNum, allowUnknown);
    }

    // Basic Sub (A - B = C)
    function generateBasicSub(maxNum, allowUnknown) {
        let n1 = rand(10, maxNum);
        let n2 = rand(1, n1 - 1);
        if (!allowUnknown) return { num1: n1, num2: n2, operator1: '-', answer: n1 - n2, unknownPosition: 'res' };
        return getUnknownProps(n1, n2, '-', maxNum, allowUnknown);
    }

    // Continuous Operation (A op B op C = D)
    function generateContinuous(maxNum) {
        const op1 = modeRandom(['+', '-']);
        const n1 = rand(10, maxNum - 5);
        const n2Range = op1 === '+' ? (maxNum - n1) : (n1 - 1);
        if (n2Range < 1) throw new Error('Retry continuous');
        const n2 = rand(1, n2Range);
        const iR = op1 === '+' ? n1 + n2 : n1 - n2;

        const op2 = modeRandom(['+', '-']);
        let n3, res;
        if (op2 === '+') {
            n3 = rand(1, maxNum - iR); res = iR + n3;
        } else {
            n3 = rand(1, iR); res = iR - n3;
        }

        if (res < 0 || res > maxNum) throw new Error('Retry continuous range');
        return { num1: n1, num2: n2, operator1: op1, num3: n3, operator2: op2, answer: res, unknownPosition: 'res' };
    }

    // CouShi (A + B = C, where A+B > 10, A/B > 5)
    function generateCouShi(maxNum, allowUnknown) {
        let n1 = rand(7, Math.min(maxNum, 18)); // Big number
        let need = 10 - (n1 % 10);
        if (need <= 0 || need > 9) throw new Error('Retry CouShi need');
        let n2 = need + rand(1, 9 - need); // Small number that forces carry

        if (n1 + n2 > maxNum || n1 < 6 || n2 < 1) throw new Error('Retry CouShi range');

        const res = n1 + n2;
        let problem = { num1: n1, num2: n2, operator1: '+', answer: res, unknownPosition: 'res' };

        if (allowUnknown && Math.random() < 0.4) {
            // Unknown must maintain CouShi property ((A%10) + (B%10) > 9)
            if (Math.random() < 0.5) { // ? + B = C (n1)
                let n1_calc = res - n2;
                if (n1_calc < 1 || (n1_calc % 10) + (n2 % 10) <= 9) throw new Error('Retry CouShi n1 calc');
                problem = { ...problem, num1: n1_calc, answer: n1_calc, unknownPosition: 'n1' };
            } else { // A + ? = C (n2)
                let n2_calc = res - n1;
                if (n2_calc < 1 || (n1 % 10) + (n2_calc % 10) <= 9) throw new Error('Retry CouShi n2 calc');
                problem = { ...problem, answer: n2_calc, unknownPosition: 'n2' };
            }
        }
        return problem;
    }

    // JieShi (A - B = C, where A <= 20, B > A%10)
    function generateJieShi(maxNum, allowUnknown) {
        let n1;
        // ä¿®æ­£: æ’é™¤ 10, 20 (ä¸ç ´å) ç¡®ä¿å¿…é¡»ä½¿ç”¨å€Ÿåæ³•
        do {
            n1 = rand(11, Math.min(maxNum, 20)); // Max num is 20
        } while (n1 % 10 === 0);

        let uD = n1 % 10;
        if (uD === 0) throw new Error('Retry JieShi uD');

        // n2 å¿…é¡»æ˜¯å•æ•°ä¸”å¤§äº n1 çš„ä¸ªä½æ•° (å¼ºåˆ¶ç ´å)
        let n2 = rand(uD + 1, 9);

        if (n1 - n2 < 1) throw new Error('Retry JieShi res');

        const res = n1 - n2;
        let problem = { num1: n1, num2: n2, operator1: '-', answer: res, unknownPosition: 'res' };

        if (allowUnknown && Math.random() < 0.4) {
            // Unknown must maintain JieShi property (B%10 > A%10)
            if (Math.random() < 0.5) { // ? - B = C (n1)
                let n1_calc = res + n2;
                if (n1_calc > maxNum || n1_calc <= 10 || n2 > n1_calc % 10) throw new Error('Retry JieShi n1 calc');
                problem = { ...problem, num1: n1_calc, answer: n1_calc, unknownPosition: 'n1' };
            } else { // A - ? = C (n2)
                let n2_calc = n1 - res;
                if (n2_calc < 1 || n2_calc % 10 <= n1 % 10) throw new Error('Retry JieShi n2 calc');
                problem = { ...problem, answer: n2_calc, unknownPosition: 'n2' };
            }
        }
        return problem;
    }

    // JieShi (A - B = C, where A <= 20, B > A%10)
    function generatePingShi(maxNum, allowUnknown) {
        let n1;
        // ä¿®æ­£: æ’é™¤ 10, 20 (ä¸ç ´å) ç¡®ä¿å¿…é¡»ä½¿ç”¨å€Ÿåæ³•
        do {
            n1 = rand(11, Math.min(maxNum, 20)); // Max num is 20
        } while (n1 % 10 === 0);

        let uD = n1 % 10;
        if (uD === 0) throw new Error('Retry JieShi uD');

        // n2 å¿…é¡»æ˜¯å•æ•°ä¸”å¤§äº n1 çš„ä¸ªä½æ•° (å¼ºåˆ¶ç ´å)
        let n2 = rand(uD + 1, 9);

        if (n1 - n2 < 1) throw new Error('Retry JieShi res');

        const res = n1 - n2;
        let problem = { num1: n1, num2: n2, operator1: '-', answer: res, unknownPosition: 'res' };

        if (allowUnknown && Math.random() < 0.4) {
            // Unknown must maintain JieShi property (B%10 > A%10)
            if (Math.random() < 0.5) { // ? - B = C (n1)
                let n1_calc = res + n2;
                if (n1_calc > maxNum || n1_calc <= 10 || n2 > n1_calc % 10) throw new Error('Retry JieShi n1 calc');
                problem = { ...problem, num1: n1_calc, answer: n1_calc, unknownPosition: 'n1' };
            } else { // A - ? = C (n2)
                let n2_calc = n1 - res;
                if (n2_calc < 1 || n2_calc % 10 <= n1 % 10) throw new Error('Retry JieShi n2 calc');
                problem = { ...problem, answer: n2_calc, unknownPosition: 'n2' };
            }
        }
        return problem;
    }

    // NoBreakSub (A - B = C, where A > 10, B%10 <= A%10)
    function generateNoBreakSub(maxNum, allowUnknown) {
        let n1 = rand(11, maxNum);
        let u1_ = n1 % 10;

        let maxN2Unit = u1_;
        let n2Unit = rand(0, maxN2Unit);

        let n2Ten = rand(0, Math.floor(n1 / 10) - 1);
        let n2 = n2Ten * 10 + n2Unit;

        if (n2 < 1 || n2 >= n1) throw new Error('Retry NoBreakSub size');

        const res = n1 - n2;
        let problem = { num1: n1, num2: n2, operator1: '-', answer: res, unknownPosition: 'res' };

        if (allowUnknown && Math.random() < 0.4) {
            // Unknown must maintain NoBreakSub property (B%10 <= A%10)
            if (Math.random() < 0.5) { // ? - B = C (n1)
                let n1_calc = res + n2;
                if (n1_calc > maxNum || n2 % 10 > n1_calc % 10) throw new Error('Retry NoBreakSub n1 calc');
                problem = { ...problem, num1: n1_calc, answer: n1_calc, unknownPosition: 'n1' };
            } else { // A - ? = C (n2)
                let n2_calc = n1 - res;
                if (n2_calc < 1 || n2_calc % 10 > n1 % 10) throw new Error('Retry NoBreakSub n2 calc');
                problem = { ...problem, answer: n2_calc, unknownPosition: 'n2' };
            }
        }
        return problem;
    }

    // NoCarryAdd (A + B = C, where A%10 + B%10 <= 9)
    function generateNoCarryAdd(maxNum, allowUnknown) {
        let n1 = rand(10, Math.min(maxNum - 1, 15)); // Keep n1 reasonable for smaller maxNum
        let u1_ = n1 % 10;

        let maxN2Unit = 9 - u1_;
        let n2Unit = rand(0, maxN2Unit);

        let maxN2Ten = Math.floor((maxNum - n1) / 10);
        let n2Ten = rand(0, maxN2Ten) * 10;

        let n2 = n2Ten + n2Unit;
        if (n2 < 1) n2 = 1;
        if (n1 + n2 > maxNum) throw new Error('Retry NoCarryAdd range');

        const res = n1 + n2;
        let problem = { num1: n1, num2: n2, operator1: '+', answer: res, unknownPosition: 'res' };

        if (allowUnknown && Math.random() < 0.4) {
            // Unknown must maintain NoCarryAdd property (A%10 + B%10 <= 9)
            if (Math.random() < 0.5) { // ? + B = C (n1)
                let n1_calc = res - n2;
                if (n1_calc < 1 || (n1_calc % 10) + (n2 % 10) > 9) throw new Error('Retry NoCarryAdd n1 calc');
                problem = { ...problem, num1: n1_calc, answer: n1_calc, unknownPosition: 'n1' };
            } else { // A + ? = C (n2)
                let n2_calc = res - n1;
                if (n2_calc < 1 || (n1 % 10) + (n2_calc % 10) > 9) throw new Error('Retry NoCarryAdd n2 calc');
                problem = { ...problem, answer: n2_calc, unknownPosition: 'n2' };
            }
        }
        return problem;
    }

    // Mixed mode: picks a sub-generator
    function generateMixed(maxNum, allowUnknown) {
        const subModes = ['couShi', 'jieShi', 'noBreakSub', 'noCarryAdd', 'basicAdd', 'basicSub'];
        let mode;
        let problem;

        for (let i = 0; i < 10; i++) {
            try {
                mode = modeRandom(subModes);
                if (mode === 'basicAdd') problem = generateBasicAdd(maxNum, allowUnknown);
                else if (mode === 'basicSub') problem = generateBasicSub(maxNum, allowUnknown);
                else if (mode === 'couShi') problem = generateCouShi(maxNum, allowUnknown);
                else if (mode === 'jieShi') problem = generateJieShi(maxNum, allowUnknown);
                else if (mode === 'noBreakSub') problem = generateNoBreakSub(maxNum, allowUnknown);
                else if (mode === 'noCarryAdd') problem = generateNoCarryAdd(maxNum, allowUnknown);

                // Final validation
                if (problem && problem.answer >= 0 && problem.answer <= maxNum && (problem.num3 === null || problem.answer <= maxNum)) {
                    problem.specificMode = mode;
                    return problem;
                } else {
                    throw new Error('Mixed problem failed range check');
                }
            } catch (e) {
                // Ignore and try again
            }
        }
        return generateBasicAdd(maxNum, allowUnknown); // Final fallback
    }

    // Tie to a specific generator for non-mixed/exam modes
    const getGenerator = (mode) => {
        if (mode === 'add') return generateBasicAdd;
        if (mode === 'sub') return generateBasicSub;
        if (mode === 'continuous') return generateContinuous;
        if (mode === 'couShi') return generateCouShi;
        if (mode === 'jieShi') return generateJieShi;
        if (mode === 'pingShi') return generatePingShi;
        if (mode === 'noBreakSub') return generateNoBreakSub;
        if (mode === 'noCarryAdd') return generateNoCarryAdd;
        return generateMixed; // Fallback
    };

    function generateProblem(shouldFocus = false) {
        let attempts = 0; let generatedSuccessfully = false;

        const clearDisplay = () => {
            n1El.textContent = ''; op1El.textContent = ''; n2El.textContent = '';
            op2El.textContent = ''; n3El.textContent = ''; equalsSignEl.textContent = '';
            resultDisplayEl.textContent = ''; mathProbDispEl.classList.remove('three-op');
        };
        clearDisplay();

        if (isExamMode) {
            // **æ›´æ–°: è€ƒè¯•æ¨¡å¼ç›´æ¥ä»é¢„ç”Ÿæˆåˆ—è¡¨è·å–é—®é¢˜**
            if (examCurrentQuestion >= EXAM_TOTAL_QUESTIONS) return;
            currentProblem = examProblems[examCurrentQuestion];
            generatedSuccessfully = true;
            submitBtn.disabled = false;
            hintBtn.disabled = true; // è€ƒè¯•ç¦ç”¨æç¤º
            newProbBtn.disabled = true; // è€ƒè¯•ç¦ç”¨æ¢é¢˜
        } else {
            // æ ‡å‡†ç»ƒä¹ æ¨¡å¼çš„ç”Ÿæˆé€»è¾‘ (ä¿æŒä¸å˜)
            if (isExamMode) submitBtn.disabled = false;

            let allowUnknown = !isExamMode && !['exam', 'continuous'].includes(modeSelect.value);
            let generatorMode = isExamMode ? 'mixed' : modeSelect.value;
            // å‡‘åæ³•æ¨¡å¼ä¸‹å¼ºåˆ¶åªç”¨åŠ æ³•ç”Ÿæˆé¢˜ç›®ï¼Œæ°¸ä¸å‡ºç°å‡æ³•ï¼
            // å‡‘åæ³•ï¼š20 ä»¥å†…ï¼Œçº¯æ­£å®—ï¼Œæ°¸ä¸ä¸²é¢˜ï¼ˆè¶…ç®€ç‰ˆ 8 8 è¡Œï¼‰
            // åŒä½ç›¸åŠ æ³•ï¼ˆä¸è¿›ä½ï¼‰æ¨¡å¼ä¸‹ï¼Œåšå†³ä¸å‡ºä»»ä½•å¸¦é—®å·çš„é¢˜ç›®ï¼
            if (generatorMode === 'noCarryAdd') {
                allowUnknown = false;   // â† åŠ ä¸Šè¿™è¡Œ
            }
            if (generatorMode === 'couShi') {
                const pairs = [[9,4],[9,5],[9,6],[9,7],[9,8],[8,3],[8,4],[8,5],[8,6],[8,7],[8,8],[7,4],[7,5],[7,6],[7,7],[7,8],[6,5],[6,6],[6,7],[6,8],[5,6],[5,7],[5,8],[4,7],[4,8]];
                let [a, b] = pairs[Math.floor(Math.random() * pairs.length)];
                if (Math.random() < 0.5) [a, b] = [b, a];           // éšæœºäº¤æ¢é¡ºåº

                currentProblem = { num1: a, num2: b, operator1: '+', answer: a+b, unknownPosition: 'res', specificMode: 'couShi' };
                n1El.textContent = a; op1El.textContent = '+'; n2El.textContent = b;
                equalsSignEl.textContent = '='; resultDisplayEl.textContent = '?';
                ansInput.value = ''; if (shouldFocus) ansInput.focus();
                return;
            }

            if (generatorMode === 'noBreakSub') {                      // åŒä½ç›¸å‡æ³• â†’ åªå‡ºä¸ç ´åå‡æ³•
                let n1, n2;
                do {
                    n1 = rand(11, 19);                     // æ”¹è¿™é‡Œï¼ä¸Šé™æ”¹æˆ19ï¼Œå½»åº•æ’é™¤20
                    const unit1 = n1 % 10;
                    n2 = rand(1, unit1);                   // ä¸ªä½å¿…é¡»å¤Ÿå‡
                    if (n2 === 0) n2 = rand(1, unit1);     // é¿å…å‡ºç° xx âˆ’ 0
                } while (n2 >= n1 || n2 <= 0);

                currentProblem = {num1:n1,num2:n2,operator1:'-',answer:n1-n2,unknownPosition:'res',specificMode:'noBreakSub'};
                n1El.textContent=n1; op1El.textContent='-'; n2El.textContent=n2;
                equalsSignEl.textContent='='; resultDisplayEl.textContent='?';
                ansInput.value=''; if(shouldFocus)ansInput.focus();
                return;
            }


            const generatorFn = getGenerator(generatorMode);
            //const generatorFn = getGenerator(generatorMode);

            try {
                while (!generatedSuccessfully && attempts < MAX_GENERATION_ATTEMPTS) {
                    attempts++;
                    currentProblem = generatorFn(maxNum, allowUnknown);
                    currentProblem.specificMode = generatorMode;

                    if (currentProblem.num3 !== null && currentProblem.num3 !== undefined) {
                        mathProbDispEl.classList.add('three-op');
                    } else {
                        mathProbDispEl.classList.remove('three-op');
                    }

                    if (currentProblem.num1 !== null && currentProblem.num2 !== null && currentProblem.answer !== null && currentProblem.answer >= 0 && (currentProblem.num3 === null || currentProblem.answer <= maxNum)) {
                        generatedSuccessfully = true;
                    } else {
                        throw new Error('Problem properties invalid or out of range');
                    }
                }

                if (!generatedSuccessfully) {
                    throw new Error('Max attempts reached');
                }

            } catch (error) {
                currentProblem = { num1: 15, num2: 8, operator1: '-', num3: null, operator2: null, answer: 7, unknownPosition: 'res', specificMode: generatorMode };
            }
        }


        const { num1, num2, operator1, num3, operator2, answer, unknownPosition, specificMode } = currentProblem;

        // --- Display Logic (Unified and updated for n1) ---
        let n1_display = num1, n2_display = num2, result_display;

        if (num3 !== null && num3 !== undefined) {
            result_display = '?';
        } else if (unknownPosition === 'res') {
            result_display = '?';
        } else {
            const resultC = num1 + (operator1 === '+' ? num2 : -num2);
            result_display = resultC;
            if (unknownPosition === 'n1') {
                n1_display = '?';
            } else if (unknownPosition === 'n2') {
                n2_display = '?';
            }
        }

        n1El.textContent = n1_display; op1El.textContent = operator1; n2El.textContent = n2_display;
        if (num3 !== null && num3 !== undefined) {
            op2El.textContent = operator2; n3El.textContent = num3;
        } else {
            op2El.textContent = ''; n3El.textContent = '';
        }
        equalsSignEl.textContent = '=';
        resultDisplayEl.textContent = result_display;

        ansInput.value = ''; if (shouldFocus) ansInput.focus();

        // **ä¿®æ”¹ç‚¹ï¼šç§»é™¤è€ƒè¯•è¿›åº¦ä¸­çš„é¢˜å‹ä¿¡æ¯**
        if (isExamMode) {
            feedbackEl.textContent = `è€ƒè¯•è¿›åº¦: ç¬¬ ${examCurrentQuestion + 1} / ${EXAM_TOTAL_QUESTIONS} é¢˜`;
        }
        else if (!feedbackEl.textContent.includes('å›ç­”æ­£ç¡®') && !feedbackEl.textContent.includes('é”™äº†')) {
            feedbackEl.textContent = '';
        }
    }

    // --- æç¤ºæ­¥éª¤é€»è¾‘ (ä¿æŒä¸å˜) ---

    // åŸºç¡€è®¡ç®—æ­¥éª¤
    function getBasicSteps(n1, n2, op, res, titleOverride = 'åŸºç¡€åŠ å‡æ³•') {
        const [n1Red, n2Red, resRed] = [numRedSpan(n1), numRedSpan(n2), numRedSpan(res)];
        const t = `${titleOverride} (ç›´æ¥è®¡ç®—)`;
        const s = `<div class="modal-step">${stepContent('æ­¥éª¤ 1: ç›´æ¥è®¡ç®—', `ï¼š${numSpan(n1, 'highlight-remain')} ${opRedSpan(op)} ${numSpan(n2, 'highlight-remain')} ${opRedSpan('=')} ${numSpan(res, 'highlight-goal')} å°±å¯ä»¥å•¦ï¼`)}</div>`;
        const formulaHTML = `<span class="formula">${n1Red} ${opRedSpan(op)} ${n2Red} ${opRedSpan('=')} ${resRed}</span>`;
        return { title: t, stepsHTML: s, formula: formulaHTML };
    }

    // åŒä½ç›¸åŠ æ³• (ä¸è¿›ä½) æ­¥éª¤
    function getNoCarryAddSteps(n1, n2, res) {
        const u1 = n1 % 10, u2 = n2 % 10, t1 = Math.floor(n1 / 10), t2 = Math.floor(n2 / 10);
        const uSum = u1 + u2;
        const tRes = t1 + t2;
        const [t1Span, t2Span] = [numSpan(t1, 'highlight-remain'), numSpan(t2, 'highlight-remain')];
        const [u1Span, u2Span] = [numSpan(u1, 'highlight-ten'), numSpan(u2, 'highlight-ten')];
        const [n1Red, n2Red, resRed] = [numRedSpan(n1), numRedSpan(n2), numRedSpan(res)];

        let t = 'â• åŒä½ç›¸åŠ æ³• (ä¸è¿›ä½)';
        let s = `<div class="modal-step">${stepContent('æ­¥éª¤ 1: ä¸ªä½åŠ ä¸ªä½', `ï¼šğŸ’ª ä¸ªä½ä¸Šçš„ ${u1Span} åŠ ä¸Š ${u2Span}ï¼Œå¾—åˆ° ${numSpan(uSum, 'highlight-goal')}ã€‚`)}</div>`;
        if (t1 > 0 || t2 > 0) {
            s += `<div class="modal-step">${stepContent('æ­¥éª¤ 2: åä½åŠ åä½', `ï¼šğŸ§  åä½ä¸Šçš„ ${t1Span} åŠ ä¸Š ${t2Span}ï¼Œå¾—åˆ° ${numSpan(tRes, 'highlight-goal')}ã€‚`)}</div>`;
        }
        const formulaHTML = `<span class="formula">${n1Red} ${opRedSpan('+')} ${n2Red} ${opRedSpan('=')} ${resRed}</span>`;
        return { title: t, stepsHTML: s, formula: formulaHTML };
    }

    // å‡‘åæ³•æ­¥éª¤
    function getCouShiSteps(n1, n2, res) {
        const big = Math.max(n1, n2); const small = Math.min(n1, n2);
        const bigUnit = big % 10, need = 10 - bigUnit, rem = small - need;
        const [needSpan, remSpan] = [numSpan(need, 'highlight-ten'), numSpan(rem, 'highlight-remain')];
        const [bigSpan, smallSpan] = [numSpan(big, 'highlight-goal'), numSpan(small, 'highlight-ten')];
        const nextTen = big + need, nextTenSpan = numSpan(nextTen, 'highlight-goal');
        const [n1Red, n2Red, resRed] = [numRedSpan(n1), numRedSpan(n2), numRedSpan(res)];

        const t = 'âœ¨ å‡‘åæ³•é­”æ³•æ‹†åˆ†';
        let s = `<div class="modal-step">${stepContent('æ­¥éª¤ 1: æ‰¾æœ‹å‹å‡‘ 10', `ï¼šğŸ™‹ å¤§æ•° ${bigSpan} çš„ä¸ªä½ (${numSpan(bigUnit,'highlight-goal')}) éœ€è¦æ‰¾ ${need} æ‰èƒ½å‡‘åˆ°ä¸‹ä¸€ä¸ªæ•´åæ•° ${nextTenSpan}ã€‚`)}</div>`;
        s += `<div class="modal-step">${stepContent('æ­¥éª¤ 2: å°æ•°æ‹†åˆ†', `ï¼šâœ‚ï¸ å°æ•° ${smallSpan} æ„¿æ„æŠŠè‡ªå·±æ‹†æˆ ${needSpan} (ç»™æœ‹å‹) å’Œ ${remSpan} (å‰©ä¸‹çš„)ã€‚`)}</div>`;
        s += `<div class="modal-step">${stepContent('æ­¥éª¤ 3: é­”æ³•åˆä½“', `ï¼šğŸš€ å…ˆè®© ${nextTenSpan} å˜å‡ºæ¥ï¼Œå†æŠŠå‰©ä¸‹çš„ ${remSpan} åŠ ä¸Šå»ï¼`)}</div>`;
        const formulaHTML = `<span class="formula">${n1Red} ${opRedSpan('+')} ${n2Red} ${opRedSpan('=')} ${parenRedSpan('(')} ${bigSpan} ${opRedSpan('+')} ${needSpan} ${parenRedSpan(')')} ${opRedSpan('+')} ${remSpan} ${opRedSpan('=')} ${nextTenSpan} ${opRedSpan('+')} ${remSpan} ${opRedSpan('=')} ${resRed}</span>`;
        return { title: t, stepsHTML: s, formula: formulaHTML };
    }

    // åŒä½ç›¸å‡æ³• (ä¸ç ´å) æ­¥éª¤
    function getNoBreakSubSteps(n1, n2, res) {
        const u1 = n1 % 10, u2 = n2 % 10;
        const t1 = Math.floor(n1 / 10), t2 = Math.floor(n2 / 10);
        const tRes = t1 - t2; const uRes = u1 - u2;
        const [t1Span, t2Span] = [numSpan(t1, 'highlight-remain'), numSpan(t2, 'highlight-remain')];
        const [u1Span, u2Span] = [numSpan(u1, 'highlight-ten'), numSpan(u2, 'highlight-ten')];
        const [n1Red, n2Red, resRed] = [numRedSpan(n1), numRedSpan(n2), numRedSpan(res)];

        let t = 'âœ… åŒä½ç›¸å‡æ³• (ä¸ç ´å)';
        let s = `<div class="modal-step">${stepContent('æ­¥éª¤ 1: ä¸ªä½å‡ä¸ªä½', `ï¼šğŸ’ª ä¸ªä½ä¸Šçš„ ${u1Span} å‡å» ${u2Span}ï¼Œå¾—åˆ° ${numSpan(uRes, 'highlight-goal')}ã€‚`)}</div>`;
        if (t2 > 0) {
            s += `<div class="modal-step">${stepContent('æ­¥éª¤ 2: åä½å‡åä½', `ï¼šğŸ§  åä½ä¸Šçš„ ${t1Span} å‡å» ${t2Span}ï¼Œå¾—åˆ° ${numSpan(tRes, 'highlight-goal')}ã€‚`)}</div>`;
        } else if (t1 > 0 && t2 === 0) {
            s += `<div class="modal-step">${stepContent('æ­¥éª¤ 2: ä¿ç•™åä½', `ï¼šğŸ§  å‡æ•°æ²¡æœ‰åä½ï¼Œä¿ç•™ ${t1Span} (1ä¸ªå)ã€‚`)}</div>`;
        }
        const formulaHTML = `<span class="formula">${n1Red} ${opRedSpan('-')} ${n2Red} ${opRedSpan('=')} ${resRed}</span>`;
        return { title: t, stepsHTML: s, formula: formulaHTML };
    }

    // å€Ÿåæ³• (ç ´åæ³•, 20ä»¥å†…) æ­¥éª¤
    function getJieShiSteps(n1, n2, res) {
        const u1 = n1 % 10;
        const tMinusN2 = 10 - n2;
        const [u1Span, tMinusN2Span] = [numSpan(u1, 'highlight-remain'), numSpan(tMinusN2, 'highlight-goal')];
        const tSpan = numSpan(10, 'highlight-goal');
        const [n1Red, n2Red, resRed] = [numRedSpan(n1), numRedSpan(n2), numRedSpan(res)];

        let t = 'âš¡ å€Ÿåæ³• (ç ´åæ³•)';
        let s = `<div class="modal-step">${stepContent('æ­¥éª¤ 1: ä¸ªä½æ±‚åŠ©', `ï¼šğŸ˜Ÿ ${n1} çš„ä¸ªä½ (${u1Span}) å¤ªå°äº†ï¼Œå‡ä¸æ‰ ${n2Red}ï¼å€Ÿä¸€ä¸ª ${tSpan} æ¥å¸®å¿™ï¼`)}</div>`;
        s += `<div class="modal-step">${stepContent('æ­¥éª¤ 2: 10 å‡å»å‡æ•°', `ï¼šğŸ’ª å…ˆè®©å€Ÿæ¥çš„ ${tSpan} æ‰“è´¥ é‚£ä¸ª ${n2Red}ï¼Œå‰©ä¸‹ ${tMinusN2Span} ä¸ªã€‚`)}</div>`;
        s += `<div class="modal-step">${stepContent('æ­¥éª¤ 3: èƒœåˆ©ä¼šå¸ˆ', `ï¼šğŸ¥³ æŠŠ ${tMinusN2Span} å’Œä¸ªä½ä¸Šä¹–ä¹–ç­‰ç€çš„ ${u1Span} åˆå¹¶èµ·æ¥ï¼`)}</div>`;
        const formulaHTML = `<span class="formula">${n1Red} ${opRedSpan('-')} ${n2Red} ${opRedSpan('=')} ${parenRedSpan('(')} ${tSpan} ${opRedSpan('-')} ${n2Red} ${parenRedSpan(')')} ${opRedSpan('+')} ${u1Span} ${opRedSpan('=')} ${tMinusN2Span} ${opRedSpan('+')} ${u1Span} ${opRedSpan('=')} ${resRed}</span>`;
        return { title: t, stepsHTML: s, formula: formulaHTML };
    }

    // å¹³åæ³• (è¿å‡æ³•, 20ä»¥ä¸Šç ´å) æ­¥éª¤
    function getPingShiSteps(n1, n2, res) {
        const u1 = n1 % 10;
        const rem = n2 - u1;
        const tenRem = n1 - u1;
        const [n1Red, n2Red, resRed] = [numRedSpan(n1), numRedSpan(n2), numRedSpan(res)];
        const [remSpan, tenRemSpan] = [numSpan(rem, 'highlight-remain'), numSpan(tenRem, 'highlight-goal')];
        const u1Span = numSpan(u1, 'highlight-ten');

        let t = 'ğŸ“ å¹³åæ³• (è¿å‡æ³•)';
        let s = `<div class="modal-step">${stepContent('æ­¥éª¤ 1: æ‹†åˆ†å‡æ•°', `ï¼šâœ‚ï¸ æŠŠ ${n2Red} æ‹†æˆ ${u1Span} (å’Œ ${n1} çš„ä¸ªä½ç›¸ç­‰) å’Œ ${remSpan} (å‰©ä¸‹çš„)ã€‚`)}</div>`;
        s += `<div class="modal-step">${stepContent('æ­¥éª¤ 2: å…ˆå‡ä¸ªä½', `ï¼šğŸ’ª ${n1Red} å…ˆå‡å» ${u1Span}ï¼Œå¾—åˆ°æ•´åæ•° ${tenRemSpan}ã€‚`)}</div>`;
        s += `<div class="modal-step">${stepContent('æ­¥éª¤ 3: å†å‡å‰©ä½™', `ï¼šğŸƒ ç”¨ ${tenRemSpan} å†å‡å»å‰©ä¸‹çš„ ${remSpan}ã€‚`)}</div>`;
        const formulaHTML = `<span class="formula">${n1Red} ${opRedSpan('-')} ${n2Red} ${opRedSpan('=')} ${parenRedSpan('(')} ${n1Red} ${opRedSpan('-')} ${u1Span} ${parenRedSpan(')')} ${opRedSpan('-')} ${remSpan} ${opRedSpan('=')} ${tenRemSpan} ${opRedSpan('-')} ${remSpan} ${opRedSpan('=')} ${resRed}</span>`;
        return { title: t, stepsHTML: s, formula: formulaHTML };
    }

    // Function to determine the best subtraction method for a hint
    function getSubtractionMethod(n1, n2) {
        const res = n1 - n2;
        const u1 = n1 % 10, u2 = n2 % 10;
        const isBreakTen = n1 > 10 && u2 > u1;
        const isNoBreakSub = n1 > 10 && u2 <= u1;
        const isSimpleSub = n1 <= 10 || (n1 > 10 && (n2 % 10 === 0 || res % 10 === 0));

        if (isSimpleSub) return { mode: 'basic', func: (a, b, r) => getBasicSteps(a, b, '-', r, 'åŸºç¡€å‡æ³•') };
        if (isNoBreakSub) return { mode: 'noBreakSub', func: getNoBreakSubSteps };
        // ç”±äº maxNum=20, è¿™é‡Œåªå¯èƒ½æ˜¯ JieShi
        if (isBreakTen && n1 <= 20) return { mode: 'jieShi', func: getJieShiSteps };
        if (isBreakTen) return { mode: 'pingShi', func: getPingShiSteps };

        return { mode: 'basic', func: (a, b, r) => getBasicSteps(a, b, '-', r, 'åŸºç¡€å‡æ³•') };
    }

    // æç¤ºé€»è¾‘æ€»è°ƒåº¦

    // æç¤ºé€»è¾‘æ€»è°ƒåº¦ â€”â€” å®Œæ•´ä¿®å¤ç‰ˆï¼ˆ2025æœ€æ–°ç‰ˆ
    function getSingleOpHintSteps(n1, n2, op, forcedMode = null, unknownPos = 'res') {
        const res = op === '+' ? n1 + n2 : n1 - n2;
        const effectiveMode = forcedMode || currentProblem.specificMode;

        let t = '', s = '', formulaHTML = '';
        let calculationDetails = {};

        // --- 1. æ±‚è§£æœªçŸ¥æ•°çš„æƒ…å†µï¼š? op B = C  æˆ–  A op ? = C  (å…³ç³»è½¬æ¢) ---
        if (unknownPos !== 'res') {
            const n1Known = unknownPos === 'n2' ? n1 : n2;           // å·²çŸ¥çš„é‚£ä¸€ä¸ªè¿ç®—æ•°
            const n2Answer = unknownPos === 'n2' ? n2 : n1;           // è¦æ±‚è§£çš„æœªçŸ¥æ•°
            const knownResult = n1Known + (op === '+' ? n2Answer : -n2Answer);

            let subN1, subN2, conversionText, conversionOp = '-';

            if (op === '-') {
                if (unknownPos === 'n1') { // ? âˆ’ B = C  â†’  ? = C + Bï¼ˆåŠ æ³•ï¼‰
                    subN1 = knownResult; subN2 = n1Known; conversionOp = '+';
                    t = 'æ±‚è§£æœªçŸ¥è¢«å‡æ•° (? = C + B)';
                    conversionText = `ï¼šæœªçŸ¥æ•° (?) å‡å» ${numRedSpan(n1Known)} ç­‰äº ${numRedSpan(knownResult)}ï¼Œæ‰€ä»¥æœªçŸ¥æ•° (?) ç­‰äº ${numRedSpan(knownResult)} **åŠ ä¸Š** ${numRedSpan(n1Known)}ã€‚`;

                    // åŠ æ³•èµ°å‡‘åæ³•/åŒä½ç›¸åŠ ï¼ˆä¿æŒåŸæ¥æœ€ä¼˜é€»è¾‘ï¼‰
                    const u1 = subN1 % 10, u2 = subN2 % 10;
                    const isCouShi = u1 + u2 > 9;
                    calculationDetails = isCouShi ? getCouShiSteps(subN1, subN2, subN1 + subN2)
                        : getNoCarryAddSteps(subN1, subN2, subN1 + subN2);

                } else { // A âˆ’ ? = C  â†’  ? = A âˆ’ Cï¼ˆå‡æ³•ï¼‰
                    subN1 = n1; subN2 = knownResult;
                    t = 'æ±‚è§£æœªçŸ¥å‡æ•° (? = A âˆ’ C)';
                    conversionText = `ï¼š${numRedSpan(n1)} å‡å»æœªçŸ¥æ•° (?) ç­‰äº ${numRedSpan(knownResult)}ï¼Œæ‰€ä»¥æœªçŸ¥æ•° (?) ç­‰äº ${numRedSpan(n1)} **å‡å»** ${numRedSpan(knownResult)}ã€‚`;

                    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å…³é”®ä¿®å¤ï¼šå¼ºåˆ¶ä½¿ç”¨å½“å‰é€‰æ‹©çš„æ¨¡å¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                    if (currentMode === 'pingShi') {
                        calculationDetails = getPingShiSteps(subN1, subN2, subN1 - subN2);
                    } else if (currentMode === 'jieShi') {
                        calculationDetails = getJieShiSteps(subN1, subN2, subN1 - subN2);
                    } else {
                        // å…¶ä»–æ¨¡å¼ï¼ˆæ··åˆã€è€ƒè¯•ç­‰ï¼‰ä¿æŒåŸæ¥æ™ºèƒ½åˆ¤æ–­
                        const { func: subFunc } = getSubtractionMethod(subN1, subN2);
                        calculationDetails = subFunc(subN1, subN2, subN1 - subN2);
                    }
                    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ä¿®å¤ç»“æŸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                }
            } else if (op === '+') {
                // A + ? = C æˆ– ? + B = C  â†’  éƒ½å˜æˆå‡æ³•
                subN1 = knownResult; subN2 = n1Known;
                t = 'æ±‚è§£æœªçŸ¥åŠ æ•°';
                conversionText = `ï¼šå·²çŸ¥å’Œæ˜¯ ${numRedSpan(knownResult)}ï¼Œå…¶ä¸­ä¸€ä¸ªåŠ æ•°æ˜¯ ${numRedSpan(n1Known)}ï¼Œæ‰€ä»¥æœªçŸ¥åŠ æ•°ç­‰äº ${numRedSpan(knownResult)} **å‡å»** ${numRedSpan(n1Known)}ã€‚`;

                if (currentMode === 'pingShi') {
                    calculationDetails = getPingShiSteps(subN1, subN2, subN1 - subN2);
                } else if (currentMode === 'jieShi') {
                    calculationDetails = getJieShiSteps(subN1, subN2, subN1 - subN2);
                } else {
                    const { func: subFunc } = getSubtractionMethod(subN1, subN2);
                    calculationDetails = subFunc(subN1, subN2, subN1 - subN2);
                }
            }

            const calculationTitle = calculationDetails.title.replace(/[\u2728\u2559\u26a1\u25b6\u2796\s\u2705]/g, '').trim();

            // æ­¥éª¤ 1ï¼šå…³ç³»è½¬æ¢
            s = `<div class="modal-step">${stepContent('æ­¥éª¤ 1: å…³ç³»è½¬æ¢', conversionText.replace(/ï¼šğŸ”|ï¼š/g, ''))}</div>`;

            // è½¬æ¢å…¬å¼ï¼ˆæ©™è‰²èƒŒæ™¯ï¼‰
            const conversionFormula = `<span class="formula conversion-formula fade-start">
            ${numRedSpan(unknownPos === 'n1' ? '?' : n1)} ${opRedSpan(op)}
            ${numRedSpan(unknownPos === 'n2' ? '?' : n2)} ${opRedSpan('=')} ${knownResult}
            ${opRedSpan('â†’')} ${numRedSpan('?')} ${opRedSpan('=')} ${numRedSpan(subN1)}
            ${opRedSpan(conversionOp)} ${numRedSpan(subN2)}
        </span>`;
            s += conversionFormula;

            // è®©åé¢æ­¥éª¤ä»â€œæ­¥éª¤ 2â€å¼€å§‹ç¼–å·
            let calcStepsHtml = calculationDetails.stepsHTML;
            let stepNum = 2;
            calcStepsHtml = calcStepsHtml.replace(/<strong>æ­¥éª¤ \d+:/g, () => `<strong>æ­¥éª¤ ${stepNum++}:`);
            s += calcStepsHtml;

            t += ` (è®¡ç®—ä½¿ç”¨ï¼š${calculationTitle})`;
            formulaHTML = calculationDetails.formula;

            return { title: t, stepsHTML: s, formula: formulaHTML };
        }

        // --- 2. æ™®é€šé¢˜ç›® A Â± B = ? ï¼ˆæ— å…³ç³»è½¬æ¢ï¼‰---
        if (op === '+') {
            const u1 = n1 % 10, u2 = n2 % 10;
            const isCouShi = u1 + u2 > 9;
            if (currentMode === 'couShi' || effectiveMode === 'couShi') return getCouShiSteps(n1, n2, res);
            return getNoCarryAddSteps(n1, n2, res);
        }
        else if (op === '-') {  // å‡æ³•
            const u1 = n1 % 10, u2 = n2 % 10;
            const isBreakTen = n1 > 10 && u2 > u1;

            // å½“å‰é€‰æ‹©çš„ä¸“é¡¹æ¨¡å¼æ°¸è¿œä¼˜å…ˆï¼
            if (currentMode === 'pingShi') return getPingShiSteps(n1, n2, res);
            if (currentMode === 'jieShi') return getJieShiSteps(n1, n2, res);
            if (currentMode === 'noBreakSub') return getNoBreakSubSteps(n1, n2, res);

            // å…œåº•ï¼ˆæ··åˆæ¨¡å¼ã€è€ƒè¯•ç­‰ï¼‰
            if (isBreakTen && n1 <= 20) return getJieShiSteps(n1, n2, res);
            if (isBreakTen) return getPingShiSteps(n1, n2, res);
            return getNoBreakSubSteps(n1, n2, res);
        }

        return getBasicSteps(n1, n2, op, res);
    }

    // --- æ¨¡æ€æ¡†å’ŒæŠ¥å‘Šé€»è¾‘ (è°ƒæ•´è°ƒç”¨å‚æ•°) ---
    function generateHintSteps(problem, problemIndex = null) {
        const { num1, num2, operator1, num3, operator2, answer, unknownPosition, specificMode } = problem;
        let s = '', finalFormula = '';
        hintModal.style.display = 'block';
        hintVisuals.innerHTML = '';

        // --- 1. æ ¸å¿ƒç”»å›¾é€»è¾‘ (ä¿æŒä¸å˜) ---
        if (num3 !== null && num3 !== undefined) {
            renderVisualHelpers(hintVisuals, num1, num2, operator1);
        } else if (unknownPosition === 'n1' || unknownPosition === 'n2') {
            const n1Known = unknownPosition === 'n2' ? num1 : num2;
            const n2Answer = unknownPosition === 'n2' ? num2 : num1;
            const knownResult = n1Known + (operator1 === '+' ? n2Answer : -n2Answer);

            let subN1, subN2, visOp;

            if (operator1 === '-') {
                if (unknownPosition === 'n1') { subN1 = knownResult; subN2 = n1Known; visOp = '+'; }
                else { subN1 = num1; subN2 = knownResult; visOp = '-'; }
            } else if (operator1 === '+') {
                subN1 = knownResult; subN2 = n1Known; visOp = '-';
            }
            renderVisualHelpers(hintVisuals, subN1, subN2, visOp);
        } else {
            renderVisualHelpers(hintVisuals, num1, num2, operator1);
        }
        // --- ç»“æŸï¼šæ ¸å¿ƒç”»å›¾é€»è¾‘ ---


        // --- 2. æ­¥éª¤å’Œå…¬å¼ç”Ÿæˆ (æ›´æ–°ï¼šå¤„ç†è¿ç»­è¿ç®—) ---
        if (num3 !== null && num3 !== undefined) {
            const iR = operator1 === '+' ? num1 + num2 : num1 - num2;
            const firstStepDetails = getSingleOpHintSteps(num1, num2, operator1, null, 'res');
            hintModalTitle.textContent = `ğŸ’¡ ç¬¬${problemIndex !== null ? problemIndex + 1 : 'å½“å‰'}é¢˜ - è¿ç»­è¿ç®—åˆ†æ­¥è§£æ (ç¬¬ä¸€æ­¥ï¼š${firstStepDetails.title.replace(/[\u2728\u2559\u26a1]/g, '').trim()})`;
            s += `<div class="modal-step" style="border-left: 4px solid var(--color-apple-orange);">${stepContent('ç¬¬ä¸€æ­¥è®¡ç®—', `ï¼š${num1} ${operator1} ${num2}`)}</div>`;
            s += firstStepDetails.stepsHTML;
            s += `<span class="formula">${numRedSpan(num1)} ${opRedSpan(operator1)} ${numRedSpan(num2)} ${opRedSpan('=')} ${numRedSpan(iR)}</span>`;
            const secondStepDetails = getSingleOpHintSteps(iR, num3, operator2, null, 'res');
            s += `<div class="modal-step">${stepContent('ç¬¬äºŒæ­¥è®¡ç®—', `ï¼š${iR} ${operator2} ${num3} (æ–¹æ³•ï¼š${secondStepDetails.title.replace(/[\u2728\u2559\u26a1]/g, '').trim()})`)}</div>`;
            s += secondStepDetails.stepsHTML;
            finalFormula = `<span class="formula">${numRedSpan(num1)} ${opRedSpan(operator1)} ${numRedSpan(num2)} ${opRedSpan(operator2)} ${numRedSpan(num3)} ${opRedSpan('=')} ${numRedSpan(answer)}</span>`;
        } else {
            // æ ‡å‡†æˆ–æœªçŸ¥æ•°é—®é¢˜
            const originalProblem = currentProblem;
            currentProblem = problem;
            const details = getSingleOpHintSteps(num1, num2, operator1, specificMode, unknownPosition);
            currentProblem = originalProblem;
            hintModalTitle.textContent = `ğŸ’¡ ${problemIndex !== null ? 'ç¬¬' + (problemIndex + 1) + 'é¢˜ - ' : ''}${details.title}`;
            s = details.stepsHTML;
            finalFormula = details.formula;
        }

        // --- 3. åŠ¨ç”»é€»è¾‘ (æ›´æ–°ï¼Œå®ç°å…¬å¼åˆ†æ­¥æ·¡å…¥) ---
        // å°†æœ€ç»ˆè®¡ç®—å…¬å¼å†…å®¹åŒ…è£¹åœ¨å¸¦ 'fade-start' ç±»çš„ span ä¸­ï¼Œå¹¶æ·»åŠ åˆ° steps HTML ä¹‹å
        hintModalSteps.innerHTML = s + `<span id="finalFormulaWrapper" class="formula fade-start">${finalFormula.replace(/<span class="formula">/g, '').replace(/<\/span>/g, '')}</span>`;

        // ã€æ–°é€‰æ‹©å™¨ã€‘é€‰æ‹©æ‰€æœ‰éœ€è¦æŒ‰é¡ºåºæ·¡å…¥çš„å…ƒç´ ï¼šmodal-step å’Œ conversion-formula (å¦‚æœå­˜åœ¨)
        const allItems = Array.from(hintModalSteps.querySelectorAll('.modal-step, .conversion-formula'));
        const calculationFormulaWrapper = getElementByIdSafe('finalFormulaWrapper');

        // åˆå§‹åŒ–æ‰€æœ‰ item çš„åŠ¨ç”»çŠ¶æ€ï¼ˆå…¬å¼éœ€è¦é¢å¤–è®¾ç½® opacity å’Œ transformï¼‰
        allItems.forEach(item => {
            item.classList.add('fade-start');
            if (item.classList.contains('formula')) {
                item.style.opacity = 0;
                item.style.transform = 'translateY(10px)';
            }
        });

        // åŠ¨ç”»é¡ºåºæ’­æ”¾
        let totalDelay = 0;
        const delay = 450;

        allItems.forEach((item, index) => {
            totalDelay += delay;
            setTimeout(() => {
                item.classList.remove('fade-start');
                item.classList.add('fade-end');
                item.style.opacity = 1;
                item.style.transform = 'translateY(0)';
            }, 100 + index * delay);
        });

        // æœ€ç»ˆè®¡ç®—å…¬å¼æ·¡å…¥
        setTimeout(() => {
            calculationFormulaWrapper.classList.remove('fade-start');
            calculationFormulaWrapper.style.opacity = 1;
            calculationFormulaWrapper.style.transform = 'translateY(0)';
        }, 100 + allItems.length * delay + 200); // é¢å¤–çš„ 200ms å»¶è¿Ÿç¡®ä¿æœ€åä¸€æ­¥å®Œæˆ
    }

    // --- æ¨¡æ€æ¡†å’ŒæŠ¥å‘Šé€»è¾‘ (ä¿æŒä¸å˜) ---
    const closeHintModal = () => { hintModal.style.display = 'none'; };
    const closeExamModal = () => { examModal.style.display = 'none'; switchMode(modeSelect.value); };
    const showCurrentHint = () => {
        if (isExamMode) { feedbackEl.textContent = 'è€ƒè¯•ä¸­ä¸èƒ½ä½¿ç”¨æç¤ºå“¦ï¼'; wrongFlash(); return; }
        generateHintSteps(currentProblem);
    };
    const showProblemHint = (index) => {
        const problemData = examProblems[index];
        currentProblem = problemData;
        if (problemData) generateHintSteps(problemData, index);
    };

    function generateReportImage() {
        const reportEl = document.getElementById('examReportContent');
        if (typeof html2canvas === 'undefined') {
            alert('å›¾ç‰‡ç”Ÿæˆåº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            return;
        }

        // éšè—æŒ‰é’®ï¼Œé¿å…å‡ºç°åœ¨å›¾ç‰‡é‡Œ
        const actionsDiv = reportEl.querySelector('.report-actions');
        actionsDiv.classList.add('hide-for-capture');

        html2canvas(reportEl, {
            scale: window.devicePixelRatio || 2,  // è¶…é«˜æ¸…ï¼Œæ‰‹æœºæˆªå›¾çº§æ¸…æ™°
            useCORS: true,
            backgroundColor: '#ffffff',
            logging: false
        }).then(canvas => {
            actionsDiv.classList.remove('hide-for-capture');

            // ç”Ÿæˆå›¾ç‰‡
            canvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const score = (examCorrectAnswers / EXAM_TOTAL_QUESTIONS * 100).toFixed(0);
                const today = new Date().toLocaleDateString('zh-CN').replace(/\//g, '');
                const filename = `åˆ˜ä¹¦è¯­æ•°å­¦æˆç»©_${score}åˆ†_${today}.png`;

                // ---------- æ‰‹æœºç«¯å®Œç¾æ”¯æŒ ----------
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([blob], filename, {type: 'image/png'})] })) {
                    // æ”¯æŒå¾®ä¿¡ã€QQã€ä¿å­˜åˆ°ç›¸å†Œï¼ˆiOS/Android éƒ½è¡Œï¼‰
                    const file = new File([blob], filename, { type: 'image/png' });
                    navigator.share({
                        title: 'åˆ˜ä¹¦è¯­çš„æ•°å­¦æˆç»©å•',
                        text: `ä»Šå¤©è€ƒäº† ${score} åˆ†ï¼å¿«æ¥å¤¸å¤¸æˆ‘`,
                        files: [file]
                    }).catch(() => {
                        // å¦‚æœç”¨æˆ·å–æ¶ˆåˆ†äº«ï¼Œå°±èµ°ä¸‹è½½
                        downloadImage(url, filename);
                    });
                }
                // iOS Safari / éƒ¨åˆ†å®‰å“æµè§ˆå™¨ï¼šç›´æ¥ä¸‹è½½
                else if (navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) {
                    // iOS é•¿æŒ‰ä¿å­˜æœ€æ–¹ä¾¿
                    const img = document.createElement('img');
                    img.src = url;
                    img.style.cssText = 'max-width:100%; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.3);';
                    const tip = document.createElement('div');
                    tip.innerHTML = `<p style="font-size:18px; color:#d97706; margin:20px 0;">
                    é•¿æŒ‰å›¾ç‰‡ â†’ã€Œå­˜å‚¨å›¾åƒã€å³å¯ä¿å­˜åˆ°ç›¸å†Œ<br>
                    æˆ–è€…ç‚¹å³ä¸Šè§’ã€ŒÂ·Â·Â· â†’ åˆ†äº«åˆ°å¾®ä¿¡
                </p>`;
                    const container = document.createElement('div');
                    container.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px;';
                    container.appendChild(tip);
                    container.appendChild(img);
                    container.onclick = () => document.body.removeChild(container);
                    document.body.appendChild(container);
                }
                // æ™®é€šä¸‹è½½ï¼ˆç”µè„‘ + éƒ¨åˆ†å®‰å“ï¼‰
                else {
                    downloadImage(url, filename);
                }
            }, 'image/png');
        });
    }

    // æ™®é€šä¸‹è½½å‡½æ•°ï¼ˆå…œåº•ï¼‰
    function downloadImage(dataUrl, filename) {
        const a = document.createElement('a');
        a.href = dataUrl;
        a.download = filename;
        a.click();
    }

    function endExam() {
        submitBtn.disabled = true;
        isSubmitting = false;
        const score = (examCorrectAnswers / EXAM_TOTAL_QUESTIONS) * 100;
        const today = new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
        examModalTitle.textContent = 'ğŸ’¯ æ•°å­¦å¿«é€Ÿæµ‹è¯•å·';
        let problemListHTML = examProblems.map((p, index) => {
            const correctAnswerDisplay = (p.answer === undefined || p.answer === null || isNaN(p.answer)) ? '??' : p.answer;
            let problemText = '';
            let resultC;

            if (p.num3 !== null && p.num3 !== undefined) {
                problemText = `${index + 1}. ${p.num1} ${p.operator1} ${p.num2} ${p.operator2} ${p.num3}`;
            } else if (p.unknownPosition === 'res') {
                problemText = `${index + 1}. ${p.num1} ${p.operator1} ${p.num2}`;
            } else {
                resultC = p.num1 + (p.operator1 === '+' ? p.answer : -p.answer);
                if (p.unknownPosition === 'n1') {
                    problemText = `${index + 1}. ? ${p.operator1} ${p.num2} = ${resultC}`;
                } else if (p.unknownPosition === 'n2') {
                    problemText = `${index + 1}. ${p.num1} ${p.operator1} ? = ${resultC}`;
                }
            }
            const isCorrect = p.userAnswer === p.answer;
            // ä¿®æ”¹åçš„ä»£ç 
            const [mark, markClass] = isCorrect ? ['âœ“', 'mark-correct-red'] : ['âœ—', 'mark-wrong']; // å°†ç²—ä½“çš„ 'âŒ' æ›¿æ¢ä¸ºç»†çº¿æ¡çš„ 'âœ—'
            const userAnswerDisplay = p.userAnswer === undefined || p.userAnswer === null || isNaN(p.userAnswer) ? '?' : p.userAnswer;
            const userAnswerColor = isCorrect ? 'var(--color-text-dark)' : 'var(--color-apple-red)';
            return `
                    <li class="problem-item">
                        <span class="problem-text">${problemText}</span>
                        <span class="user-answer-display" style="color: ${userAnswerColor};">${userAnswerDisplay}</span>
                        <span class="correct-answer-display">${!isCorrect ? `(æ­£: ${correctAnswerDisplay})<button onclick="showProblemHint(${index});" class="btn-hint-review">ğŸ’¡</button>` : ''}</span>
                        <div class="problem-mark-group">
                            <span class="problem-mark ${isCorrect ? 'mark-correct-red' : 'mark-wrong'}">${mark}</span>
                        </div>
                    </li>`;
        }).join('');
        examReportContent.innerHTML = `
                <div class="exam-report-inner">
                    <div class="score-box">${score.toFixed(0)}</div>
                    <div class="report-header"><h3>å°å­¦ä¸€å¹´çº§æ•°å­¦æµ‹è¯•</h3></div>
                    <div class="info-row"><div class="info-item">å§“åï¼š<span>åˆ˜ä¹¦è¯­</span></div><div class="info-item">ç­çº§ï¼š<span>ä¸€(1)ç­</span></div></div>
                    <h4 style="border-left: 5px solid var(--color-apple-blue); padding-left: 10px; margin-top: 20px;">ä¸€ã€è®¡ç®—é¢˜ (${EXAM_TOTAL_QUESTIONS} é¢˜)</h4>
                    <div class="problem-item" style="font-weight: 700; border-bottom: 2px solid #ddd; padding-bottom: 5px; background-color: var(--color-card-bg);">
                        <span class="problem-text" style="font-weight: 700;">é¢˜ç›®</span><span class="user-answer-display" style="color: var(--color-text-dark); font-weight: 700;">ä½ çš„ç­”æ¡ˆ</span><span class="correct-answer-display" style="color: var(--color-text-dark); font-weight: 700;">æ­£è§£</span><span class="problem-mark-group" style="justify-content: center; font-weight: 700;">å¯¹é”™</span>
                    </div>
                    <ul class="problem-list">${problemListHTML}</ul>
                    <div class="report-actions">
                        <button onclick="generateReportImage();" class="btn-download">ğŸ“¸ ç”Ÿæˆæˆç»©å•å›¾ç‰‡</button>
                        <button onclick="examModal.style.display='none'; switchMode('exam');" class="btn-primary">å†è€ƒä¸€æ¬¡ (10é¢˜)</button>
                        <button onclick="examModal.style.display='none'; switchMode('mixed');" class="btn-secondary">è¿”å›ç»ƒä¹ æ¨¡å¼</button>
                    </div>
                </div>`;
        examModal.style.display = 'block';
        newProbBtn.disabled = false; hintBtn.disabled = false;
        feedbackEl.textContent = `è€ƒè¯•ç»“æŸï¼Œå¾—åˆ† ${score.toFixed(0)} åˆ†`; feedbackEl.className = 'feedback-correct';
    }

    // --- ç­”æ¡ˆæ£€æŸ¥å’Œé—®é¢˜ç”Ÿæˆ ---
    const checkAnswer = () => {
        if (isSubmitting || (isExamMode && examCurrentQuestion >= EXAM_TOTAL_QUESTIONS)) { return; }
        const uA = parseInt(ansInput.value.trim());
        const eA = currentProblem.answer;
        if (isNaN(uA)) { feedbackEl.textContent = 'è¯·å…ˆè¾“å…¥æ•°å­—ç­”æ¡ˆï¼'; wrongFlash(); return; }
        ansInput.classList.remove('wrong-flash');
        isSubmitting = true; submitBtn.disabled = true;
        const problemSnapshot = { ...currentProblem, userAnswer: uA };

        if (isExamMode) {
            const isC = uA === eA;
            if (isC) examCorrectAnswers++;
            // ã€å·²ä¿®å¤ BUGã€‘ä¸å†ä½¿ç”¨ push() å¯¼è‡´æ•°ç»„å†…å®¹ç¿»å€ï¼Œè€Œæ˜¯æ›¿æ¢å½“å‰ç´¢å¼•ä½ç½®çš„å¯¹è±¡
            examProblems[examCurrentQuestion] = problemSnapshot;
            examCurrentQuestion++;
            setTimeout(() => {
                if (examCurrentQuestion < EXAM_TOTAL_QUESTIONS) { generateProblem(true); isSubmitting = false; submitBtn.disabled = false; }
                else { endExam(); }
            }, 500);
        } else {
            totalCount++;
            if (uA === eA) {
                correctCount++; feedbackEl.textContent = 'âœ… å¤ªæ£’äº†ï¼å›ç­”æ­£ç¡®ï¼ ğŸ‰'; feedbackEl.className = 'feedback-correct';
                vfx();
                setTimeout(() => { submitBtn.disabled = false; generateProblem(true); isSubmitting = false; }, 2000);
            } else {
                wrongCount++; feedbackEl.textContent = `âŒ é”™äº†ï¼Œæ­£ç¡®ç­”æ¡ˆæ˜¯ ${eA} âŒ`; feedbackEl.className = 'feedback-wrong'; wrongFlash();
                isSubmitting = false; submitBtn.disabled = false;
            }
            cCntEl.textContent = correctCount; wCntEl.textContent = wrongCount; tCntEl.textContent = totalCount;
        }
    };

    const skipProblem = () => { feedbackEl.textContent = ''; feedbackEl.className = ''; generateProblem(false); }

    function setButtonMode() {
        const isMobile = window.matchMedia("(max-width: 600px)").matches;
        const btnTxt = newProbBtn.querySelector('.button-text');
        if (btnTxt) { newProbBtn.classList.toggle('icon-mode', !isMobile); btnTxt.style.display = isMobile ? 'inline-block' : 'none'; }
    }

    // --- ç»‘å®šäº‹ä»¶ç›‘å¬å™¨ (ä¿æŒä¸å˜) ---
    submitBtn.addEventListener('click', checkAnswer); hintBtn.addEventListener('click', showCurrentHint);
    newProbBtn.addEventListener('click', skipProblem);
    modeSelect.addEventListener('change', () => switchMode(modeSelect.value));
    hintModalClose.addEventListener('click', closeHintModal);
    examModalClose.addEventListener('click', closeExamModal);
    window.addEventListener('click', (e) => { if (e.target === hintModal) closeHintModal(); if (e.target === examModal) closeExamModal(); });
    ansInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); checkAnswer(); } });
    window.addEventListener('resize', setButtonMode);
    let lastTouchEnd = 0;
    document.addEventListener('touchend', (e) => {
        const now = (new Date()).getTime(); if (now - lastTouchEnd <= 300) e.preventDefault(); lastTouchEnd = now;
    }, { passive: false });

    setButtonMode();
    switchMode(modeSelect.value || 'jieShi');
</script>
</body>
</html>
